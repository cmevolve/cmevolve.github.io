<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="我从不相信什么懒洋洋的自由，我向往的自由是通过勤奋和努力实现更广阔的人生，那样的自由才是珍贵的、有价值的。我相信一万小时定律，我从来不相信天上掉馅饼的灵感和坐等的成就。做一个自由又自律的人，靠势必实现的决心认真地活着。">
<meta property="og:type" content="website">
<meta property="og:title" content="邪恶小代码">
<meta property="og:url" content="http://iamlfc.top/index.html">
<meta property="og:site_name" content="邪恶小代码">
<meta property="og:description" content="我从不相信什么懒洋洋的自由，我向往的自由是通过勤奋和努力实现更广阔的人生，那样的自由才是珍贵的、有价值的。我相信一万小时定律，我从来不相信天上掉馅饼的灵感和坐等的成就。做一个自由又自律的人，靠势必实现的决心认真地活着。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="邪恶小代码">
<meta name="twitter:description" content="我从不相信什么懒洋洋的自由，我向往的自由是通过勤奋和努力实现更广阔的人生，那样的自由才是珍贵的、有价值的。我相信一万小时定律，我从来不相信天上掉馅饼的灵感和坐等的成就。做一个自由又自律的人，靠势必实现的决心认真地活着。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://iamlfc.top/">





  <title>邪恶小代码</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">邪恶小代码</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/27/Docker-学习三-Docker仓库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     663 字
	</span>
	<span title="阅读时长">
     2 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/27/Docker-学习三-Docker仓库/" itemprop="url">Docker-学习三(Docker仓库)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-27T20:10:35+08:00">
                2020-01-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker镜像/" itemprop="url" rel="index">
                    <span itemprop="name">Docker镜像</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/27/Docker-学习三-Docker仓库/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/27/Docker-学习三-Docker仓库/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  663
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>docker仓库（Repository）是集中存放镜像的地方，与git概念类似，分为公共仓库和私有仓库。一般与注册服务器（Registry）容易混淆。注册服务器是存放仓库的服务器，其中可有多个仓库。</p>
<h1 id="内容提要"><a href="#内容提要" class="headerlink" title="内容提要"></a>内容提要</h1><p>使用Docker Hub官方仓库，登陆下载，及私有仓库的搭建等操作。</p>
<h2 id="Docker-Hub-公共仓库"><a href="#Docker-Hub-公共仓库" class="headerlink" title="Docker Hub 公共仓库"></a>Docker Hub 公共仓库</h2><p>Docker官方维护了一个公共镜像仓库 <a href="https://hub.docker.com" target="_blank" rel="noopener">https://hub.docker.com</a> ，大部分镜像可以从官方下载。</p>
<h3 id="1-登陆"><a href="#1-登陆" class="headerlink" title="1.登陆"></a>1.登陆</h3><p>在官网进行注册账号，通过命令执行docker login 来输入用户名密码进行登陆，本地用户目录的.dockercfg中将保存用户的认证信息。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></table></figure></p>
<h3 id="2-基本操作"><a href="#2-基本操作" class="headerlink" title="2.基本操作"></a>2.基本操作</h3><p>不需要登陆也可以使用 docker search 查询官方镜像，也可以使用docker pull命令将其下载到本地。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker search mysql -s 10</span><br><span class="line">docker pull centos</span><br></pre></td></tr></table></figure>
<p>可以使用docker push 命令来将本地镜像推送到 Docker<br>Hub<br>直接推送镜像时会报错：<strong>denied: requested access to the resource is denied</strong><br>因为没有提交权限，此时应该将要推送的镜像添加tag，将其与docker Hub仓库路径保持一致。<br><img src="https://i.loli.net/2019/11/28/Hl3Rz52YUaJqBtA.png" alt="DockerHub.png"><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag test:0.1 lisidapao/test:v1.0</span><br><span class="line">docker push lisidapao/test</span><br></pre></td></tr></table></figure></p>
<h2 id="搭建本地私有仓库"><a href="#搭建本地私有仓库" class="headerlink" title="搭建本地私有仓库"></a>搭建本地私有仓库</h2><h3 id="1-使用registry-镜像创建私有仓库"><a href="#1-使用registry-镜像创建私有仓库" class="headerlink" title="1.使用registry 镜像创建私有仓库"></a>1.使用registry 镜像创建私有仓库</h3><p>通过官方提供的 registry 镜像来简单搭建一套本地私<br>有仓库环境<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 registry</span><br></pre></td></tr></table></figure></p>
<p>通过- v参数来将镜像文件存放在本地的指定路径<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 -v /opt/data/registry:/tmp/registry registry</span><br></pre></td></tr></table></figure></p>
<h3 id="2-管理私有仓库"><a href="#2-管理私有仓库" class="headerlink" title="2. 管理私有仓库"></a>2. 管理私有仓库</h3><p>获取仓库服务的ip地址，再开一个虚拟机模拟本地将本地镜像tag标记为：<strong>仓库IP:5000/test</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag ubuntu:14.04 10.0.2.2:5000/test</span><br></pre></td></tr></table></figure></p>
<p>使用docker push 上传标记的镜像：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push 10.0.2.2:5000/test</span><br></pre></td></tr></table></figure></p>
<p>用curl 查看仓库10.0.2.2： 5000 中的镜像<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.0.2.2:5000/v1/search</span><br></pre></td></tr></table></figure></p>
<p>结果中可以看到{“description”：””，”name”：”library/test”}，表明镜像已经成功上传了。现在可以到任意一台能访问到 10.0.2.2地址的机器去下载这个镜像了。</p>
<p>版本较新的Docker版本对安全性要求比较高，要求仓库支持SSL/TLS证书。内部使用的私有仓库，可以关闭对此的检查。<br>添加如下参数，标识信任该仓库，不进行证书检查，重启Docker 服务配置生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS="--insecure-registry 10.0.2.2:5000"</span><br></pre></td></tr></table></figure></p>
<h2 id="国内仓库配置"><a href="#国内仓库配置" class="headerlink" title="国内仓库配置"></a>国内仓库配置</h2><p>阿里云，时速云，网易云等相关：<a href="https://www.cnblogs.com/wushuaishuai/p/9984228.html" target="_blank" rel="noopener">https://www.cnblogs.com/wushuaishuai/p/9984228.html</a></p>
<p>参考资料：Docker技术入门与实战</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/12/Jenkins-Svn-Ant持续集成/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     2.6k 字
	</span>
	<span title="阅读时长">
     13 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/12/Jenkins-Svn-Ant持续集成/" itemprop="url">Jenkins + Svn + Ant持续集成</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-12T19:40:24+08:00">
                2020-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/12/Jenkins-Svn-Ant持续集成/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/12/Jenkins-Svn-Ant持续集成/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、Jenkins基础配置"><a href="#一、Jenkins基础配置" class="headerlink" title="一、Jenkins基础配置"></a>一、Jenkins基础配置</h2><h3 id="1-配置中文"><a href="#1-配置中文" class="headerlink" title="1.配置中文"></a>1.配置中文</h3><p>主界面–&gt;系统管理–&gt;插件管理–&gt;可选插件<br>安装插件locale plugin<br>系统管理–&gt;系统设置–&gt;Locale<br>填入：zh_CN<br>保存应用</p>
<h3 id="2-插件管理"><a href="#2-插件管理" class="headerlink" title="2.插件管理"></a>2.插件管理</h3><p>插件管理在 系统管理 -&gt; 管理插件 里面。<br>我们需要先完成的插件的安装才能配置和管理我们Job,有以下几种插件是我们需要的：</p>
<ul>
<li>Svn plugin(Svn 源码管理插件)</li>
<li>antPlugin(ant 打包插件)</li>
<li>Publish Over SSH(远程访问的SSH插件)<br><img src="https://i.loli.net/2020/01/10/wGJr7RdiSyoce6h.png" alt="插件.png"><h3 id="3-全局工具配置"><a href="#3-全局工具配置" class="headerlink" title="3.全局工具配置"></a>3.全局工具配置</h3>全局工具配置在 系统管理 -&gt; Global Tool Configuration<br><img src="https://i.loli.net/2020/01/10/5v6zB1qbUQPilCc.png" alt="全局工具配置.png"></li>
<li>JDK配置</li>
<li>Git配置</li>
<li>Maven配置</li>
<li><p>Ant配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Name ：ant_1.9.6</span><br><span class="line">ANT_HOME： /home/data/apache-ant-1.9.6</span><br></pre></td></tr></table></figure>
</li>
<li><p>Gradle配置</p>
<h3 id="4-系统配置"><a href="#4-系统配置" class="headerlink" title="4.系统配置"></a>4.系统配置</h3><p><strong>Jenkins Location</strong><br>邮件配置图<br><img src="https://i.loli.net/2020/01/10/sVMklCj3euwg5f7.png" alt="邮件配置_20200109173337.png"><br><strong>SSH配置</strong><br><img src="https://i.loli.net/2020/01/10/qngVMPmL2uykp1Q.png" alt="ssh_20200109173549.png"><br>配置完成后点击TestConfiguration进行测试，是否连通。<br>如果是服务器集群的话，就再增加一个 SSH Server。</p>
</li>
</ul>
<h2 id="二、新建任务"><a href="#二、新建任务" class="headerlink" title="二、新建任务"></a>二、新建任务</h2><p><img src="https://i.loli.net/2020/01/10/ZwMkHCBlbGJ4RLK.png" alt="新建任务.png"></p>
<h3 id="1-添加任务描述"><a href="#1-添加任务描述" class="headerlink" title="1.添加任务描述"></a>1.添加任务描述</h3><p><img src="https://i.loli.net/2020/01/10/uEe68y7xKjHOmo9.png" alt="job构建.png"></p>
<h3 id="2-源码管理"><a href="#2-源码管理" class="headerlink" title="2.源码管理"></a>2.源码管理</h3><h4 id="选择Subversion绑定svn"><a href="#选择Subversion绑定svn" class="headerlink" title="选择Subversion绑定svn"></a>选择Subversion绑定svn</h4><p><img src="https://i.loli.net/2020/01/10/DjWTJpLPMg4F7N5.png" alt="job_svn.png"></p>
<h4 id="Check-out-Strategy各个选项详细"><a href="#Check-out-Strategy各个选项详细" class="headerlink" title="Check-out Strategy各个选项详细"></a>Check-out Strategy各个选项详细</h4><p><table><br>   <tr><br>      <td>Check-out Strategy</td><br>      <td>第一次build </td><br>      <td>第n次build(除第一次)</td><br>   </tr><br>   <tr><br>      <td>Use ‘svn update’ as much as possible    </td><br>      <td rowspan="4">将workspace下的所有文件清空，然后从svn上check out一份完整的项目到workspace下</td><br>      <td>update前不会revert</td><br>   </tr><br>   <tr><br>      <td>Always check out a fresh copy    </td><br>      <td>删除workspace下的所有文件，然后重新check out一份完整的项目到workspace下。</td><br>   </tr><br>    <tr><br>      <td>Emulate clean checkout by first deleting unversioned/ignored files, then ‘svn update’        </td><br>      <td>update前先删除unversioned/ignored文件</td><br>   </tr><br>    <tr><br>      <td>Use ‘svn update’ as much as possible, with ‘svn revert’ before updat    </td><br>      <td>update前先revert</td><br>   </tr><br></table><br>参考博客：<a href="https://blog.csdn.net/russ44/article/details/52261781" target="_blank" rel="noopener">russ44</a></p>
<h3 id="3-构建触发器"><a href="#3-构建触发器" class="headerlink" title="3.构建触发器"></a>3.构建触发器</h3><p>可选择定时构建，轮询构建等多种方式。<br><img src="https://i.loli.net/2020/01/10/6PVQEMlrZJUkwoD.png" alt="构建触发器.png"></p>
<h3 id="4-构建环境"><a href="#4-构建环境" class="headerlink" title="4.构建环境"></a>4.构建环境</h3><h4 id="4-1配置Ant"><a href="#4-1配置Ant" class="headerlink" title="4.1配置Ant"></a>4.1配置Ant</h4><p>不指定时默认使用build.xml，我这里新写了一个add_build.xml配置后执行。<br><img src="https://i.loli.net/2020/01/10/NbRv5eSrpmaMjhk.png" alt="ant配置.png"><br>add_build.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">name</span>=<span class="string">"policy_vhl_110"</span> <span class="attr">basedir</span>=<span class="string">"."</span> <span class="attr">default</span>=<span class="string">"package"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">environment</span>=<span class="string">"env"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"ant.home"</span> <span class="attr">value</span>=<span class="string">"$&#123;env.ANT_HOME&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"java.home"</span> <span class="attr">value</span>=<span class="string">"$&#123;env.JAVA_HOME&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/path"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.lib"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/templib"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.dir_1"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/main/java"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.dir_2"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/main/resources"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.dir_3"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/interface"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"web.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/WebRoot"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"build.classes"</span> <span class="attr">value</span>=<span class="string">"$&#123;web.dir&#125;/WEB-INF/classes"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dist.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/policy_vhl_jar"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"conf.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;web.dir&#125;/WEB-INF/classes/conf"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"temp_build.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/build"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"conf.dir_1"</span> <span class="attr">value</span>=<span class="string">"$&#123;web.dir&#125;/WEB-INF/"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 依赖路径，用于编译 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">path</span> <span class="attr">id</span>=<span class="string">"classpath"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--&lt;fileset dir="$&#123;basedir&#125;/build"&gt;</span></span><br><span class="line"><span class="comment">			&lt;include name="**/*.jar" /&gt;</span></span><br><span class="line"><span class="comment">		&lt;/fileset&gt; --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;web.dir&#125;/WEB-INF/lib"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">"**/*.jar"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 排除java源文件的模式集 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">id</span>=<span class="string">"no.java"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">exclude</span> <span class="attr">name</span>=<span class="string">"**/*.java"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">patternset</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 排除conf下配置文件 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">id</span>=<span class="string">"properties"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">exclude</span> <span class="attr">name</span>=<span class="string">"**/applicationDeployment.properties"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">exclude</span> <span class="attr">name</span>=<span class="string">"**/pcisv6DataSource.properties"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">exclude</span> <span class="attr">name</span>=<span class="string">"**/*.java"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">patternset</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">echo</span>&gt;</span>******删除pcis目录下包<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.lib&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">dir</span>=<span class="string">"$&#123;build.classes&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">dir</span>=<span class="string">"$&#123;basedir&#125;/conf"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">echo</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span>清理完毕<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 初始化,建立目录,将多个src目录复制到同一src目录，编译--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"init"</span> <span class="attr">description</span>=<span class="string">"初始化,建立目录,复制文件"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">echo</span>&gt;</span>**** init dir copy ****<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mkdir</span> <span class="attr">dir</span>=<span class="string">"$&#123;build.classes&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mkdir</span> <span class="attr">dir</span>=<span class="string">"$&#123;dist.dir&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mkdir</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">copy</span> <span class="attr">todir</span>=<span class="string">"$&#123;src.dir&#125;"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_1&#125;"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_2&#125;"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_3&#125;"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">copy</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">copy</span> <span class="attr">todir</span>=<span class="string">"$&#123;build.classes&#125;"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_1&#125;"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">refid</span>=<span class="string">"no.java"</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">refid</span>=<span class="string">"properties"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_2&#125;"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">refid</span>=<span class="string">"properties"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_3&#125;"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">refid</span>=<span class="string">"properties"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">copy</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 编译 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"compile"</span> <span class="attr">depends</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">echo</span>&gt;</span>**** compile  to classes dir ****<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">javac</span> <span class="attr">srcdir</span>=<span class="string">"$&#123;src.dir&#125;"</span> <span class="attr">destdir</span>=<span class="string">"$&#123;build.classes&#125;"</span> <span class="attr">target</span>=<span class="string">"1.6"</span> <span class="attr">source</span>=<span class="string">"1.6"</span> <span class="attr">debug</span>=<span class="string">"true"</span> <span class="attr">debuglevel</span>=<span class="string">"lines,vars,source"</span> <span class="attr">fork</span>=<span class="string">"true"</span> <span class="attr">executable</span>=<span class="string">"/home/data/jdk1.6.0_45/bin/javac"</span> <span class="attr">memoryMaximumSize</span>=<span class="string">"1024m"</span> <span class="attr">nowarn</span>=<span class="string">"on"</span> <span class="attr">includeantruntime</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">compilerarg</span> <span class="attr">line</span>=<span class="string">"-encoding UTF-8"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">classpath</span> <span class="attr">refid</span>=<span class="string">"classpath"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">javac</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">path</span> <span class="attr">id</span>=<span class="string">"lib_classpath"</span>&gt;</span></span><br><span class="line">	        <span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;basedir&#125;/"</span>&gt;</span></span><br><span class="line">	            <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">"svnPacket.jar"</span>/&gt;</span></span><br><span class="line">	        <span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"package"</span> <span class="attr">depends</span>=<span class="string">"compile"</span>&gt;</span>  </span><br><span class="line">		 <span class="tag">&lt;<span class="name">echo</span>&gt;</span>开始.......<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">       	<span class="comment">&lt;!-- &lt;java classname="com.glory.svn.SVNKitUtil" classpathref="lib_classpath"&gt;</span></span><br><span class="line"><span class="comment">        &lt;/java&gt;--&gt;</span></span><br><span class="line">		 <span class="tag">&lt;<span class="name">echo</span>&gt;</span>结束.......<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">target</span>&gt;</span>	</span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="4-2执行shell"><a href="#4-2执行shell" class="headerlink" title="4.2执行shell"></a>4.2执行shell</h4><p><img src="https://i.loli.net/2020/01/10/euO3CgoGwy6lxvM.png" alt="构建环境shell.png"><br>因为项目目前的打包方式是增量包，所以在这里使用java写了一个脚本，作用是将想发布的内容以版本号为标的，将两个版本号范围内提交的内容提取到一个文件内（svn_version.txt），再使用打包工具将文件内的列表进行打包。<br>其中主要使用的是svnkit的jar包获取svn对应版本号内提交的内容，将路径进行转换成class路径输出到目标文件内。<br>具体代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> String line = System.getProperty(<span class="string">"line.separator"</span>, <span class="string">"/n"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SVNRepository repository ;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream is = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"svnconfig.properties"</span>));</span><br><span class="line">            BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is, <span class="string">"UTF-8"</span>));</span><br><span class="line">            properties.load(bufferedReader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DAVRepositoryFactory.setup();</span><br><span class="line">        SVNRepositoryFactoryImpl.setup();</span><br><span class="line">        FSRepositoryFactory.setup();</span><br><span class="line">        String uName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            uName = (String)properties.get(<span class="string">"SVN_URL"</span>);</span><br><span class="line">            repository = SVNRepositoryFactory.create(SVNURL.parseURIEncoded(uName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SVNException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uName = (String)properties.get(<span class="string">"SVN_USERNAME"</span>);</span><br><span class="line">        String passwd = (String)properties.get(<span class="string">"SVN_PASSWORD"</span>);</span><br><span class="line">        ISVNAuthenticationManager authManager = SVNWCUtil.createDefaultAuthenticationManager(uName, passwd.toCharArray());</span><br><span class="line">        repository.setAuthenticationManager(authManager);</span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println("Repository Root:" + repository.getRepositoryRoot(true));</span></span><br><span class="line"><span class="comment">//            System.out.println("Repository UUID:" + repository.getRepositoryUUID(true));</span></span><br><span class="line"><span class="comment">//        &#125; catch (SVNException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">filterCommitHistoryTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startRevision = <span class="number">100L</span>;</span><br><span class="line">        String versionStr = <span class="string">"100"</span>;</span><br><span class="line">        InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File vFile = <span class="keyword">new</span> File(<span class="string">"svn_version.txt"</span>);</span><br><span class="line">            inputStream = <span class="keyword">new</span> FileInputStream(vFile);</span><br><span class="line">            <span class="keyword">byte</span>[] byets = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>)vFile.length()];</span><br><span class="line">            inputStream.read(byets);</span><br><span class="line">            versionStr = <span class="keyword">new</span> String(byets,<span class="string">"utf-8"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> != inputStream) inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != versionStr &amp;&amp; !<span class="string">""</span>.equals(versionStr))&#123;</span><br><span class="line">            String[] versions = versionStr.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> endRevision = -<span class="number">1L</span>;</span><br><span class="line">            <span class="keyword">final</span> List&lt;String&gt; history = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            <span class="keyword">final</span> List&lt;Long&gt; versionList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            <span class="keyword">final</span> Set&lt;String&gt; delPathSet = <span class="keyword">new</span> HashSet();</span><br><span class="line">            <span class="keyword">for</span>(String version : versions)&#123;</span><br><span class="line">                startRevision = Long.parseLong(version);</span><br><span class="line">                repository.log(<span class="keyword">new</span> String[]&#123;<span class="string">""</span>&#125;, startRevision, endRevision, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">new</span> ISVNLogEntryHandler() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLogEntry</span><span class="params">(SVNLogEntry svnlogentry)</span> <span class="keyword">throws</span> SVNException </span>&#123;</span><br><span class="line">                        versionList.add(svnlogentry.getRevision());</span><br><span class="line">                        Map&lt;String, SVNLogEntryPath&gt; mapLog = svnlogentry.getChangedPaths();</span><br><span class="line">                        Set&lt;String&gt; keySet = mapLog.keySet();</span><br><span class="line">                        Iterator var5 = keySet.iterator();</span><br><span class="line">                        <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">                            String logkey = (String)var5.next();</span><br><span class="line">                            <span class="keyword">char</span> cType = ((SVNLogEntryPath)mapLog.get(logkey)).getType();</span><br><span class="line">                            <span class="keyword">if</span> (<span class="string">'D'</span> == cType) &#123;</span><br><span class="line">                                delPathSet.add(logkey);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        history.addAll((Collection)svnlogentry.getChangedPaths().keySet());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            Set&lt;String&gt; fileNameSet = <span class="keyword">new</span> HashSet();</span><br><span class="line">            StringBuilder sBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            Iterator hisIter = history.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(hisIter.hasNext()) &#123;</span><br><span class="line">                String path = (String)hisIter.next();</span><br><span class="line">                <span class="keyword">if</span> (!delPathSet.contains(path)) &#123;</span><br><span class="line">                    String className;</span><br><span class="line">                    <span class="keyword">if</span> (path.contains(<span class="string">"WebRoot"</span>)) &#123;</span><br><span class="line">                        className = path.substring(path.indexOf(<span class="string">"WebRoot"</span>));</span><br><span class="line">                        fileNameSet.add(className);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (path.contains(<span class="string">"src"</span>)) &#123;</span><br><span class="line">                        className = path.substring(path.indexOf(<span class="string">"src"</span>));</span><br><span class="line">                        className = className.replace(<span class="string">"src/main/java"</span>, <span class="string">"WebRoot/WEB-INF/classes"</span>);</span><br><span class="line">                        className = className.replace(<span class="string">"src/interface/com"</span>, <span class="string">"WebRoot/WEB-INF/classes/com"</span>);<span class="comment">//只针对车承保</span></span><br><span class="line">                        className = className.replace(<span class="string">"src/com"</span>, <span class="string">"WebRoot/WEB-INF/classes/com"</span>);</span><br><span class="line">                        className = className.replace(<span class="string">"src/main/resources"</span>, <span class="string">"WebRoot/WEB-INF/classes"</span>);</span><br><span class="line">                        className = className.replace(<span class="string">"src"</span>, <span class="string">"WebRoot/WEB-INF/classes"</span>);</span><br><span class="line">                        className = className.replace(<span class="string">".java"</span>, <span class="string">".class"</span>);</span><br><span class="line">                        fileNameSet.add(className);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            Iterator fileIter = fileNameSet.iterator();</span><br><span class="line">            <span class="keyword">while</span>(fileIter.hasNext()) &#123;</span><br><span class="line">                String namePath = (String)fileIter.next();</span><br><span class="line">                ++i;</span><br><span class="line">                sBuilder.append(namePath);</span><br><span class="line">                <span class="keyword">if</span> (i != fileNameSet.size()) &#123;</span><br><span class="line">                    sBuilder.append(line);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            OutputStream outputStream = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                File file = <span class="keyword">new</span> File(<span class="string">"file_list.txt"</span>);</span><br><span class="line">                <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        file.createNewFile();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                outputStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">                outputStream.write(sBuilder.toString().getBytes());</span><br><span class="line">                outputStream.flush();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">null</span> != outputStream) outputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"打包工程start"</span>);</span><br><span class="line">        setupLibrary();</span><br><span class="line">        filterCommitHistoryTest();</span><br><span class="line">        System.out.println(<span class="string">"打包工程end"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo =====gen file list begin===== </span><br><span class="line">cd /var/lib/jenkins/workspace/policy_vhl_110/ </span><br><span class="line">java -jar svnPacket.jar</span><br><span class="line">echo =====gen file list end===== </span><br><span class="line">echo =====make jar======</span><br><span class="line">jar cvf policy_vhl_jar/policy_vhl.jar @file_list.txt</span><br><span class="line">echo ====make jar over=====</span><br></pre></td></tr></table></figure></p>
<p>简述下流程</p>
<ol>
<li>首先代码提交开发版本库</li>
<li>由开发版本库将内容合并至DEV版本库</li>
<li>提交svn_version.txt文件，里面记录着想发布到DEV环境的SVN version编号。例如：svn列表由上到下为1、2、3、4代码无交叉，svn_version记录着2，3 ，则虽然1、2、3、4代码已经发布了DEV环境的代码基线，并且其代码已经构建，但是只会将2，3中提交的代码进行打包。</li>
<li>根据file_list.txt记录的具体class路径进行打包，获得指定版本编号范围内的代码。</li>
<li>将jar发布至远程服务，解压重启。</li>
</ol>
<h3 id="5-构建后操作"><a href="#5-构建后操作" class="headerlink" title="5.构建后操作"></a>5.构建后操作</h3><p><img src="https://i.loli.net/2020/01/10/ZaXtE1pOjm9cg2b.png" alt="构建后操作SSH图片.png"><br>指定环境变量，将jar发送到远程服务器目标路径下，解压jar包后调用jenkins.sh脚本进行重启。（容器为weblogic）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">echo =====jar begin=====</span><br><span class="line">export JAVA_HOME=/usr/java/jrockit-jdk1.6.0_29-R28.1.5-4.0.1</span><br><span class="line">export PATH=$JAVA_HOME/bin:/usr/local/bin:$PATH:$MAVEN_HOME/bin</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar</span><br><span class="line">cd /usr/bin </span><br><span class="line">ln -s -f /usr/java/jrockit-jdk1.6.0_29-R28.1.5-4.0.1/bin/jar   jar</span><br><span class="line"></span><br><span class="line">cd /home/source/7002/policy_vhl</span><br><span class="line">jar -xvf policy_vhl.jar</span><br><span class="line">echo =====jar end=====</span><br><span class="line">cd /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/</span><br><span class="line">./jenkins.sh &amp;</span><br></pre></td></tr></table></figure></p>
<p>脚本主要是进行重启，最后将jar包按照时间戳进行重命名。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span>jenkins 重启脚本</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>删除lok文件</span><br><span class="line">find /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/ -name "*.lok" -print -exec rm -rf &#123;&#125; \;</span><br><span class="line"><span class="meta">#</span>清除服务器缓存</span><br><span class="line">cd /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/servers/AdminServer/tmp/_WL_user</span><br><span class="line">rm -rf pcisv7</span><br><span class="line"><span class="meta">#</span>查找并强制杀死进程</span><br><span class="line">ps -ef|egrep 7002|gawk '&#123;print $2&#125;'|while read pid</span><br><span class="line">do</span><br><span class="line">kill -9 $pid</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span>以当前时间命名后台日志，并显示</span><br><span class="line">str=$"/n"</span><br><span class="line">MYDATE=`date +%Y%m%d%H%M%S` </span><br><span class="line">echo "$MYDATE"</span><br><span class="line"><span class="meta">#</span>清除历史日志，防止占内存过多</span><br><span class="line">cd /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/logs</span><br><span class="line">rm -rf *.log</span><br><span class="line">cd /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/bin</span><br><span class="line">nohup ./startWebLogic.sh&gt;/home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/logs/$MYDATE.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="meta">#</span> 重命名jar包</span><br><span class="line">mv /home/source/7002/policy_vhl/policy_vhl.jar  policy_vhl.$MYDATE.jar</span><br></pre></td></tr></table></figure></p>
<h3 id="6-立即构建"><a href="#6-立即构建" class="headerlink" title="6.立即构建"></a>6.立即构建</h3><p><img src="https://i.loli.net/2020/01/10/QzjkSHuMGT3ah8L.png" alt="立即构建_20200110103123.png"></p>
<h2 id="三、问题处理"><a href="#三、问题处理" class="headerlink" title="三、问题处理"></a>三、问题处理</h2><h3 id="ant编译时乱码问题："><a href="#ant编译时乱码问题：" class="headerlink" title="ant编译时乱码问题："></a>ant编译时乱码问题：</h3><p>编译时遇到 “非法字符： \65279”的报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[javac] /var/lib/jenkins/workspace/policy_vhl_110/src/path/interface/com/isoftstone/pcis/policy/foreignInterface/service/impl/ElectricityPinServiceImpl.java:1: 非法字符： \65279</span><br></pre></td></tr></table></figure></p>
<p>解决:<a href="https://blog.csdn.net/netwalk/article/details/52005546" target="_blank" rel="noopener">https://blog.csdn.net/netwalk/article/details/52005546</a></p>
<h3 id="软件包-javax-servlet-不存在"><a href="#软件包-javax-servlet-不存在" class="headerlink" title="软件包 javax.servlet 不存在"></a>软件包 javax.servlet 不存在</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">软件包 javax.servlet 不存在</span><br><span class="line">[javac] import javax.servlet.ServletException;</span><br></pre></td></tr></table></figure>
<p>解决办法：<br>从tomcat lib目录下拷贝一个servlet-api.jar的包到“JDK\jre\lib\ext”目录下<br>凡是出现找不到包的情况，都可以将找到的包放到JDK\jre\lib\ext下，然后再编译就能够通过。</p>
<h2 id="四、扩展资料"><a href="#四、扩展资料" class="headerlink" title="四、扩展资料"></a>四、扩展资料</h2><p>代码及相关资料地址：<a href="https://github.com/cmevolve/xieexiaodaima/tree/master/DevOps/Jenkins%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener">https://github.com/cmevolve/xieexiaodaima/tree/master/DevOps/Jenkins%E9%85%8D%E7%BD%AE</a></p>
<h3 id="1-Ant-构建相关连接"><a href="#1-Ant-构建相关连接" class="headerlink" title="1.Ant 构建相关连接"></a>1.Ant 构建相关连接</h3><p><a href="https://blog.csdn.net/Al_assad/article/details/76285841" target="_blank" rel="noopener">https://blog.csdn.net/Al_assad/article/details/76285841</a><br><a href="https://blog.csdn.net/mevicky/article/details/72828554" target="_blank" rel="noopener">https://blog.csdn.net/mevicky/article/details/72828554</a><br><a href="https://blog.csdn.net/xxdddail/article/details/21166161" target="_blank" rel="noopener">https://blog.csdn.net/xxdddail/article/details/21166161</a><br><a href="https://blog.csdn.net/yang3wei/article/details/7393399" target="_blank" rel="noopener">https://blog.csdn.net/yang3wei/article/details/7393399</a><br><a href="https://www.cnblogs.com/fnlingnzb-learner/p/6279189.html" target="_blank" rel="noopener">https://www.cnblogs.com/fnlingnzb-learner/p/6279189.html</a><br><a href="https://www.yiibai.com/ant/apache-ant-javac-task.html" target="_blank" rel="noopener">https://www.yiibai.com/ant/apache-ant-javac-task.html</a></p>
<h3 id="2-Svnkit-组件使用："><a href="#2-Svnkit-组件使用：" class="headerlink" title="2.Svnkit 组件使用："></a>2.Svnkit 组件使用：</h3><p><a href="https://www.cnblogs.com/douJiangYouTiao888/p/6138660.html" target="_blank" rel="noopener">https://www.cnblogs.com/douJiangYouTiao888/p/6138660.html</a></p>
<h3 id="3-Jenkins-Ant"><a href="#3-Jenkins-Ant" class="headerlink" title="3. Jenkins+Ant"></a>3. Jenkins+Ant</h3><p><a href="https://blog.csdn.net/xiaxiaozhang/article/details/74155300" target="_blank" rel="noopener">https://blog.csdn.net/xiaxiaozhang/article/details/74155300</a><br>jekins svn任务配置：<a href="https://blog.csdn.net/russ44/article/details/52261781" target="_blank" rel="noopener">https://blog.csdn.net/russ44/article/details/52261781</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/11/Jenkins-安装配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     866 字
	</span>
	<span title="阅读时长">
     3 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/11/Jenkins-安装配置/" itemprop="url">Jenkins 安装配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-11T15:10:16+08:00">
                2020-01-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/11/Jenkins-安装配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/11/Jenkins-安装配置/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  866
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Jenkins介绍"><a href="#Jenkins介绍" class="headerlink" title="Jenkins介绍"></a>Jenkins介绍</h2><blockquote>
<p>Jenkins是一个独立的开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件的持续集成变成可能。前身是Hudson是一个可扩展的持续集成引擎。可用于自动化各种任务，如构建，测试和部署软件。Jenkins可以通过本机系统包Docker安装，甚至可以通过安装Java Runtime Environment的任何机器独立运行。</p>
</blockquote>
<h2 id="一、安装准备"><a href="#一、安装准备" class="headerlink" title="一、安装准备"></a>一、安装准备</h2><p>在这里构建的是Jenkins+ANT+SVN的一套发布流程</p>
<h3 id="安装JDK环境变量"><a href="#安装JDK环境变量" class="headerlink" title="安装JDK环境变量"></a>安装JDK环境变量</h3><p>JDK安装配置<br>略，参考：<a href="https://www.cnblogs.com/liuhongfeng/p/4177568.html" target="_blank" rel="noopener">https://www.cnblogs.com/liuhongfeng/p/4177568.html</a></p>
<h3 id="安装ANT并配置环境变量"><a href="#安装ANT并配置环境变量" class="headerlink" title="安装ANT并配置环境变量"></a>安装ANT并配置环境变量</h3><p> ANT安装配置<br>windows<br>下载地址：<a href="http://ant.apache.org" target="_blank" rel="noopener">http://ant.apache.org</a></p>
<p><strong>配置环境变量</strong><br>windows中设置ant环境变量：<br>| 属性        | 配置   |<br>| ——–   | —–:  |<br>| ANT_HOME     | D:/ apache-ant-1.10.0 |<br>| path        |   %ANT_HOME%/bin  |<br>| classpath       |   %ANT_HOME%/lib   | </p>
<p>linux中设置ant环境变量：</p>
<ul>
<li>将下载的tar.gz复制到/usr 下</li>
<li>tar -vxzf apahce-ant-1.9.2-bin.tar.gz  解压</li>
<li>chown -R yjdabc apahce-ant-1.9.2  改变权限<br>chown -R :users apahce-ant-1.9.2<br>chmod -R +x apahce-ant-1.9.2</li>
<li><p>vim /etc/profile    修改系统配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#set Ant enviroment</span><br><span class="line">export ANT_HOME=/usr/apache-ant-1.9.2</span><br><span class="line">export PATH=$PATH:$ANT_HOME/bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>source /etc/proifle   立刻将配置生效</p>
<h2 id="二、-Jenkins-安装"><a href="#二、-Jenkins-安装" class="headerlink" title="二、 Jenkins 安装"></a>二、 Jenkins 安装</h2><p>linux下安装有3种方式</p>
</li>
<li><p>Docker安装（推荐）</p>
</li>
<li>使用tomcat启动，将安装目录 /usr/lib/jenkins/下的war包放于Tomcat的webapps目录下 </li>
<li>安装Jenkins</li>
</ul>
<p>第三种安装方式：</p>
<h3 id="1-离线安装-推荐"><a href="#1-离线安装-推荐" class="headerlink" title="1.离线安装-推荐"></a>1.离线安装-推荐</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## http://pkg.jenkins-ci.org/redhat-stable/</span><br><span class="line">wget http://pkg.jenkins-ci.org/redhat/jenkins-2.39-1.1.noarch.rpm ## 下载(也可以Windows下载再转过来)</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key ## 导入公钥，发现离线安装，不需要导入公钥就能安装</span><br><span class="line">rpm -ih jenkins-2.7.2-1.1.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>自动安装完成之后：</p>
<ul>
<li>/usr/lib/jenkins/jenkins.war WAR包</li>
<li>/etc/sysconfig/jenkins 配置文件</li>
<li>/var/lib/jenkins/ 默认的JENKINS_HOME目录</li>
<li>/var/log/jenkins/jenkins.log Jenkins日志文件</li>
</ul>
<h3 id="2-在线安装"><a href="#2-在线安装" class="headerlink" title="2.在线安装"></a>2.在线安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 添加Jenkins源</span><br><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">yum repolist # Update your package manager list to get the latest packages</span><br><span class="line"># 安装</span><br><span class="line">yum install java-1.8.0-openjdk jenkins</span><br><span class="line">service jenkins start # 启动</span><br></pre></td></tr></table></figure>
<h2 id="三、Jenkins设置"><a href="#三、Jenkins设置" class="headerlink" title="三、Jenkins设置"></a>三、Jenkins设置</h2><p>为了不因为权限出现各种问题，这里直接使用root<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## sudo vim /etc/sysconfig/jenkins</span><br><span class="line">JENKINS_USER=&quot;root&quot; ## 原值 &quot;jenkins&quot; 必须修改，否则权限不足</span><br><span class="line">JENKINS_PORT=&quot;8080&quot; ## 原值 &quot;8080&quot; 可以不修改</span><br></pre></td></tr></table></figure></p>
<p>修改目录权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R root:root /var/lib/jenkins</span><br><span class="line">chown -R root:root /var/cache/jenkins</span><br><span class="line">chown -R root:root /var/log/jenkins</span><br></pre></td></tr></table></figure></p>
<h2 id="四、Jenkins-启动"><a href="#四、Jenkins-启动" class="headerlink" title="四、Jenkins 启动"></a>四、Jenkins 启动</h2><p>启动Jenkins<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable jenkins # 开机自启动Jenkins</span><br><span class="line">sudo systemctl start jenkins # 启动Jenkins</span><br></pre></td></tr></table></figure></p>
<p>查看服务细节<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status jenkins.service</span><br></pre></td></tr></table></figure></p>
<p>验证Jenkins Server访问链接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet IP 8080</span><br></pre></td></tr></table></figure></p>
<p>如果访问有问题，需要把防火墙关了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld.service #重启不自动开启</span><br></pre></td></tr></table></figure></p>
<p>通过如下两个命令查看防火墙是否关闭<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files|grep firewalld.service</span><br><span class="line">iptables -t nat -S</span><br></pre></td></tr></table></figure></p>
<h2 id="五、Jenkins-master优化"><a href="#五、Jenkins-master优化" class="headerlink" title="五、Jenkins master优化"></a>五、Jenkins master优化</h2><p>增加同时打开文件句柄数<br>增加同时打开文件句柄数，linux默认一个进程能同时打开的文件句柄是1024个，在jenkins master肯定是不够的，需要调整成65535<br>CentOS系统，修改/etc/security/limits.conf，在文件最后增加一行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root             -       nofile          65535</span><br></pre></td></tr></table></figure></p>
<p>重启后生效，可以通过命令ulimit -a查看<br>登录地址：<a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a><br>初始密码获取：sudo cat /var/lib/jenkins/secrets/initialAdminPassword</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/06/面向对象设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     2.6k 字
	</span>
	<span title="阅读时长">
     9 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/06/面向对象设计/" itemprop="url">面向对象设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-06T20:56:50+08:00">
                2020-01-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/06/面向对象设计/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/06/面向对象设计/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>拿到一个需求时应该怎么做？</p>
<ul>
<li>明确需求</li>
<li>基础分析</li>
<li>了解最佳实践</li>
<li>测试用例</li>
<li>预计工期</li>
<li>约定接口定义</li>
<li>编写用户手册和文档，示例代码</li>
</ul>
<h2 id="如何进行面对象对象设计"><a href="#如何进行面对象对象设计" class="headerlink" title="如何进行面对象对象设计"></a>如何进行面对象对象设计</h2><ul>
<li>职责划分进而区分有哪些类<ul>
<li>将功能点罗列出来，职责相近属性类似归为同一类</li>
<li>找到功能相近，操作同样属性的可能归到一个类</li>
<li>复杂需求按照模块拆分，然后再找类</li>
</ul>
</li>
<li>定义类的属性和方法<ul>
<li>需求中的名词作为候选属性，动词作为候选方法</li>
<li>并不是所有的名词都需要作为类的属性，不属于这个类的可以通过传参来构造</li>
</ul>
</li>
<li>定义类和类的关系（以下为UML中定义的类关系）<ul>
<li>泛化<ul>
<li>简单理解为继承关系</li>
</ul>
</li>
<li>实现<ul>
<li>一般指接口和实现类之间的关系 </li>
</ul>
</li>
<li>聚合<ul>
<li>包含关系 ，A类对象包含B类对象，B类对象生命周期不依赖A类对象生命周期，如课程和学生的关系</li>
</ul>
</li>
<li>组合<ul>
<li>包含关系。A类对象包含B类对象，B 类对象生命周期依赖A类对象生命周期，B类对象不可单独存在，比如鸟和翅膀的关系。</li>
</ul>
</li>
<li>关联<ul>
<li>非常弱的关系，包含聚合和组合两种关系。如果B类对象是A类对象的成员变量，那B类和A类就是关联关系。</li>
</ul>
</li>
<li>依赖<ul>
<li>比关联关系更弱的关系，包含关联关系。只要B类对象和A类对象有任何使用关系都称他们有依赖关系。 </li>
</ul>
</li>
</ul>
</li>
<li>类组装起来并提供入口<ul>
<li>独立系统为main函数</li>
<li>web应用就是一组给外部调用的API接口</li>
</ul>
</li>
</ul>
<h2 id="分析示例"><a href="#分析示例" class="headerlink" title="分析示例"></a>分析示例</h2><p>下面用一个接口鉴权进行示例分析。</p>
<h3 id="一、需求分析"><a href="#一、需求分析" class="headerlink" title="一、需求分析"></a>一、需求分析</h3><h4 id="1-基础分析"><a href="#1-基础分析" class="headerlink" title="1.基础分析"></a>1.基础分析</h4><p>对于鉴权最简单的解决方案就是通过用户名密码来做认证，给每一个调用服务的调用方派发一个应用名和一个对应的密码/秘钥。调用方每次请求时携带自己的AppID和秘钥。服务端接收接口请求后解析出AppID和密码跟存储在服务端的账号密码比对，如果一致说明认证成功，允许接口调用请求；否则拒绝接口调用请求。</p>
<h4 id="2-分析优化"><a href="#2-分析优化" class="headerlink" title="2. 分析优化"></a>2. 分析优化</h4><p>由于使用上面的方式需要明文传输密码，密码很容易被截获，是不安全的。那么对密码加密是否就安全了呢？实际上这样也是不安全的，因为加密后的AppID和密码照样可以被黑客截获，黑客可以携带这个加密之后的密码以及对应的AppID伪装成已经认证的系统来访问服务端接口。这就是典型的[重放攻击][1]。<br>上面讲到了在设计功能时需了解下相关功能的最佳实践，而关于接口鉴权主要有JWT （适用安全不太敏感的应用）和OAuth2（授权的开放网络标准协议），刚刚这个问题，可以借助OAuth的验证思路来解决。调用方在进行接口请求的时候，将请求接口的URl、AppID、密码拼接到一块然后进行加密，生成一个token。调用方进行接口请求时将这个token及AppID等不敏感的参数信息,随URL一块传递给服务端。服务端接收请求后，根据AppID从数据库取出对应的密码，通过同样的Token生成算法，生成另一个token。用这个新生成的token跟调用方传递过来的toekn对比。如果一致则允许接口调用请求；否则，拒绝接口调用。</p>
<h4 id="3-再分析"><a href="#3-再分析" class="headerlink" title="3.再分析"></a>3.再分析</h4><p>这样设计还是存在重放攻击的风险，还是不够安全。每个URL拼接AppID、密码生成的token都是固定的。未认证系统截获URL、token和AppID之后，还是可以通过重放攻击的方式，伪装成认证系统调用这个URL对应的接口。<br>此时可以引入一个随机变量，让每一次接口请求生产的token都不一样。这里可以使用时间戳来作为随机变量。原来token是对URL、AppID密码三者进行加密生成的，现在将密码、AppID、时间戳随URL一并传递给服务端。<br>服务端接收数据后，可以根据当前时间和传递过来的时间戳，是否在一定时间窗口内（比如1分钟），如果超过1分钟，则判定token过期，拒绝接口请求。</p>
<h4 id="4-分析再优化"><a href="#4-分析再优化" class="headerlink" title="4.分析再优化"></a>4.分析再优化</h4><p>这里可能会有疑问，加了时间校验还是不够安全，未认证系统还是可以在一分钟的token失效窗口内通过截获请求、重放攻击调用服务端接口。<br>虽然这个方案还有漏洞但是实现起来比较简单，并且也不会过度影响接口本身的性能，攻与防之间本来就没有绝对的安全。我们能做的就是尽量提高攻击的成本，所以这个方案算算比较折中合理的了。<br>但是此处还有一个问题是，因为加密方式有可能使用的是通用的加密方式比如md5、SHA（不可逆加密），Base64(可逆加密)等，如果使用了可逆的加密算法黑客在截获了请求后还是可以通过尝试使用通用的加密方式来获取用户名和密码。并且上面的认证流程并不需要客户端传递真正的密码，只需要和服务端认证时token一致就可以了，所以此时我们可以使用用户的密码作为[盐][2]对URL、AppID、时间戳进行加密。服务端接收请求后取出服务端存储的密码按照同样的方式使用密码作为秘钥进行加密对token进行验证。<br>另外用户每次进行请求都要访问数据库获取用户密码，该操作过于费时，因此最好将其配置到内存数据中，如配置文件中，启动时加载到内存中或者Redis,Zookeeper等。</p>
<h4 id="5-最终需求确定"><a href="#5-最终需求确定" class="headerlink" title="5.最终需求确定"></a>5.最终需求确定</h4><ul>
<li>调用方进行接口请求时将URL、AppID、时间戳拼接到一起，通过根据密码通过加密算法生成toekn，并且将token、AppID、时间戳、拼接在URL中，一并发送到服务端。</li>
<li>服务端接收请求后，从请求中拆解出token、AppID、时间戳。</li>
<li>服务端先校验传递过来的时间戳跟当前时间是否在token的失效窗口内。如果已经超过失效时间，就算鉴权失败，拒绝接口调用请求。</li>
<li>如果token验证没有过期失效，服务端再从春初中取出AppID对应的密码，通过同样的toekn生成算法，生成另外一个token，与调用发传递过来的toekn进行匹配；如果一致则鉴权成功，允许接口调用，否则拒绝接口调用。</li>
</ul>
<h3 id="二、类的划分"><a href="#二、类的划分" class="headerlink" title="二、类的划分"></a>二、类的划分</h3><p> 根据需求将需求拆解成功能点进行罗列：</p>
<ol>
<li>把URL、AppID、时间戳拼接为一个字符串；</li>
<li>对字符串进行加密生成token；</li>
<li>将toekn、AppID、时间戳拼到URL中，形成新的URL；</li>
<li>解析URL得到toekn、AppID、时间戳等信息；</li>
<li>存储中取出AppID和对应的密码；</li>
<li>验证toekn是否过期；</li>
<li>验证toekn是否匹配；</li>
</ol>
<p>其中1、2、6、7都是跟toekn有关；5是操作AppID和密码；3、4在处理URL，所以此处可粗略的拆分为3个核心类：Token、Url、CredentialStorage。Token实现1、2、6、7操作；Url负责3、4操作、CredentialStorage负责5这个操作。</p>
<h3 id="三、属性方法"><a href="#三、属性方法" class="headerlink" title="三、属性方法"></a>三、属性方法</h3><p>Token类相关功能点有四个：</p>
<ol>
<li>把URL、AppID、时间戳拼接为一个字符串；</li>
<li>对字符串通过加密算法加密生成 token；</li>
<li>根据时间戳判断 token 是否过期失效；</li>
<li>验证两个 token 是否匹配。</li>
</ol>
<p>根据功能点涉及名词作为候选实行，动词作为候选方法，进行筛选。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AuthToken类</span><br><span class="line">属性</span><br><span class="line"> private final static long TIME_OUT_VALUE = 1 * 60 * 1000; //1min</span><br><span class="line">private long createTime;</span><br><span class="line">private long expiredTimeInterval = TIME_OUT_VALUE;</span><br><span class="line">private String token;</span><br><span class="line">构造函数</span><br><span class="line">public AuthToken(String token, long createTime) ;</span><br><span class="line">public AuthToken(String token, long createTime，long expiredTimeInterval) ;</span><br><span class="line">函数</span><br><span class="line">public boolean isExpired()；//时间校验</span><br><span class="line">public String getToken()；//获取token</span><br><span class="line">public static AuthToken generate(String originalUrl, long createTime, String userID,String pwd )；//生成token</span><br><span class="line">public boolean match(AuthToken authToken)；//token比对</span><br></pre></td></tr></table></figure></p>
<p>从业务模型上说，不应该属于这个类的属性和方法，不应该放到这个类里。比如URL、AppID、时间戳这几个名词，此处将它们作为方法参数。<br>在此之外还需要挖掘没有出现在功能点描述中的属性，如createTime，expireTimeInterval，用作tokenn超时判断。</p>
<h4 id="Url类相关功能点"><a href="#Url类相关功能点" class="headerlink" title="Url类相关功能点"></a>Url类相关功能点</h4><ol>
<li>将token、AppID、时间戳拼接到URL形成新的URL；</li>
<li>解析URL得到toekn、AppID、时间戳等信息；</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">属性</span><br><span class="line">private String originalUrl;</span><br><span class="line">private String appId;</span><br><span class="line">private long timestamp;</span><br><span class="line">private String token;</span><br><span class="line">构造函数</span><br><span class="line"> public ApiRequest(String originalUrl, String appId, long timestamp, String token) ；</span><br><span class="line">函数</span><br><span class="line">public static ApiRequest buildFromUrl(String url)；</span><br><span class="line">public String getUrl()；</span><br><span class="line">public String getToken()；</span><br><span class="line">public long getTimestamp()；</span><br><span class="line">public String getUrl()；</span><br></pre></td></tr></table></figure>
<h4 id="CredentialStorage-类相关功能点"><a href="#CredentialStorage-类相关功能点" class="headerlink" title="CredentialStorage 类相关功能点"></a>CredentialStorage 类相关功能点</h4><ol>
<li>从存储中获取AppID和对应的密码</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CredentialStorage接口</span><br><span class="line">public String getPasswordByAppId(String appId)；</span><br></pre></td></tr></table></figure>
<h3 id="四、交互关系"><a href="#四、交互关系" class="headerlink" title="四、交互关系"></a>四、交互关系</h3><p>将类组装起来提供执行入口，利用UML中的依赖组合关系进行设计。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApiAuthenticator</span> </span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">auth</span><span class="params">(String url)</span></span>; </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">auth</span><span class="params">(ApiRequest apiRequest)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultApiAuthenticatorImpl</span> <span class="keyword">implements</span> <span class="title">ApiAuthenticator</span> </span>&#123; </span><br><span class="line"><span class="keyword">private</span> CredentialStorage credentialStorage; </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultApiAuthenticator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.credentialStorage = <span class="keyword">new</span> MysqlCredentialStorage(); </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultApiAuthenticator</span><span class="params">(CredentialStorage credentialStorage)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">this</span>.credentialStorage = credentialStorage;</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">auth</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">    ApiRequest apiRequest = ApiRequest.buildFromUrl(url); auth(apiRequest);</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">auth</span><span class="params">(ApiRequest apiRequest)</span> </span>&#123;</span><br><span class="line">    String appId = apiRequest.getAppId(); String token = apiRequest.getToken(); </span><br><span class="line">    <span class="keyword">long</span> timestamp = apiRequest.getTimestamp(); </span><br><span class="line">    String originalUrl = apiRequest.getOriginalUrl(); AuthToken     clientAuthToken = <span class="keyword">new</span> AuthToken(token, timestamp); </span><br><span class="line">    <span class="keyword">if</span> (clientAuthToken.isExpired()) &#123; </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Token is expired."</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    String password = credentialStorage.getPasswordByAppId(appId);</span><br><span class="line">    AuthToken serverAuthToken = AuthToken.generate(originalUrl, appId, pwd);</span><br><span class="line">    <span class="keyword">if</span> (!serverAuthToken.match(clientAuthToken)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Token verfication failed."</span>); </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="五、入口"><a href="#五、入口" class="headerlink" title="五、入口"></a>五、入口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String req = <span class="string">"doLogin?"</span></span><br><span class="line">            + <span class="string">"AppID=tom"</span></span><br><span class="line">            + <span class="string">"&amp;Token=xxty6vVxQDuW6r2by9xR29kZRk4="</span></span><br><span class="line">            + <span class="string">"&amp;Timestamp=1578306433558"</span>;</span><br><span class="line"></span><br><span class="line">    ApiAuthenticator authencator = <span class="keyword">new</span> DefaultApiAuthenticatorImpl();</span><br><span class="line">    authencator.auth(req);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码地址：<a href="https://github.com/cmevolve/carryOn/tree/master/AuthforToken" target="_blank" rel="noopener">https://github.com/cmevolve/carryOn/tree/master/AuthforToken</a><br>  [1]: <a href="https://baike.baidu.com/item/%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB" target="_blank" rel="noopener">https://baike.baidu.com/item/%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB</a><br>  [2]: <a href="https://zh.wikipedia.org/wiki/%E7%9B%90_%28%E5%AF%86%E7%A0%81%E5%AD%A6%29" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E7%9B%90_%28%E5%AF%86%E7%A0%81%E5%AD%A6%29</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/04/因使用错误的时间转换导致跨年的时间BUG/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     207 字
	</span>
	<span title="阅读时长">
     1 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/04/因使用错误的时间转换导致跨年的时间BUG/" itemprop="url">因使用错误的时间转换导致跨年的时间BUG</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-04T21:01:42+08:00">
                2020-01-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/04/因使用错误的时间转换导致跨年的时间BUG/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/04/因使用错误的时间转换导致跨年的时间BUG/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  207
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>跨年了闲着无事逛社区的时候发现有好多人在修复BUG，关于YYYY-MM-dd的使用而出现的问题，因此实验一番进行记录防止入坑。</p>
<h2 id="BUG代码"><a href="#BUG代码" class="headerlink" title="BUG代码"></a>BUG代码</h2><p>运行环境JDK1.8<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SimpleDateFormat sf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"YYYY-MM-dd"</span>);</span><br><span class="line">SimpleDateFormat sf1 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">Calendar calendar1 = Calendar.getInstance();</span><br><span class="line">calendar1.add(Calendar.DATE, -<span class="number">4</span>);</span><br><span class="line">System.out.println(sf.format(calendar1.getTime()));</span><br><span class="line">System.out.println(sf1.format(calendar1.getTime()));</span><br><span class="line">--执行结果</span><br><span class="line"><span class="number">2020</span>-<span class="number">12</span>-<span class="number">29</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">12</span>-<span class="number">29</span></span><br></pre></td></tr></table></figure></p>
<h2 id="BUG原因"><a href="#BUG原因" class="headerlink" title="BUG原因"></a>BUG原因</h2><p>YYYY 是 Week-based-year<br>Week-based-year意思是当天所在的周属于的年份，一周从周日开始，周六结束，只要本周跨年，那么这周就算入下一年，例如2019.12.29 是周日，而周三就是跨年了，所以此时29，30，31日使用YYYY获取的时间都是下一年的时间2020年，而使用yyyy就会显示正常的时间2019。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2019/12/12/负载均衡策略问题导致服务宕机（记一次生产问题）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     3.4k 字
	</span>
	<span title="阅读时长">
     13 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/12/负载均衡策略问题导致服务宕机（记一次生产问题）/" itemprop="url">负载均衡策略问题导致服务宕机（记一次生产问题）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-12T23:41:37+08:00">
                2019-12-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/避坑指南/" itemprop="url" rel="index">
                    <span itemprop="name">避坑指南</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/避坑指南/算法与数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">算法与数据结构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/避坑指南/算法与数据结构/计算机网络/" itemprop="url" rel="index">
                    <span itemprop="name">计算机网络</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/12/负载均衡策略问题导致服务宕机（记一次生产问题）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/12/12/负载均衡策略问题导致服务宕机（记一次生产问题）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一-问题"><a href="#一-问题" class="headerlink" title="一.问题"></a>一.问题</h2><p>2019年12月4日上午11点左右收到线上报警，核心服务CPU使用率达到了3000%，看了下进程的线程信息都是active。因为使用的容器是weblogic，所以在console平台查看线程相关信息。<br>信息整理如下：</p>
<ul>
<li>活动线程43个，队列的长度已经到了23个</li>
<li>数据库连接为不可用连接数为5，活动连接数为5，可用连接数为15</li>
<li>线程池 线程空闲指标大部分都是false（暂时不可用）</li>
<li>查看线程池 不可用连接执行操作为请求CAS或者或者请求portal</li>
<li>查看转储线程堆栈,部分异常信息如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"[ACTIVE] ExecuteThread: '2' for queue: 'weblogic.kernel.Default (self-tuning)'"</span> id=<span class="number">34</span> idx=<span class="number">0xec</span> tid=<span class="number">23897</span> prio=<span class="number">5</span> alive, native_blocked, daemon</span><br><span class="line">at java/util/HashMap.put(HashMap.java:<span class="number">468</span>)[optimized]</span><br><span class="line">at org/jasig/cas/client/session/HashMapBackedSessionMappingStorage.addSessionById(HashMapBackedSessionMappingStorage.java:<span class="number">36</span>)[optimized]</span><br><span class="line">at org/jasig/cas/client/session/SingleSignOutFilter.doFilter(SingleSignOutFilter.java:<span class="number">95</span>)[optimized]</span><br><span class="line">at weblogic/servlet/internal/FilterChainImpl.doFilter(FilterChainImpl.java:<span class="number">56</span>)[optimized]</span><br><span class="line">at com/isoftstone/iaeap/web/filter/SetCharacterEncodingFilter.doFilter(SetCharacterEncodingFilter.java:<span class="number">105</span>)[optimized]</span><br><span class="line">at weblogic/servlet/internal/FilterChainImpl.doFilter(FilterChainImpl.java:<span class="number">56</span>)[inlined]</span><br><span class="line">at weblogic/servlet/internal/WebAppServletContext$ServletInvocationAction.wrapRun(WebAppServletContext.java:<span class="number">3730</span>)[inlined]</span><br><span class="line">at weblogic/servlet/internal/WebAppServletContext$ServletInvocationAction.run(WebAppServletContext.java:<span class="number">3696</span>)[optimized]</span><br><span class="line">at weblogic/security/acl/internal/AuthenticatedSubject.doAs(AuthenticatedSubject.java:<span class="number">321</span>)[optimized]</span><br><span class="line">at weblogic/security/service/SecurityManager.runAs(SecurityManager.java:<span class="number">120</span>)[inlined]</span><br><span class="line">at weblogic/servlet/internal/WebAppServletContext.securedExecute(WebAppServletContext.java:<span class="number">2273</span>)[inlined]</span><br><span class="line">at weblogic/servlet/internal/WebAppServletContext.execute(WebAppServletContext.java:<span class="number">2179</span>)[optimized]</span><br><span class="line">at weblogic/servlet/internal/ServletRequestImpl.run(ServletRequestImpl.java:<span class="number">1490</span>)[optimized]</span><br><span class="line">at weblogic/work/ExecuteThread.execute(ExecuteThread.java:<span class="number">256</span>)[optimized]</span><br><span class="line">at weblogic/work/ExecuteThread.run(ExecuteThread.java:<span class="number">221</span>)</span><br><span class="line">at jrockit/vm/RNI.c2java(JJJJJ)V(Native Method)</span><br><span class="line">-- end of trace</span><br><span class="line"><span class="string">"GC Daemon"</span> id=<span class="number">35</span> idx=<span class="number">0xf0</span> tid=<span class="number">23903</span> prio=<span class="number">2</span> alive, waiting, native_blocked, daemon</span><br><span class="line">-- Waiting <span class="keyword">for</span> notification on: sun/misc/GC$LatencyLock@<span class="number">0x51155130</span>[fat lock]</span><br><span class="line">at jrockit/vm/Threads.waitForNotifySignal(JLjava/lang/Object;)Z(Native Method)</span><br><span class="line">at java/lang/Object.wait(J)V(Native Method)</span><br><span class="line">at sun/misc/GC$Daemon.run(GC.java:<span class="number">100</span>)</span><br><span class="line">^-- Lock released <span class="keyword">while</span> waiting: sun/misc/GC$LatencyLock@<span class="number">0x51155130</span>[fat lock]</span><br><span class="line">at jrockit/vm/RNI.c2java(JJJJJ)V(Native Method)</span><br><span class="line">-- end of trace</span><br></pre></td></tr></table></figure>
<p>此时发现熟悉的身影，因为项目引用的是cas-client3.1.3版本的jar包，其中存储session的数据结构是HashMap，且操作时未进行加锁，之前别的核心的小伙伴已经因为多线程环境下触发HashMap扩容死循环问题的BUG宕机过一次，此时看到这里立马确认CPU飙升罪魁祸首是这个jar包。</p>
<p><strong>经过确认，核心一共9台服务器，其中4台为前端应用服务，CPU飙升的服务器正是这4台。</strong></p>
<h2 id="2-曲折"><a href="#2-曲折" class="headerlink" title="2.曲折"></a>2.曲折</h2><p>  当有了一把锤子看什么都是钉子，因为此时心中已经认定是jar导致问题，所以看着服务器的各种异像都觉得符合逻辑。只是心中有些纳闷为何jar包问题这么久了都没有触发HashMap扩容死循环的bug，怎么单单就这次服务重启不过几十分钟CPU就又直线飙升。<br>  在服务器刚重启完的时候此时收到一个信息，有出单员页面部分资源打不开了。开了network跟了下发现部分资源返回404，页面间不涉及到数据加载的页面跳转无异，但是点击查询时页面就会卡死，而此时该进程的CPU也会上升。这个时候就有点诡异，之前的猜测跟目前情形好像并无关联。<br>到了中午使用的人数少了一些抱着病急乱投医，总得做点什么的心态，将jar包更新到3.5升级了上去，经过了几个小时CPU仍然状态稳定，心中长舒了一口气。<br>好景不长，没过多久又有出单员反馈页面卡死问题，此时看了一下线程吓了一跳，多个线程触发GC，后台日志多处报错提示OOM。赶紧看了下源码，发现原来jar包中有一个守护线程来定时触发删除过期的session，而新的jar包去除了此方法，而留了一个clean的方法清理session。猜测到可能是因为没有显式调用该方法导致的内存泄漏，并且并没有解决前端资源丢失加载不出页面，还是紧急将jar包替换了回来，重新查找原因。</p>
<h2 id="3-整理线索"><a href="#3-整理线索" class="headerlink" title="3.整理线索"></a>3.整理线索</h2><h3 id="3-1"><a href="#3-1" class="headerlink" title="3.1"></a>3.1</h3><p>重新梳理了下系统的日志，发现了除了正常的业务流程异常外还有一个异常信息比较可疑。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="number">2019</span>-<span class="number">12</span>-<span class="number">5</span> 下午<span class="number">02</span>时<span class="number">35</span>分<span class="number">41</span>秒 CST&gt; &lt;Error&gt; &lt;HTTP&gt; &lt;BEA-<span class="number">101020</span>&gt; &lt;[ServletContext@<span class="number">199457131</span>[app:pcisv7 <span class="keyword">module</span>:WebRoot path:/pcisv7 spec-version:<span class="number">2.5</span>]] Servlet failed with Exception</span><br><span class="line">java.lang.NullPointerException</span><br><span class="line">	at jsp_servlet._core.__header._jspService(__header.java:<span class="number">295</span>)</span><br><span class="line">	at weblogic.servlet.jsp.JspBase.service(JspBase.java:<span class="number">34</span>)</span><br><span class="line">	at weblogic.servlet.internal.StubSecurityHelper$ServletServiceAction.run(StubSecurityHelper.java:<span class="number">227</span>)</span><br><span class="line">	at weblogic.servlet.internal.StubSecurityHelper.invokeServlet(StubSecurityHelper.java:<span class="number">125</span>)</span><br><span class="line">	at weblogic.servlet.internal.ServletStubImpl.execute(ServletStubImpl.java:<span class="number">301</span>)</span><br><span class="line">	Truncated. see log file <span class="keyword">for</span> complete stacktrace</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>找到了weblogic缓存目录下的文件和测试环境文件比对了下也并没有区别，此文件也没有涉及过开发改动。查看了下源码，找到了一处可能发生空指针的地方：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line"> IUserDetails userDetails = CurrentUser.getUser();</span><br><span class="line"> String operCnm = userDetails.getOpCnm();</span><br><span class="line"> String companyCnm = userDetails.getCompanyCnm();</span><br><span class="line"> <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"> GrtRightService grtRightService =(GrtRightService)SpringUtils.getSpringBean(<span class="string">"grtRightService"</span>);</span><br><span class="line"> List&lt;GrtMenuVO&gt; lstMenuVo=<span class="keyword">null</span>;</span><br><span class="line"> <span class="keyword">try</span>&#123;</span><br><span class="line">   lstMenuVo = grtRightService.getPermissionRootMenus();</span><br><span class="line">   <span class="keyword">if</span>(lstMenuVo ==<span class="keyword">null</span> || lstMenuVo.size()==<span class="number">0</span>)&#123;</span><br><span class="line">	   out.println(<span class="string">"&lt;script type='text/javascript'&gt;parent.window.location ='./common/error/errorinfo.html';&lt;/script&gt;"</span>);</span><br><span class="line">	   <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">   e.printStackTrace();</span><br><span class="line"> &#125;</span><br><span class="line">  String skin = (String)request.getSession().getAttribute(<span class="string">"ISOFTSTONESKIN"</span>);</span><br><span class="line">  String rootPath = request.getContextPath();</span><br><span class="line">  String companyId = userDetails.getCompanyId();</span><br><span class="line">  String[] companyIds =userDetails.getCompanyIds();</span><br><span class="line">  String[] companyCnms =userDetails.getCompanyCnms();</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></p>
<p>17行的skin 中是从session中取值，如果session没有set此处使用会产生空指针，从而导致页面部分资源加载不出来。向上查了一下代码，在session中存放ISOFTSTONESKIN的地方是登陆首页时存放，跳转到目标页面后获取的。查看了下源码ISOFTSTONESKIN的值也是设置的默认值，当时考虑了下并没有考虑到什么场景会导致session中的ISOFTSTONESKIN失效，就在代码中对该变量重新赋值了下。<strong>（其实在这个场景时就已经初步能看出来一些问题，既session丢失问题）</strong></p>
<h3 id="3-2"><a href="#3-2" class="headerlink" title="3.2"></a>3.2</h3><p>因为考虑到是因为CAS登陆导致的使用cas-client jar包产生的CPU使用率问题，考虑了下，决定先将核心模块从cas登陆中拿出，启用spring security验证登陆。<br>applicationContext.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"applicationContext-spring-security.xml"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;import resource="applicationContext-spring-security-cas-ns.xml"/&gt; 启用单点登录时使用些配置文件--&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>重新启动后，CPU使用率正常，header等几个从session取值的页面因为设置了默认值，也暂时没有出现空指针问题。但是出现了使用不到几分钟，就会跳转到登陆页面，提示重新登陆。<strong>(操作的页面没有嵌入别的系统页面，不存在跨系统登陆问题)</strong><br>看了眼核心session失效时间<br>web.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>300<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>顺便看了下CAS的 Ticket超时时间<br>ticketExpirationPolicies.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"grantingTicketExpirationPolicy"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.ticket.support.TimeoutExpirationPolicy"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span>  <span class="attr">value</span>=<span class="string">"7200000"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>CAS的session超时时间<br>web.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>300<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>核心系统客户端的session失效时间设置的半小时，cas的session失效时间是半小时，ticket的票据失效时间是两小时。移除了CAS的认证后半小时内操作是不会登出的，但是实际场景操作过程中就出现跳转到登陆页面的情况。<strong>（session方面的问题愈发明显，但是急于将问题解决，与真相一次次擦肩而过）</strong></p>
<h3 id="3-3"><a href="#3-3" class="headerlink" title="3.3"></a>3.3</h3><p>此时怀疑是网络负载方面的问题，因为系统切换了IPV6考虑到会产生的影响，决定将核心系统加入CAS验证，并且前端节点只开一个处理请求，进行观察。（因负责网络的同事当时不在，只是初步怀疑是IPV6的影响，后续经过确认只改造了公司官网，其余系统并未改造。）<br>开单节点运行了一上午发现CPU稳定，页面加载也再没有出现加载异常，开双节点时就会出现加载异常的情况。由此找到问题原因是负载均衡将客户端X请求转发到某台实例A的时候，由于未知原因将网络请求转发至另一服务器B。导致本应该存在于session的值直接访问另一台服务器时该值并不存在，因为客户端浏览器未关闭的原因，ticket会存在于header头中,转发请求至新的服务时，校验并没有登陆便会去CAS认证一次,但是并不会要求用户重新登陆。<br>负载是由citrix进行硬件方面的负载，它与Nginx软件负载功能类似，只是功能更加强劲，其中大部分的负载策略是一致的。查看了下负载策略使用的是least_conn最小连接数，会话保持时间为两分钟。该策略使用了很长时间都没有问题，考虑到使用iphash会导致服务分部不均，所以未做改动，仅将连接的会话时间修改为了30分钟，同session过期时间保持同步。<strong>（会话时间既将用户请求负载至某一IP，若在会话时间内如果有操作，则会话保持，若没有操作则会话断开，重新请求时将重新对其进行转发）</strong></p>
<h2 id="4-问题总结"><a href="#4-问题总结" class="headerlink" title="4.问题总结"></a>4.问题总结</h2><p>至此问题已经找到了，对于其中相关问题进行分析梳理。</p>
<ol>
<li>因为执行某些操作或者在页面中静止导致两分钟内没有与后台进行交互，再次操作时因为citrix使用最小连接数的策略会将新的请求负载至另一台服务器。</li>
<li>该服务器取出sessionID校验是否通过了登陆验证，浏览器Cookie中并没有缓存该台服务器的sessionID，验证失败，此时重定向请求至CAS服务，因CAS服务只有单台并且该浏览器已经通过了认证，此时访问通过Cookie直接认证通过，跳转到了目标页面。（此时还存在一个场景就是CAS的session也过期了，跳转到单点登录地址，带着ticket参数去验证用户，如果单点登录验证到ticket没过期，就不会去登录页面，但是会刷新当前页，因为从单点登录地址重定向到了当前页面地址。所以使用时的感觉就是长时间不操作时，点击页面元素会出现刷新页面的情况。）</li>
<li>因为在登陆页面中缓存在session中的一些默认值，重新登陆后直接跳转到了目标页面所以并没有缓存，jsp此时加载时就产生了资源丢失，后台报错空指针的情况。</li>
<li>而因为负载频繁的将请求转发，也导致出现了类似大规模登陆的场景（多次去CAS认证，认证通过将session缓存）因为CAS-Client.jar缓存使用的数据结构是HashMap，并且移除和添加缓存操作都没有加锁，导致HashMap出现扩容死循环问题。</li>
</ol>
<h2 id="5-浏览器访问过程"><a href="#5-浏览器访问过程" class="headerlink" title="5.浏览器访问过程"></a>5.浏览器访问过程</h2><p>详细流程：<a href="https://4ark.me/post/b6c7c0a2.html" target="_blank" rel="noopener">https://4ark.me/post/b6c7c0a2.html</a><br>流程图：<br><img src="https://ftp.bmp.ovh/imgs/2019/12/d1ecc658b38ca606.jpg" alt="浏览器访问流程"><br>cas：<a href="https://www.cnblogs.com/notDog/p/5276643.html" target="_blank" rel="noopener">https://www.cnblogs.com/notDog/p/5276643.html</a><br><a href="http://www.voidcn.com/article/p-waqcmlak-bqr.html" target="_blank" rel="noopener">http://www.voidcn.com/article/p-waqcmlak-bqr.html</a></p>
<h2 id="6-内容扩展"><a href="#6-内容扩展" class="headerlink" title="6.内容扩展"></a>6.内容扩展</h2><h3 id="IPV6与IPV4区别：https-blog-51cto-com-7658423-1339259"><a href="#IPV6与IPV4区别：https-blog-51cto-com-7658423-1339259" class="headerlink" title="IPV6与IPV4区别：https://blog.51cto.com/7658423/1339259"></a>IPV6与IPV4区别：<a href="https://blog.51cto.com/7658423/1339259" target="_blank" rel="noopener">https://blog.51cto.com/7658423/1339259</a></h3><h3 id="负载策略"><a href="#负载策略" class="headerlink" title="负载策略"></a>负载策略</h3><ul>
<li>轮询策略（轮询加权/round-robin）：加权轮询带有优先级，按照设置的权值分配请求比例。</li>
<li>ip hash ：针对IP地址hash决定下一请求转发至哪一服务（负载不均问题，使用一致性hash）</li>
<li>最少连接（least_conn) ：下一个请求将被分派到活动连接数量最少的服务器</li>
<li>url hash</li>
<li>随机Random</li>
<li>最短响应时间LRT ：通过ping等方式探测，请求分配给响应时间最短的服务。</li>
</ul>
<h3 id="虚拟IP"><a href="#虚拟IP" class="headerlink" title="虚拟IP"></a>虚拟IP</h3><p>使用一个未分配给真实主机的IP，与真实主机IP，热备主机IP加起来一共三个IP。在以太网中IP地址只是逻辑地址，真正传输的是MAC地址，而每台设备中都有一个ARP缓存，缓存中用来存储同一网络内IP地址和MAC地址对应关系，在向其他主机发送数据时会先从缓存中查询目标IP所对应的MAC地址，拿到MAC地址后向主机发送数据。<br>例如缓存内容：<br>主机A：192.168.0.3 at ec:f4:bb:49:s4:44<br>主机B：192.168.0.4 at ec:f4:bb:49:s5:64<br>虚拟Ip：192.168.0.5 at ec:f4:bb:49:s4:44<br>其中A，B为真实主机，对外提供服务的是A，B为热备，如果A宕机了那么通过心跳检测到A已经发生故障，此时主机B会将自己的ARP缓存发送出去，让路由器修改路由表，告知虚拟地址由A指向B。<br>更新后的缓存内容：<br>主机A：192.168.0.3 at ec:f4:bb:49:s4:44<br>主机B：192.168.0.4 at ec:f4:bb:49:s5:64<br>虚拟Ip：192.168.0.5 at ec:f4:bb:49:s5:64<br>此时再次访问虚拟IP时，机器B会变成主服务器，A降级为热备服务器。这就完成了主从切换，这个过程称之为<strong>IP漂移</strong>。<br>参考：<a href="http://xiaobaoqiu.github.io/blog/2015/04/02/xu-ni-iphe-ippiao-yi/" target="_blank" rel="noopener">http://xiaobaoqiu.github.io/blog/2015/04/02/xu-ni-iphe-ippiao-yi/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2019/11/27/Docker-学习二-容器基本操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     1.7k 字
	</span>
	<span title="阅读时长">
     7 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/27/Docker-学习二-容器基本操作/" itemprop="url">Docker-学习二(容器基本操作)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-27T23:41:37+08:00">
                2019-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker容器/" itemprop="url" rel="index">
                    <span itemprop="name">Docker容器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/27/Docker-学习二-容器基本操作/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/27/Docker-学习二-容器基本操作/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="内容提要"><a href="#内容提要" class="headerlink" title="内容提要"></a>内容提要</h1><p>docker容器相关操作，包括容器启停，查看，删除，创建，导入导出，内存配置等。</p>
<h2 id="1-创建并启动容器"><a href="#1-创建并启动容器" class="headerlink" title="1.创建并启动容器"></a>1.创建并启动容器</h2><h3 id="1-新建容器"><a href="#1-新建容器" class="headerlink" title="1.新建容器"></a>1.新建容器</h3><p>可以使用<strong>docker create</strong>命令新建一个容器，例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker create -it ubuntu:latest</span><br></pre></td></tr></table></figure></p>
<h3 id="2-启动容器"><a href="#2-启动容器" class="headerlink" title="2.启动容器"></a>2.启动容器</h3><p>使用<strong>docker create</strong><br>命令新建的容器处于停止状态需要配合使用<strong>docker start</strong> 命令启动。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start ssf</span><br></pre></td></tr></table></figure></p>
<h3 id="3-新建并启动容器"><a href="#3-新建并启动容器" class="headerlink" title="3.新建并启动容器"></a>3.新建并启动容器</h3><p>可以使用docker run 命令来直接新建并启动容器。（如果本地镜像有则启动，没有则获取最新镜像）<br>这里用ubuntu镜像echo一个hello word<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run ubuntu /bin/echo 'Hello world'</span><br></pre></td></tr></table></figure></p>
<p>下面的命令启动一个bash终端，允许用户进行交互 并在后台运行：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d ubuntu:14.04 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>—P参数是随机指定一个32768～61000的主机端口与容器绑定，而－p则是指定一个端口与容器绑定<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80 nginx:v1.0</span><br></pre></td></tr></table></figure></p>
<h4 id="命令详解"><a href="#命令详解" class="headerlink" title="命令详解"></a>命令详解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">-a, --attach=[]             Attach to STDIN, STDOUT or STDERR</span><br><span class="line">--add-host=[]               Add a custom host-to-IP mapping (host:ip)</span><br><span class="line">--blkio-weight=0            Block IO (relative weight), between 10 and 1000</span><br><span class="line">-c, --cpu-shares=0          CPU shares (relative weight)</span><br><span class="line">--cap-add=[]                Add Linux capabilities</span><br><span class="line">--cap-drop=[]               Drop Linux capabilities</span><br><span class="line">--cgroup-parent=            Optional parent cgroup for the container</span><br><span class="line">--cidfile=                  Write the container ID to the file</span><br><span class="line">--cpu-period=0              Limit CPU CFS (Completely Fair Scheduler) period</span><br><span class="line">--cpu-quota=0               Limit the CPU CFS quota</span><br><span class="line">--cpuset-cpus=              CPUs in which to allow execution (0-3, 0,1)</span><br><span class="line">--cpuset-mems=              MEMs in which to allow execution (0-3, 0,1)</span><br><span class="line">-d, --detach=false          Run container in background and print container ID</span><br><span class="line">--device=[]                 Add a host device to the container</span><br><span class="line">--dns=[]                    Set custom DNS servers</span><br><span class="line">--dns-search=[]             Set custom DNS search domains</span><br><span class="line">-e, --env=[]                Set environment variables</span><br><span class="line">--entrypoint=               Overwrite the default ENTRYPOINT of the image</span><br><span class="line">--env-file=[]               Read in a file of environment variables</span><br><span class="line">--expose=[]                 Expose a port or a range of ports</span><br><span class="line">-h, --hostname=             Container host name</span><br><span class="line">--help=false                Print usage</span><br><span class="line">-i, --interactive=false     Keep STDIN open even if not attached</span><br><span class="line">--init=                     Run container following specified init system container method (systemd)</span><br><span class="line">--ipc=                      IPC namespace to use</span><br><span class="line">-l, --label=[]              Set meta data on a container</span><br><span class="line">--label-file=[]             Read in a line delimited file of labels</span><br><span class="line">--link=[]                   Add link to another container</span><br><span class="line">--log-driver=               Logging driver for container</span><br><span class="line">--log-opt=[]                Log driver options</span><br><span class="line">--lxc-conf=[]               Add custom lxc options</span><br><span class="line">-m, --memory=               Memory limit</span><br><span class="line">--mac-address=              Container MAC address (e.g. 92:d0:c6:0a:29:33)</span><br><span class="line">--memory-swap=              Total memory (memory + swap), &apos;-1&apos; to disable swap</span><br><span class="line">--name=                     Assign a name to the container</span><br><span class="line">--net=bridge                Set the Network mode for the container</span><br><span class="line">--oom-kill-disable=false    Disable OOM Killer</span><br><span class="line">-P, --publish-all=false     Publish all exposed ports to random ports</span><br><span class="line">-p, --publish=[]            Publish a container&apos;s port(s) to the host</span><br><span class="line">--pid=                      PID namespace to use</span><br><span class="line">--privileged=false          Give extended privileges to this container</span><br><span class="line">--read-only=false           Mount the container&apos;s root filesystem as read only</span><br><span class="line">--restart=no                Restart policy to apply when a container exits</span><br><span class="line">--rm=false                  Automatically remove the container when it exits</span><br><span class="line">--security-opt=[]           Security Options</span><br><span class="line">--sig-proxy=true            Proxy received signals to the process</span><br><span class="line">-t, --tty=false             Allocate a pseudo-TTY</span><br><span class="line">-u, --user=                 Username or UID (format: &lt;name|uid&gt;[:&lt;group|gid&gt;])</span><br><span class="line">--ulimit=[]                 Ulimit options</span><br><span class="line">--uts=                      UTS namespace to use</span><br><span class="line">-v, --volume=[]             Bind mount a volume</span><br><span class="line">--volumes-from=[]           Mount volumes from the specified container(s)</span><br><span class="line">-w, --workdir=              Working directory inside the container</span><br></pre></td></tr></table></figure>
<h2 id="2-终止容器"><a href="#2-终止容器" class="headerlink" title="2.终止容器"></a>2.终止容器</h2><h3 id="1-容器终止"><a href="#1-容器终止" class="headerlink" title="1.容器终止"></a>1.容器终止</h3><p>可以使用docker stop来终止运行中的容器，格式为：<br><strong>docker stop[-t|–time[=10]][CONTAINER…]</strong><br>首先会向容器发送SIGTERM信号，等待一段超时时间（默认为 10秒）后，再发送 SIGKILL 信号来终止容器。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop ce5</span><br></pre></td></tr></table></figure></p>
<p>使用 docker kill 命令直接强行终止容器。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker kill ce5</span><br></pre></td></tr></table></figure></p>
<h3 id="2-容器重启"><a href="#2-容器重启" class="headerlink" title="2.容器重启"></a>2.容器重启</h3><p>终止状态的容器可以使用docker start 启动<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start ce5</span><br></pre></td></tr></table></figure></p>
<p>在运行状态的容器可以使用docker restart重启<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart ce5</span><br></pre></td></tr></table></figure></p>
<h2 id="3-进入容器"><a href="#3-进入容器" class="headerlink" title="3.进入容器"></a>3.进入容器</h2><p>进入容器有三种方法，其中主要<strong>推荐使用第一种exec方法</strong>，其他方法了解作用即可。</p>
<h3 id="1-exec命令-重点"><a href="#1-exec命令-重点" class="headerlink" title="1.exec命令(重点)"></a>1.exec命令(<strong>重点</strong>)</h3><p>Docker从1.3.0版本起提供了一个更加方便的exec命令，可以在容器内直接执行任意命令。该命令的基本格式为：<br><strong>docker exec [-d|–detach] [–detach-keys[=[]]] [-i|–interactive] [–privileged]<br>[-t|–tty] [-u|–user[=USER]] CONTAINER COMMAND</strong> [ARG…] 。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 243c32535da7 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>通过指定- it 参数来保持标准输入打开，并且分配一个伪终端。</p>
<h4 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">·-i，--interactive=true| false：打开标准输入接受用户输入命令，默认为false；</span><br><span class="line">·--privileged=true| false：是否给执行命令以高权限，默认为false；</span><br><span class="line">·-t，--tty=true| false：分配伪终端，默认为false；</span><br><span class="line">·- u，--user=&quot;&quot;：执行命令的用户名或ID。</span><br></pre></td></tr></table></figure>
<h3 id="2-attach命令"><a href="#2-attach命令" class="headerlink" title="2.attach命令"></a>2.attach命令</h3><p>命令格式：<strong>docker attach [–detach-keys[=[]]] [–no-stdin] [–sig-proxy[=true]] CONTAINER</strong><br>支持三个主要选项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">·--detach-keys[=[]]：指定退出attach 模式的快捷键序列，默认是 CTRL-p CTRL-q；</span><br><span class="line">·--no-stdin=true| false：是否关闭标准输入，默认是保持打开；</span><br><span class="line">·--sig-proxy=true| false：是否代理收到的系统信号给应用进程，默认为true</span><br></pre></td></tr></table></figure></p>
<p>使用示例：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach myredis</span><br></pre></td></tr></table></figure></p>
<p>当多个窗口同时用attach命令连到同一个容器的时候，所有窗口都会同步显示。当某个窗口因命令阻塞时，其他窗口也无法执行操作了。</p>
<h3 id="3-nsenter工具"><a href="#3-nsenter工具" class="headerlink" title="3.nsenter工具"></a>3.nsenter工具</h3><p>在util-linux 软件包版本2.23+中包含nsenter工具。如果系统中的 util-linux包没有该命令需下载。（略…）</p>
<h3 id="4-容器操作"><a href="#4-容器操作" class="headerlink" title="4. 容器操作"></a>4. 容器操作</h3><p>在容器中操作时，使用ps 报错，是因为ps没有安装在基础wheezy图像。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install procps</span><br></pre></td></tr></table></figure></p>
<p><strong>同样在容器中安装vim等工具时，需要先使用apt-get update 同步一下容器内和服务器的更新源，才可安装。</strong></p>
<h2 id="4-删除容器"><a href="#4-删除容器" class="headerlink" title="4.删除容器"></a>4.删除容器</h2><p>使用docker rm 命令删除处于终止或者退出状态的容器。命令格式为：<strong>docker rm[-f|–force][-l|–link][-v|–volumes]CONTAINER[CONTAINER…]</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm ce554267d7a4</span><br></pre></td></tr></table></figure></p>
<p>默认情况下rm命令只能删除停止或者退出状态的容器，但是可以添加-f参数，将容器kill后强行删除。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm -f ce554267d7a4</span><br></pre></td></tr></table></figure></p>
<p>###相关参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">·- f，--force=false：是否强行终止并删除一个运行中的容器；</span><br><span class="line">·- l，--link=false：删除容器的连接，但保留容器；</span><br><span class="line">·- v，--volumes=false：删除容器挂载的数据卷。</span><br></pre></td></tr></table></figure></p>
<h2 id="5-导入导出容器"><a href="#5-导入导出容器" class="headerlink" title="5.导入导出容器"></a>5.导入导出容器</h2><h3 id="1-导出容器"><a href="#1-导出容器" class="headerlink" title="1.导出容器"></a>1.导出容器</h3><p>命令的格式为 <strong>docker export[-o|– output[=””]]CONTAINER</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker export -o test_for_run.tar ce5</span><br><span class="line"> 或</span><br><span class="line">docker export e81 &gt;test_for_stop.tar</span><br></pre></td></tr></table></figure></p>
<h3 id="2-导入容器"><a href="#2-导入容器" class="headerlink" title="2.导入容器"></a>2.导入容器</h3><p>和导入镜像一样可以使用docker import将tar导入变成镜像，命令格式为：<br><strong>docker import [-c|–change[=[]]] [-m|–message[=MESSAGE]] file|URL|-[REPOSITORY [:TAG]]</strong><br><strong>导入时可以定义标签信息</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker import test_for_run.tar - test/ubuntu:v1.0</span><br></pre></td></tr></table></figure></p>
<p>在使用docker load 导入由docker export保存容器生成的tar时会报异常信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open /var/lib/docker/tmp/docker-import-283259618/repositories: no such file or directory</span><br></pre></td></tr></table></figure></p>
<p><strong>导入容器tar需使用docker import命令</strong></p>
<h2 id="6-容器资源配置"><a href="#6-容器资源配置" class="headerlink" title="6.容器资源配置"></a>6.容器资源配置</h2><p>使用docker stats命令来看当前服务器的内存,针对各个场景对相应容器分配合理内存资源。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stats</span><br></pre></td></tr></table></figure></p>
<p>使用docker的update命令来对内存大小进行管理分配<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update -m 350m  --memory-swap -1  mysqlserver</span><br></pre></td></tr></table></figure></p>
<p><strong>–memory-swap -1</strong> 参数是指不让容器和宿主机进行内存交换<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--automated=true| false：仅显示自动创建的镜像，默认为否；</span><br><span class="line">·--no-trunc=true| false：输出信息不截断显示，默认为否；</span><br><span class="line">·- s，--stars=X：指定仅显示评价为指定星级以上的镜像，默认为0，即输出所有镜像。</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/11/25/csIVayoYXUhRrDp.png" alt="dockerstats.png"></p>
<p>参考资料：Docker技术入门与实战</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2019/11/25/Docker-学习一（镜像基本操作）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     2k 字
	</span>
	<span title="阅读时长">
     8 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/25/Docker-学习一（镜像基本操作）/" itemprop="url">Docker-学习一（镜像基本操作）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-25T23:33:19+08:00">
                2019-11-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker镜像/" itemprop="url" rel="index">
                    <span itemprop="name">Docker镜像</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/25/Docker-学习一（镜像基本操作）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/25/Docker-学习一（镜像基本操作）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  8
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="内容提要"><a href="#内容提要" class="headerlink" title="内容提要"></a>内容提要</h1><p>docker镜像相关操作，包括获取，查看，搜索，删除，创建，存出和载入，上传等。</p>
<h2 id="1-启动"><a href="#1-启动" class="headerlink" title="1.启动"></a>1.启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">servie start docker</span><br></pre></td></tr></table></figure>
<p>为了避免每次使用docker命令都要用特权身份<br>将当前用户加入docker用户组<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker USER_NAME</span><br></pre></td></tr></table></figure></p>
<h2 id="2-获取镜像"><a href="#2-获取镜像" class="headerlink" title="2.获取镜像"></a>2.获取镜像</h2><p>可以使用<strong>docker pull NAME[：TAG]</strong>直接从DockerHub镜像源下载镜像。NAME是镜像仓库名称，TAG是镜像标签（版本信息），例如获取一个Ubuntu14.04系统基本镜像<br>如果不显式指定TAG，则默认会选择latest 标签,这会下载仓库中最新版本的镜像（<em>最新镜像一般非稳定版本</em>）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pulling from library/ubuntu</span><br></pre></td></tr></table></figure></p>
<p>非官方的仓库下载，则需要在仓库名称前指定完整的仓库地址。<br>例如从网易蜂巢的镜像源来下载ubuntu： 14.04 镜像，可以使用如下命令，此<br>时下载的镜像<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull hub.c.163.com/public/ubuntu：14.04</span><br></pre></td></tr></table></figure></p>
<h3 id="子命令详解"><a href="#子命令详解" class="headerlink" title="子命令详解"></a>子命令详解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-a，--all-tags=true| false：是否获取仓库中的所有镜像，默认为否。</span><br></pre></td></tr></table></figure>
<h2 id="3-镜像操作"><a href="#3-镜像操作" class="headerlink" title="3.镜像操作"></a>3.镜像操作</h2><h3 id="1-安装Nginx-并启动"><a href="#1-安装Nginx-并启动" class="headerlink" title="1.安装Nginx 并启动"></a>1.安装Nginx 并启动</h3><p>pull镜像，并启动 -d后台启动 -p宿主机端口映射容器端口。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d -p 80:80 --restart=always nginx:latest</span><br></pre></td></tr></table></figure></p>
<p>此时访问即可80端口即可。</p>
<h3 id="2-images列出镜像"><a href="#2-images列出镜像" class="headerlink" title="2.images列出镜像"></a>2.images列出镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/11/24/eA2lS7NiG5qEugj.png" alt="dockerImages.png"><br>在列出的信息中，可以看到的信息：</p>
<ul>
<li>来自于哪个仓库，比如 ubuntu 仓库用来保存 ubuntu 系列的基础镜像；</li>
<li>镜像的标签信息，比如14.04、latest用来标注不同的版本信息。</li>
<li>镜像的ID（唯一标识镜像）如oracle11g与registry.cn-hangzhou.aliyuncs.com/helowin/oracle_11g镜像ID相同证明实际上指向的是同一镜像。</li>
<li>创建时间，说明镜像最后的更新时间；</li>
<li>镜像大小</li>
</ul>
<p><strong>镜像ID信息十分重要，它标识了镜像。在使用时前若干个字符串来代替完整ID.<br>TAG 信息用来标记来自同一个仓库的不同镜像。通过TAG信息来区分发行版本。</strong></p>
<h4 id="子命令详解-1"><a href="#子命令详解-1" class="headerlink" title="子命令详解"></a>子命令详解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-a，--all=true| false：列出所有的镜像文件（包括临时文件），默认为否；</span><br><span class="line">--digests=true| false：列出镜像的数字摘要值，默认为否</span><br><span class="line">-f，--filter=[]：过滤列出的镜像，如 dangling=true 只显示没有被使用</span><br><span class="line">的镜像；也可指定带有特定标注的镜像等</span><br><span class="line">--format=&quot;TEMPLATE&quot;：控制输出格式，如.ID代表 ID信息，.Repository代表仓库信息等；</span><br><span class="line">-no-trunc=true| false：对输出结果中太长的部分是否进行截断，如镜像的ID 信息，默认为是</span><br><span class="line">-q，--quiet=true|false：仅输出ID信息，默认为否。</span><br><span class="line">更多子命令选项还可以通过 man docker-images 来查看</span><br></pre></td></tr></table></figure>
<h3 id="3-使用tag-命令添加镜像标签"><a href="#3-使用tag-命令添加镜像标签" class="headerlink" title="3.使用tag 命令添加镜像标签"></a>3.使用tag 命令添加镜像标签</h3><p>为了方便在后续工作中使用特定镜像，还可以使用 docker tag命令来为本地镜像任意添加新的标签。例如添加一个新的oracle镜像标签<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/helowin/oracle_11g oracle11g:latest</span><br></pre></td></tr></table></figure></p>
<p>也可以指定镜像ID来修改其标签<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag 5sbdf471761  test/oracle11g:latest</span><br></pre></td></tr></table></figure></p>
<h3 id="4-使用inspect-命令查看详细信息"><a href="#4-使用inspect-命令查看详细信息" class="headerlink" title="4.使用inspect 命令查看详细信息"></a>4.使用inspect 命令查看详细信息</h3><p>使用<strong>docker inspect</strong> 命令可以获取该镜像的详细信息，包括制作者、架构、各层的数字摘要等<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"Id"</span>: <span class="string">"sha256:4152a960875253728e0ba43da37d023e4626c43a268ca0a9c6083119542119fb"</span>,</span><br><span class="line">        <span class="attr">"RepoTags"</span>: [</span><br><span class="line">            <span class="string">"nginx:latest"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"RepoDigests"</span>: [</span><br><span class="line">            <span class="string">"nginx@sha256:9916837e6b165e967e2beb5a586b1c980084d08eb3b3d7f79178a0c79426d880"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"Parent"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"Comment"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"Created"</span>: <span class="string">"2019-11-20T01:15:47.501397881Z"</span>,</span><br><span class="line">        <span class="attr">"Container"</span>: <span class="string">"b976da4ad5a3f13d191cfedd87ab06bc7b3bf0d5eb37876fa091c3aaae572056"</span>,</span><br><span class="line">        <span class="attr">"ContainerConfig"</span>: &#123;</span><br><span class="line">            <span class="attr">"Hostname"</span>: <span class="string">"b976da4ad5a3"</span>,</span><br><span class="line">            <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"ExposedPorts"</span>: &#123;</span><br><span class="line">                <span class="attr">"80/tcp"</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"Env"</span>: [</span><br><span class="line">                <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,</span><br><span class="line">                <span class="string">"NGINX_VERSION=1.17.6"</span>,</span><br><span class="line">                <span class="string">"NJS_VERSION=0.3.7"</span>,</span><br><span class="line">                <span class="string">"PKG_RELEASE=1~buster"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Cmd"</span>: [</span><br><span class="line">                <span class="string">"/bin/sh"</span>,</span><br><span class="line">                <span class="string">"-c"</span>,</span><br><span class="line">                <span class="string">"#(nop) "</span>,</span><br><span class="line">                <span class="string">"CMD [\"nginx\" \"-g\" \"daemon off;\"]"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"ArgsEscaped"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"Image"</span>: <span class="string">"sha256:d96abf34b30211ae8cdb9700ff30dddb3b45ed410bb159fe562ea428b6280851"</span>,</span><br><span class="line">            <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"Labels"</span>: &#123;</span><br><span class="line">                <span class="attr">"maintainer"</span>: <span class="string">"NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"StopSignal"</span>: <span class="string">"SIGTERM"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"DockerVersion"</span>: <span class="string">"18.06.1-ce"</span>,</span><br><span class="line">        <span class="attr">"Author"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"Config"</span>: &#123;</span><br><span class="line">            <span class="attr">"Hostname"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"ExposedPorts"</span>: &#123;</span><br><span class="line">                <span class="attr">"80/tcp"</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"Env"</span>: [</span><br><span class="line">                <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,</span><br><span class="line">                <span class="string">"NGINX_VERSION=1.17.6"</span>,</span><br><span class="line">                <span class="string">"NJS_VERSION=0.3.7"</span>,</span><br><span class="line">                <span class="string">"PKG_RELEASE=1~buster"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Cmd"</span>: [</span><br><span class="line">                <span class="string">"nginx"</span>,</span><br><span class="line">                <span class="string">"-g"</span>,</span><br><span class="line">                <span class="string">"daemon off;"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"ArgsEscaped"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"Image"</span>: <span class="string">"sha256:d96abf34b30211ae8cdb9700ff30dddb3b45ed410bb159fe562ea428b6280851"</span>,</span><br><span class="line">            <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"Labels"</span>: &#123;</span><br><span class="line">                <span class="attr">"maintainer"</span>: <span class="string">"NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"StopSignal"</span>: <span class="string">"SIGTERM"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">        <span class="attr">"Os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"Size"</span>: <span class="number">126346569</span>,</span><br><span class="line">        <span class="attr">"VirtualSize"</span>: <span class="number">126346569</span>,</span><br><span class="line">        <span class="attr">"GraphDriver"</span>: &#123;</span><br><span class="line">            <span class="attr">"Data"</span>: &#123;</span><br><span class="line">                <span class="attr">"LowerDir"</span>: <span class="string">"/var/lib/docker/overlay2/da7346d91a599e73e4d394bb85a467ac618131460f846683aaa596c779b1ea07/diff:/var/lib/docker/overlay2/5c3cf4f87fe4f7f16433918981eb3471b5bc2b23eea1c0883db2d3561b73dd47/diff"</span>,</span><br><span class="line">                <span class="attr">"MergedDir"</span>: <span class="string">"/var/lib/docker/overlay2/6168e5e9a57d684f9c5809e6e4722c73bc2434326d39e90cfcdefe0a1b84999d/merged"</span>,</span><br><span class="line">                <span class="attr">"UpperDir"</span>: <span class="string">"/var/lib/docker/overlay2/6168e5e9a57d684f9c5809e6e4722c73bc2434326d39e90cfcdefe0a1b84999d/diff"</span>,</span><br><span class="line">                <span class="attr">"WorkDir"</span>: <span class="string">"/var/lib/docker/overlay2/6168e5e9a57d684f9c5809e6e4722c73bc2434326d39e90cfcdefe0a1b84999d/work"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Name"</span>: <span class="string">"overlay2"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"RootFS"</span>: &#123;</span><br><span class="line">            <span class="attr">"Type"</span>: <span class="string">"layers"</span>,</span><br><span class="line">            <span class="attr">"Layers"</span>: [</span><br><span class="line">                <span class="string">"sha256:b67d19e65ef653823ed62a5835399c610a40e8205c16f839c5cc567954fcf594"</span>,</span><br><span class="line">                <span class="string">"sha256:de1b802e9897894b1f7e78346beda84dce9ba1c5514f3d479d40bb553bc623f8"</span>,</span><br><span class="line">                <span class="string">"sha256:c2d3130eb3f6afd3ad600119c363e84f33b0d05837de48adf7b638bc66403397"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Metadata"</span>: &#123;</span><br><span class="line">            <span class="attr">"LastTagTime"</span>: <span class="string">"0001-01-01T00:00:00Z"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>返回的是一个json格式的信息，如果要获取其中一项内容可使用-f来指定<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f &#123;&#123;".Architecture"&#125;&#125;</span><br><span class="line">amd64</span><br></pre></td></tr></table></figure></p>
<h3 id="5-使用history-命令查看镜像历史"><a href="#5-使用history-命令查看镜像历史" class="headerlink" title="5.使用history 命令查看镜像历史"></a>5.使用history 命令查看镜像历史</h3><p>例如，查看ubuntu： 14.04 镜像的创建过程，可以使用如下命令：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker history ubuntu:14.04 -- no-trunc</span><br></pre></td></tr></table></figure></p>
<p>过长的命令会被自动截断，可以使用– no-trunc 选项来输出完整命令。</p>
<h3 id="6-搜寻镜像"><a href="#6-搜寻镜像" class="headerlink" title="6.搜寻镜像"></a>6.搜寻镜像</h3><p>查找远端仓库镜像，默认搜索官方仓库镜像<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search --automated -s 10 redis</span><br></pre></td></tr></table></figure></p>
<p>上述命令：查找自动创建评价为10+带redis关键字的镜像<br><img src="https://i.loli.net/2019/11/25/fZMsUl7kmcoe3T8.png" alt="dockerSearch.png"></p>
<h3 id="7-删除镜像"><a href="#7-删除镜像" class="headerlink" title="7.删除镜像"></a>7.删除镜像</h3><h4 id="1-使用标签删除"><a href="#1-使用标签删除" class="headerlink" title="1.使用标签删除"></a>1.使用标签删除</h4><p>命令格式为 docker rmi IMAGE[IMAGE…]，其中IMAGE可以为标签或ID<br>例如删除redis：latest镜像<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi redis:latest</span><br></pre></td></tr></table></figure></p>
<p>当多个标签指向同一镜像文件时，rmi命令只删除该镜像的指定标签。当只有一个镜像标签时使用命令时需注意，此时会删除镜像文件。</p>
<h4 id="2-使用镜像ID删除"><a href="#2-使用镜像ID删除" class="headerlink" title="2.使用镜像ID删除"></a>2.使用镜像ID删除</h4><p>当使用docker rmi 后面跟上了镜像的ID,此时会先删除所有指向该镜像的标签，然后删除镜像。<strong>但是当该镜像创造的容器还存在时，镜像是无法被删除的。</strong><br>如果想强行删除镜像可以使用 -f 参数强制删除一个存在容器依赖的镜像。<strong>但是不推荐这么使用</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi -f redis:4.0</span><br></pre></td></tr></table></figure></p>
<p><strong>正确做法是先找到依赖该镜像的容器依次删除，然后再执行docker rm 命令删除镜像。</strong></p>
<h3 id="8-创建镜像"><a href="#8-创建镜像" class="headerlink" title="8.创建镜像"></a>8.创建镜像</h3><p>创建镜像的方法主要有三种：基于已有镜像的容器创建、基于本地模板<br>导入、基于 Dockerfile 创建。（Dockerfile 方法后续补充）</p>
<h4 id="1-基于已有镜像的容器创建"><a href="#1-基于已有镜像的容器创建" class="headerlink" title="1. 基于已有镜像的容器创建"></a>1. 基于已有镜像的容器创建</h4><p>在原有镜像中进行改动后提交,其中51a551dea4f7为容器ID.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit -m'Add a new file' -a "lfc" 51a551dea4f7 test:0.1</span><br></pre></td></tr></table></figure></p>
<p><strong>子命令</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">·-a，--author=&quot;&quot;：作者信息；</span><br><span class="line">·- c，--change=[]：提交的时候执行 Dockerfile指令，包括CMD|</span><br><span class="line">ENTRYPOINT|ENV|EXPOSE|LABEL|ONBUILD|USER|VOLUME|WORKDIR</span><br><span class="line">等；</span><br><span class="line">·-m，--message=&quot;&quot;：提交消息；</span><br><span class="line">·- p，--pause=true：提交时暂停容器运行。</span><br></pre></td></tr></table></figure></p>
<h4 id="2-基于本地模板导入"><a href="#2-基于本地模板导入" class="headerlink" title="2. 基于本地模板导入"></a>2. 基于本地模板导入</h4><p>使用镜像模版来创建，OPENVZ模板的下载地址为<a href="http://openvz.org/Download/templates/precreated。" target="_blank" rel="noopener">http://openvz.org/Download/templates/precreated。</a><br>命令格式为<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker import[OPTIONS]file|URL| [REPOSITORY[:TAG]]</span><br></pre></td></tr></table></figure></p>
<p>例如下载Ubuntu模版压缩包，之后用命令导入<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ubuntu-14.04-x86_64-minimal.tar.gz | docker import - ubuntu:14.04</span><br></pre></td></tr></table></figure></p>
<h3 id="9-镜像导出和载入"><a href="#9-镜像导出和载入" class="headerlink" title="9.镜像导出和载入"></a>9.镜像导出和载入</h3><h4 id="1-镜像导出"><a href="#1-镜像导出" class="headerlink" title="1.镜像导出"></a>1.镜像导出</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker save -o ubuntu_14.04.tar ubuntu:14.04</span><br><span class="line">或 docker  save nginx &gt;/tmp/nginx.tar.gz</span><br></pre></td></tr></table></figure>
<p>导出本地Ubuntu镜像为文件Ubuntu14，04.tar</p>
<h4 id="2-镜像载入"><a href="#2-镜像载入" class="headerlink" title="2.镜像载入"></a>2.镜像载入</h4><p>可以使用docker load将导出的tar文件导入到本地镜像库，例如<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker load --input ubuntu_14.04.tar</span><br><span class="line">或：</span><br><span class="line">docker load &lt; ubuntu_14.04.tar</span><br></pre></td></tr></table></figure></p>
<h3 id="注："><a href="#注：" class="headerlink" title="注："></a>注：</h3><p>另外 docker load 和 docker import都可以导入一个镜像存储文件， <strong>区别：<br>docker import：丢弃了所有的历史记录和元数据信息，仅保存容器当时的快照状态。在导入的时候可以重新制定标签等元数据信息。<br>docker load：将保存完整记录，体积较大。</strong></p>
<h3 id="10-上传镜像"><a href="#10-上传镜像" class="headerlink" title="10.上传镜像"></a>10.上传镜像</h3><p>使用docker push 命令上传镜像到仓库，默认上传到docker hub官方仓库。<br>命令格式：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push NAME[:TAG] | [REGISTRY_HOST[:REGISTRY_PORT]/]NAME[:TAG]</span><br></pre></td></tr></table></figure></p>
<p>例如将test镜像添加新的标签user/test:latest 然后用docker push 上传镜像。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag test:latest user/test:latest</span><br><span class="line">docker push user/test:latest</span><br></pre></td></tr></table></figure></p>
<p>参考资料：Docker技术入门与实战</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2019/11/21/Ubuntu-安装VNC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     358 字
	</span>
	<span title="阅读时长">
     1 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/21/Ubuntu-安装VNC/" itemprop="url">Ubuntu 安装VNC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-21T23:44:11+08:00">
                2019-11-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/21/Ubuntu-安装VNC/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/21/Ubuntu-安装VNC/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  358
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在用Windows 连接 Ubuntu的PC时想使用下图形化界面，因为之前玩树莓派用过VNC因此将为PC安装VNC 来进行图形传输。</p>
<p>准备工作：<br>windows安装VNC-Viewer 或者相关工具，Linux 安装vncserver.</p>
<h1 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h1><h2 id="1-1更新源和系统"><a href="#1-1更新源和系统" class="headerlink" title="1.1更新源和系统"></a>1.1更新源和系统</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt upgrade -y</span><br></pre></td></tr></table></figure>
<h2 id="1-2安装桌面"><a href="#1-2安装桌面" class="headerlink" title="1.2安装桌面"></a>1.2安装桌面</h2><p>mate 桌面较为精简且不会出现显示不全的问题，选择其中一个安装即可。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apt install ubuntu-desktop, gnome-panel # Gnome桌面</span><br><span class="line">apt install kubuntu-full  # KDE桌面</span><br><span class="line"><span class="meta">#</span> Mate桌面 （推荐）</span><br><span class="line"><span class="meta">#</span> 仅安装核心组件</span><br><span class="line">apt install ntp</span><br><span class="line">apt install ubuntu-mate-core</span><br><span class="line"><span class="meta">#</span> 完整安装</span><br><span class="line">apt install ubuntu-mate-core ubuntu-mate-desktop</span><br></pre></td></tr></table></figure></p>
<h1 id="2-基本操作"><a href="#2-基本操作" class="headerlink" title="2.基本操作"></a>2.基本操作</h1><p>安装 VNC server<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install vnc4server -y</span><br></pre></td></tr></table></figure></p>
<p>第一次启动需要配置密码<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vncserver (或vnc4server)</span><br></pre></td></tr></table></figure></p>
<p>打开会话<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vncserver :1</span><br></pre></td></tr></table></figure></p>
<p>关闭会话<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vncserver -kill :1</span><br></pre></td></tr></table></figure></p>
<p> 设置分辨率<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vncserver -geometry 1920x1080 :1</span><br></pre></td></tr></table></figure></p>
<h1 id="3-文件配置"><a href="#3-文件配置" class="headerlink" title="3.文件配置"></a>3.文件配置</h1><p>vim /root/.vnc<br>添加配置：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/sh</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span> Uncomment the following two lines for normal desktop:</span><br><span class="line"><span class="meta">#</span> unset SESSION_MANAGER</span><br><span class="line"><span class="meta">#</span> exec /etc/X11/xinit/xinitrc</span><br><span class="line">[ -x /etc/vnc/xstartup ] &amp;&amp; exec /etc/vnc/xstartup</span><br><span class="line">[ -r $HOME/.Xresources ] &amp;&amp; xrdb $HOME/.Xresources</span><br><span class="line">xsetroot -solid grey </span><br><span class="line">vncconfig -iconic &amp;</span><br><span class="line"><span class="meta">#</span> x-terminal-emulator -geometry 80x24+10+10 -ls -title "$VNCDESKTOP Desktop" &amp;</span><br><span class="line">        </span><br><span class="line">mate-session &amp;</span><br></pre></td></tr></table></figure></p>
<p>其他桌面配置：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gnome-panel &amp;</span><br><span class="line">gnome-settings-daemon &amp;</span><br><span class="line">metacity &amp;</span><br><span class="line">nautilus &amp;</span><br></pre></td></tr></table></figure></p>
<p>#4.开机启动<br>首先输入 crontab 命令,显示如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Select an editor. To change later, run ‘select-editor’.</span><br><span class="line">1. /bin/ed</span><br><span class="line">2. /bin/nano &lt;---- easiest 3. /usr/bin/vim.basic 4. /usr/bin/vim.tiny Choose 1-4 [2]:</span><br></pre></td></tr></table></figure></p>
<p>在末尾添加命令,设置开机启动<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@reboot /usr/bin/vncserver :1</span><br></pre></td></tr></table></figure></p>
<p>重启服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2019/11/20/接口的幂等性设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     2.6k 字
	</span>
	<span title="阅读时长">
     10 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/20/接口的幂等性设计/" itemprop="url">接口的幂等性设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-20T00:06:06+08:00">
                2019-11-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/20/接口的幂等性设计/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/20/接口的幂等性设计/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  10
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1.概念"></a>1.概念</h1><blockquote>
<p>幂等（idempotent、idempotence）是一个数学与计算机学概念，常见于抽象代数中。<br>在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。例如，“setTrue()”函数就是一个幂等函数,无论多次执行，其结果都是一样的.更复杂的操作幂等保证是利用唯一交易号(流水号)实现.          ——————【维基百科】</p>
</blockquote>
<p>简单来说就是 <strong>一个操作如果执行多次，其产生的影响均与一次执行的影响相同。</strong></p>
<h1 id="2-为什么要做幂等"><a href="#2-为什么要做幂等" class="headerlink" title="2.为什么要做幂等"></a>2.为什么要做幂等</h1><p>分布式场景：</p>
<ul>
<li>一个订单创建接口，在第一次调用时超时。</li>
<li>订单创建时，要先减去库存，调用接口时发生了超时。</li>
<li>订单开始支付，支付请求发出了之后，在到达微信支付前就发生超时。</li>
<li>到达微信支付，但是支付交易失败，未返回，此时超时。</li>
<li>到达微信支付且交易成功，未返回回执，此时超时。</li>
<li>到达微信支付并且交易成功，返回了回执，客户端未接收到回执此时客户端超时。</li>
<li>订单支付成功，调用订单状态更新接口，调用方发送了两条消息，一个是已创建，一个是已付款，如果先收到已付款消息后收到已创建。</li>
</ul>
<p><strong>幂等性在购物支付场景下显得尤为重要，我请求了多次是否会产生了多笔订单，是否引发了多次支付？</strong><br>为了解决这些问题，就必须保证API的幂等性，也就是接口可重复调用，接口最终结果是与一次调用时一致。（这里说的是数据一致性，不是返回结果一致性，如：已提交订单，再次提交提示请勿重复提交，但是数据结果与第一次调用时一致）</p>
<h1 id="3-幂等如何实现"><a href="#3-幂等如何实现" class="headerlink" title="3.幂等如何实现"></a>3.幂等如何实现</h1><p>具体方案有：业务去重表（建立唯一索引）、悲观锁、乐观锁（版本控制、有限状态机验证）、Token（全局唯一标识）、分布式锁、select+insert、</p>
<h2 id="3-1-Token-全局唯一标识"><a href="#3-1-Token-全局唯一标识" class="headerlink" title="3.1 Token(全局唯一标识)"></a>3.1 Token(全局唯一标识)</h2><p><img src="https://i.loli.net/2019/11/04/srAzcduVxBUCnZR.png" alt="流程 _1_.png"></p>
<ul>
<li>在数据提交前向服务申请token，token放到redis或者内存中（加入失效时间）；在提交时后台校验token，同时删除token，生成新的token返回。（<strong>此处校验token和删除token为原子性操作，，如果分为两步，存在并发问题。</strong>）</li>
<li>全局唯一标识原理与之类似，根据操作类型和业务标识组合生成一个全局ID，执行操作前判断是否已存在该key，如果不存在则存储到系统中，存在则表示该方法已操作。（<strong>利用Redis的setnx命令。此命令同样是原子性操作，只有在key不存在的情况下，才能set成功。</strong>）</li>
</ul>
<h2 id="3-2-唯一索引"><a href="#3-2-唯一索引" class="headerlink" title="3.2 唯一索引"></a>3.2 唯一索引</h2><p>在CRUD中查询和删除（物理删除、逻辑删除）是天然的幂等的，既多次查询对数据与一次查询一致不会产生影响，删除也是无论是物理删除还是逻辑删除，都是根据条件进行删除无论执行几次造成的结果是一样的。<br>增加数据时如果不进行幂等会导致目标数据产生多条，此时建议将目标表增加唯一索引或者唯一组合索引防止脏数据，在重复进行执行时，插入失败时，重新查询数据此时已存在则成功返回。</p>
<h2 id="3-3-数据库悲观锁"><a href="#3-3-数据库悲观锁" class="headerlink" title="3.3 数据库悲观锁"></a>3.3 数据库悲观锁</h2><p>获取数据时加锁<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table_xxx <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'xxx'</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure></p>
<p><strong>使用时ID需要是主键或者唯一索引，在mysql中会导致锁表而不是行级锁。悲观锁使用一般同事务一起使用。</strong></p>
<h2 id="3-4-数据库乐观锁"><a href="#3-4-数据库乐观锁" class="headerlink" title="3.4 数据库乐观锁"></a>3.4 数据库乐观锁</h2><p>乐观锁在更新数据时才会产生锁表，其他时间不锁表，所以对比悲观锁，乐观锁并发场景使用效率更高。<br>实现方式：<br>原理如图：同java CAS<br><img src="https://i.loli.net/2019/11/03/rLB2RXT4YS13Msq.png" alt="image.png"></p>
<ol>
<li><p>通过版本号或者状态条件实现</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> table_xxx <span class="keyword">set</span> <span class="keyword">name</span>=<span class="comment">#name#,version=version+1 where version=#version#  and id=#id#;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过条件限制</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> table_xxx <span class="keyword">set</span> avai_amount=avai_amount-<span class="comment">#subAmount# where avai_amount-#subAmount# &gt;= 0 and id=#id#;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>此场景适用于秒杀等库存场景，防止因并发出现库存-1场景。</p>
<ol start="3">
<li>任务相关的业务，肯定会涉及到状态机（状态变更），业务数据在不同情况下回发生变更，一般情况下存在有限状态机，如果状态机位于下一个状态，此时来了一个上一个状态的变更，此时不能变更，从而保证有限状态机的幂等。<br>例：订单创建为0，付款成功为2，付款失败为1在进行状态机更新时可以这样控制<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update table_xx set status=#status# where id=#id# and status&lt;#status#</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果此次操作成功该update返回结果为1条，若数据已被更新则返回结果为0条，可再次查询验证更新状态是否成功。</p>
<h2 id="3-5-select-insert"><a href="#3-5-select-insert" class="headerlink" title="3.5 select + insert"></a>3.5 select + insert</h2><p>对并发不高的系统，为了支持幂等可以先查询下数据判断是否已经执行过，未执行则进行业务的处理。<strong>注：此种方法高并发场景切不可使用</strong></p>
<h2 id="3-6-业务去重表"><a href="#3-6-业务去重表" class="headerlink" title="3.6 业务去重表"></a>3.6 业务去重表</h2><p>上面几种通过数据库进行幂等的方法有一个弊端，就是为了实现幂等性需要在业务表中加入一个无关的版本号或者状态，此时可将操作单独提取出来构建一个业务去重表，在业务表操作前对此表进行操作验证，利用数据库唯一索引特性保证唯一逻辑，唯一的序列号可以是一个字段，也可以是多字段的唯一性组合，在幂等验证通过后方可进行业务操作。<br>表结构:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> DUPLICATEREMOVAL(</span><br><span class="line">  c_id          VARCHAR2(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">  c_serial_no   VARCHAR2(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">  c_source_type VARCHAR2(<span class="number">255</span>),</span><br><span class="line">  c_status      VARCHAR2(<span class="number">64</span>),</span><br><span class="line">  c_remark      VARCHAR2(<span class="number">255</span>),</span><br><span class="line">  c_crt_cde     VARCHAR2(<span class="number">20</span>) ,</span><br><span class="line">  t_crt_tm      <span class="built_in">DATE</span> ,</span><br><span class="line">  c_upd_cde     VARCHAR2(<span class="number">20</span>),</span><br><span class="line">  t_upd_tm      <span class="built_in">DATE</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- Add comments to the table </span></span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">table</span> DUPLICATEREMOVAL</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'业务去重表'</span>;</span><br><span class="line"><span class="comment">-- Add comments to the columns </span></span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> DUPLICATEREMOVAL.c_id</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'业务标识'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> DUPLICATEREMOVAL.c_serial_no</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'唯一标识'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> DUPLICATEREMOVAL.c_source_type</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'资源类型'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> DUPLICATEREMOVAL.c_status</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'状态'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> DUPLICATEREMOVAL.c_remark</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'备注'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> DUPLICATEREMOVAL.c_crt_cde</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'创建人'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> DUPLICATEREMOVAL.t_crt_tm</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'创建时间'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> DUPLICATEREMOVAL.c_upd_cde</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'修改人'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> DUPLICATEREMOVAL.t_upd_tm</span><br><span class="line">  <span class="keyword">is</span> <span class="string">'修改时间'</span>;</span><br><span class="line"><span class="comment">-- Create/Recreate primary, unique and foreign key constraints </span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> DUPLICATEREMOVAL</span><br><span class="line">  <span class="keyword">add</span> <span class="keyword">constraint</span> C_PK_SERIAL <span class="keyword">unique</span> (C_ID, C_SERIAL_NO);</span><br></pre></td></tr></table></figure></p>
<h2 id="3-7-分布式锁"><a href="#3-7-分布式锁" class="headerlink" title="3.7 分布式锁"></a>3.7 分布式锁</h2><p>在分布式应用的时代背景下，跨系统的调用想满足锁的语义只能依赖于第三方的中间件，比如redis、zookeeper。<br><strong>实现点：某个流程要求不能并发执行，可以在执行之前根据业务上的唯一标识 获取分布式锁，其他流程执行时获取锁就会失败，也就是同一时间该流程只能有一个能执行成功，执行完后，释放分布式锁。</strong></p>
<p>使用方式：<br><a href="http://doc.redisfans.com/string/set.html" target="_blank" rel="noopener">API文档</a><br>加锁：set key value px milliseconds nx<br>键不存在时才进行操作并设置键的过期时间，此命令是原子操作不会出现多线程问题。<br><img src="https://i.loli.net/2019/11/04/xMF3z4y7VKg5L2Q.png" alt="加锁流程.png"><br>释放锁：在释放锁时为了防止将别的线程加的锁误删可以在加锁时将线程id作为value，解锁时判断是否是当前锁，然后删除。但是判断和释放锁是两个独立的操作不具备原子性所以此处推荐使用del+lua脚本实现。<br><a href="https://ftp.bmp.ovh/imgs/2019/11/a79904d25d081716.png" target="_blank" rel="noopener">https://ftp.bmp.ovh/imgs/2019/11/a79904d25d081716.png</a><br><img src="https://s2.ax1x.com/2019/11/04/KzrM8S.png" alt="解锁流程.png"><br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String luaScript = <span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line">redisClient.eval(luaScript , Collections.singletonList(key), Collections.singletonList(threadId));</span><br></pre></td></tr></table></figure></p>
<p>分布式锁参考：<a href="https://wudashan.cn/2017/10/23/Redis-Distributed-Lock-Implement/" target="_blank" rel="noopener">使用 px nx 加锁</a><br>扩展：<a href="https://blog.csdn.net/forezp/article/details/70305336" target="_blank" rel="noopener">redis官方支持的分布式锁redlock</a></p>
<h1 id="4-基于redis实现分布式锁"><a href="#4-基于redis实现分布式锁" class="headerlink" title="4.基于redis实现分布式锁"></a>4.基于redis实现分布式锁</h1><h2 id="4-1-核心加锁代码："><a href="#4-1-核心加锁代码：" class="headerlink" title="4.1 核心加锁代码："></a>4.1 核心加锁代码：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SET IF NOT EXIST key不存在时，set</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SET_IF_NOT_EXIST = <span class="string">"NX"</span>;</span><br><span class="line"><span class="comment">//expx 超时时间 单位毫秒  EX 单位 秒</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SET_WITH_EXPIRE_TIME = <span class="string">"PX"</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryGetDistributedLock</span><span class="params">( String lockKey, String requestId , <span class="keyword">int</span> expireTime)</span> </span>&#123;</span><br><span class="line">    Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        jedis = getJedis();</span><br><span class="line">        String result = jedis.set(lockKey, requestId , SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, expireTime);</span><br><span class="line">        <span class="keyword">if</span> (LOCK_SUCCESS.equals(result)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">"set key:&#123;&#125; value:&#123;&#125; error"</span>, lockKey, requestId , e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        close(jedis);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用NX PX 来保证插入值时的原子性<br>NX，意思是SET IF NOT EXIST，即当key不存在时，我们进行set操作；若key已经存在，则不做任何操作；<br>PX，意思是我们要给这个key加一个过期设置。<br><strong>错误使用：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">wrongGetLock1</span><span class="params">(Jedis jedis, String lockKey, String requestId, <span class="keyword">int</span> expireTime)</span> </span>&#123;</span><br><span class="line">    Long result = jedis.setnx(lockKey, requestId);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 若在这里程序突然崩溃，则无法设置过期时间，将发生死锁</span></span><br><span class="line">        jedis.expire(lockKey, expireTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码是将赋值的操作分为两步，先设置值，成功了再设置超时时间，但是如果在未设置超时时间前程序崩溃，此处会形成死锁。</p>
<h2 id="4-2-解锁代码："><a href="#4-2-解锁代码：" class="headerlink" title="4.2 解锁代码："></a>4.2 解锁代码：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">releaseDistributedLock</span><span class="params">(Jedis jedis, String lockKey, String requestId)</span> </span>&#123;</span><br><span class="line">    String script = <span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line">    Object result = jedis.eval(script, Collections.singletonList(lockKey), Collections.singletonList(requestId));</span><br><span class="line">    <span class="keyword">if</span> (RELEASE_SUCCESS.equals(result)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用lua脚本将解锁时判断如果获取的key = 目标值则执行后续的操作，保证比较并操作行为的原子性。<br><strong>错误代码：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">wrongReleaseLock2</span><span class="params">(Jedis jedis, String lockKey, String requestId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断加锁与解锁是不是同一个客户端</span></span><br><span class="line">    <span class="keyword">if</span> (requestId.equals(jedis.get(lockKey))) &#123;</span><br><span class="line">        <span class="comment">// 若在此时，这把锁突然不是这个客户端的，则会误解锁</span></span><br><span class="line">        jedis.del(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果经过上面比较判断后，此时锁因为超时已经过期了，在执行后面的del命令时可能会删除别的进程（线程）加的锁。</p>
<p>代码地址：<a href="https://github.com/cmevolve/InterfaceIdempotent" target="_blank" rel="noopener">https://github.com/cmevolve/InterfaceIdempotent</a><br>参考资料：<a href="https://wudashan.cn/2017/10/23/Redis-Distributed-Lock-Implement/" target="_blank" rel="noopener">https://wudashan.cn/2017/10/23/Redis-Distributed-Lock-Implement/</a></p>
<h1 id="5-代码测试（工具扩展）"><a href="#5-代码测试（工具扩展）" class="headerlink" title="5.代码测试（工具扩展）"></a>5.代码测试（工具扩展）</h1><p>压力测试工具：<a href="https://www.cnblogs.com/stulzq/p/8971531.html" target="_blank" rel="noopener">JMeter</a><br>性能分析工具：<a href="http://www.ddooo.com/softdown/150941.htm#dltab" target="_blank" rel="noopener">JProfiler</a> <a href="https://segmentfault.com/a/1190000017795841" target="_blank" rel="noopener">基本使用手册</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzU2MTI4MjI0MQ==&amp;mid=2247486515&amp;idx=1&amp;sn=fa09c3790d85a54683ec0208c077bbb6&amp;chksm=fc7a619dcb0de88b7ef2c27632f05d8414adeaa6721c6410df9cf2de7f268c38c725e549a33e&amp;mpshare=1&amp;scene=24&amp;srcid=1102HmJLce0mjnZn6WS0nmh7&amp;sharer_sharetime=1572669522564&amp;sharer_shareid=b85a2e91deba228c5ba2c72863129902&amp;key=3e754fdb358244867276411b1d091f79586fdaa28ae7a2d4dfbb4626ed502ee7fcb21ead7a462d3a3c79e7f374aea7a67334d07ec6821c599a948dbd439ad67e819093dbc397c033b7ca6683baea7fed&amp;ascene=14&amp;uin=NTUxNjkzNDU1&amp;devicetype=Windows%2010&amp;version=62070152&amp;lang=zh_CN&amp;pass_ticket=ZpgRpjustSAK02Y%2bDhuafqaYqoPFsLeDK4oj6v4MXd5W3fKHyTSYXIryKYAP6wD0" target="_blank" rel="noopener">Springboot+redis+注解+拦截器</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/nini.png" alt="李斯大炮">
            
              <p class="site-author-name" itemprop="name">李斯大炮</p>
              <p class="site-description motion-element" itemprop="description">我从不相信什么懒洋洋的自由，我向往的自由是通过勤奋和努力实现更广阔的人生，那样的自由才是珍贵的、有价值的。我相信一万小时定律，我从来不相信天上掉馅饼的灵感和坐等的成就。做一个自由又自律的人，靠势必实现的决心认真地活着。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/cmevolve/" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:lisidapao@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/lisidapao?t=1" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-globe"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.baidu.com" title="基情资词" target="_blank">基情资词</a>
                  </li>
                
              </ul>
            </div>
          
			<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=28138493&auto=1&height=66"></iframe>
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李斯大炮</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    

  




	





  





  











  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
