<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="我从不相信什么懒洋洋的自由，我向往的自由是通过勤奋和努力实现更广阔的人生，那样的自由才是珍贵的、有价值的。我相信一万小时定律，我从来不相信天上掉馅饼的灵感和坐等的成就。做一个自由又自律的人，靠势必实现的决心认真地活着。">
<meta property="og:type" content="website">
<meta property="og:title" content="邪恶小代码">
<meta property="og:url" content="http://iamlfc.top/index.html">
<meta property="og:site_name" content="邪恶小代码">
<meta property="og:description" content="我从不相信什么懒洋洋的自由，我向往的自由是通过勤奋和努力实现更广阔的人生，那样的自由才是珍贵的、有价值的。我相信一万小时定律，我从来不相信天上掉馅饼的灵感和坐等的成就。做一个自由又自律的人，靠势必实现的决心认真地活着。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="邪恶小代码">
<meta name="twitter:description" content="我从不相信什么懒洋洋的自由，我向往的自由是通过勤奋和努力实现更广阔的人生，那样的自由才是珍贵的、有价值的。我相信一万小时定律，我从来不相信天上掉馅饼的灵感和坐等的成就。做一个自由又自律的人，靠势必实现的决心认真地活着。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://iamlfc.top/">





  <title>邪恶小代码</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">邪恶小代码</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/30/Docker学习六-操作系统使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     1.6k 字
	</span>
	<span title="阅读时长">
     6 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/30/Docker学习六-操作系统使用/" itemprop="url">Docker学习六 (操作系统使用)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-30T22:53:46+08:00">
                2020-01-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker镜像/" itemprop="url" rel="index">
                    <span itemprop="name">Docker镜像</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/30/Docker学习六-操作系统使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/30/Docker学习六-操作系统使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>利用docker安装和使用BusyBox、Alphine、Debian/Ubuntu、CentOS/Fedora等操作系统</p>
<h2 id="一、系统列表"><a href="#一、系统列表" class="headerlink" title="一、系统列表"></a>一、系统列表</h2><h3 id="官方镜像大小比较"><a href="#官方镜像大小比较" class="headerlink" title="官方镜像大小比较"></a>官方镜像大小比较</h3><p><table><br>   <tr><br>      <td>REPOSITORY</td><br>      <td>TAG </td><br>      <td>IMAGE ID</td><br>      <td>VIRTUAL SIZE</td><br>   </tr><br>   <tr><br>      <td>alpine</td><br>      <td>latest </td><br>      <td>e7d92cdc71fe</td><br>      <td>5.59MB</td><br>   </tr><br>    <tr><br>      <td>debian</td><br>      <td>latest </td><br>      <td>b5d2d9b1597b</td><br>      <td>114MB</td><br>   </tr><br>    <tr><br>      <td>busybox</td><br>      <td>latest </td><br>      <td>6d5fcfe5ff17</td><br>      <td>1.22MB</td><br>   </tr><br>    <tr><br>      <td>ubuntu</td><br>      <td>latest </td><br>      <td>775349758637</td><br>      <td>64MB</td><br>   </tr><br>   <tr><br>      <td>centos</td><br>      <td>latest </td><br>      <td>470671670cac</td><br>      <td>237MB</td><br>   </tr><br></table></p>
<h3 id="BusyBox"><a href="#BusyBox" class="headerlink" title="BusyBox"></a>BusyBox</h3><blockquote>
<p>BusyBox是一个集成了一百多个最常用Linux命令和工具（如cat、echo、grep、mount、telnet等）的精简工具箱，它只有几MB的大小，很方便进行各种快速验证，被誉为“Linux系统的瑞士军刀”。BusyBox可运行于多款POSIX环境的操作系统中，如Linux（包括Android）、Hurd、FreeBSD等。</p>
</blockquote>
<p>下载镜像，镜像大小仅为1.22MB<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull busybox:latest</span><br></pre></td></tr></table></figure></p>
<p>启动一个 busybox 容器，并在容器内查看挂载信息，如下所示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run  –it busybox </span><br><span class="line">mount</span><br></pre></td></tr></table></figure></p>
<h3 id="Alpine"><a href="#Alpine" class="headerlink" title="Alpine"></a>Alpine</h3><blockquote>
<p>Alpine 操作系统是一个面向安全的轻型Linux发行版。它不同于通常的Linux发行版，Alpine采用了musllibc和BusyBox以减小系统的体积和运行时资源消耗，但功能上比BusyBox又完善得多，因此得到开源社区越来越多的青睐。在保持瘦身的同时，Alpine还提供了自己的包管理工具apk，可以通过<a href="https://pkgs.alpinelinux.org/packages查询包信息，也可以通过apk" target="_blank" rel="noopener">https://pkgs.alpinelinux.org/packages查询包信息，也可以通过apk</a> 命令直接查询和安装各种软件。</p>
</blockquote>
<p>下载镜像，镜像大小 5MB 左右<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run alpine ;</span><br></pre></td></tr></table></figure></p>
<h3 id="Debian"><a href="#Debian" class="headerlink" title="Debian"></a>Debian</h3><blockquote>
<p>Debian是由GPL和其他自由软件许可协议授权的自由软件组成的操作系统，由DebianProject组织维护。Debian计划是一个独立、分散的组织，由3000个志愿者组成，接受世界多个非盈利组织的资金支持，Software in the Public Interest提供支持并持有商标作为保护机构。Debian以其坚守 Unix和自由软件的精神，以及给予用户的众多选择而闻名。现在Debian 包括了超过25000个软件包并支持12个计算机系统结构。</p>
</blockquote>
<p>下载镜像，镜像大小 114MB<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search debian</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Ubuntu基于Debian发行版和GNOME桌面环境，与Debian的不同在于它每6个月会发布一个新版本（即每年的四月与十月），每2年发布一个LTS长期支持版本。<br>普通的桌面版可以获得发布后18个月内的支持，标为LTS（长期支持）的桌面版可以获得更长时间的支持。例如，Ubuntu 8.04 LTS（代号Hardy Heron），其桌面应用系列可以获得为期3年的技术支持，服务器版可以获得为期5年的技术支持[16]。而自Ubuntu 12.04 LTS开始，桌面版和服务器版均可获得为期5年的技术支持。2013年3月有消息指出，Ubuntu计划在4月25日Ubuntu13.04发布后，将非LTS版本的支持时间自18个月缩短至9个月，并采用滚动发布模式，允许开发者在不升级整个发行版的情况下升级单个核心包。<br>Ubuntu的目标在于为一般用户提供一个最新同时又相当稳定，主要以自由软件建构而成的操作系统。Ubuntu当前具有庞大的社群力量支持，用户可以方便地从社群获得帮助。</p>
</blockquote>
<p>搜索被收藏10次以上的镜像<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search -s 10 ubuntu</span><br></pre></td></tr></table></figure></p>
<p>下载镜像并启动容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -ti ubuntu:14.04 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>当试图直接使用 apt-get 安装一个软件的时候，会提示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E： Unable to locate package：</span><br></pre></td></tr></table></figure></p>
<p>这并非系统不支持apt-get命令。Docker镜像在制作时为了精简清除了 apt仓库信息，因此需要先执行 apt-get update 命令来更新仓库信息。更新信息后即可成功通过 apt-get 命令来安装软件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure></p>
<p>安装curl工具：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install curl -y</span><br></pre></td></tr></table></figure></p>
<h3 id="CentOS-Fedora"><a href="#CentOS-Fedora" class="headerlink" title="CentOS/Fedora"></a>CentOS/Fedora</h3><p>CentOS和Fedora都是基于Redhat的常见Linux分支。CentOS是目前企业级服务器的常用操作系统；Fedora则主要面向个人桌面用户。</p>
<blockquote>
<p>CentOS（Community Enterprise Operating System，社区企业操作系统）是基于Red Hat Enterprise Linux 源代码编译而成的。由于 CentOS与Redhat Linux源于相同的代码基础，所以很多成本敏感且需要高稳定的公司就使用CentOS 来替代商业版 Red Hat Enterprise Linux。CentOS自身不包含闭源软件。</p>
</blockquote>
<p>下载镜像并启动容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it centos bash</span><br></pre></td></tr></table></figure></p>
<h3 id="Fedora"><a href="#Fedora" class="headerlink" title="Fedora"></a>Fedora</h3><blockquote>
<p>Fedora是由Fedora Project 社区开发，红帽公司赞助的 Linux 发行版。它的目标是创建一套新颖、多功能并且自由和开源的操作系统。对用户而言，Fedora是一套功能完备的、可以更新的免费操作系统，而对赞助商 Red Hat而言，它是许多新技术的测试平台，被认为可用的技术最终会加入到 Red Hat Enterprise Linux中</p>
</blockquote>
<p>下载镜像并启动容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it fedora bash</span><br></pre></td></tr></table></figure></p>
<h2 id="二、镜像添加SSH服务"><a href="#二、镜像添加SSH服务" class="headerlink" title="二、镜像添加SSH服务"></a>二、镜像添加SSH服务</h2><p>之前使用了一些进入容器的方法，比如attach、exec等命令，但是这些命令没办法远程管理容器。所以如果需要远程管理就需要使用SSH。</p>
<h3 id="1-准备"><a href="#1-准备" class="headerlink" title="1.准备"></a>1.准备</h3><p>使用ubuntu镜像创建一个容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 10022:22 -it ubuntu /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>更新apt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-安装并配置SSH服务"><a href="#2-安装并配置SSH服务" class="headerlink" title="2.安装并配置SSH服务"></a>2.安装并配置SSH服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install openssh-server –y;</span><br></pre></td></tr></table></figure>
<p>如果需要正常启动 SSH 服务，则目录/ var/run/sshd 必须存在。手动创建它，并启动 SSH 服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/run/sshd</span><br><span class="line"> /usr/sbin/sshd -D &amp;</span><br></pre></td></tr></table></figure></p>
<p>安装netstat<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install net-tools</span><br></pre></td></tr></table></figure></p>
<p>此时查看容器的22端口（SSH默认监听端口）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@b01f068b0cff:/# netstat -tunlp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      3845/sshd           </span><br><span class="line">tcp6       0      0 :::22                   :::*                    LISTEN      3845/sshd</span><br></pre></td></tr></table></figure></p>
<p>重设密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">passwd</span><br><span class="line">  新密码</span><br><span class="line">  确认新密码</span><br><span class="line">#如提示没有passwd这个命令行使用yum install passwd安装</span><br></pre></td></tr></table></figure></p>
<p>修改SSH配置文件以下选项，去掉#注释，将四个选项启用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure></p>
<ul>
<li>RSAAuthentication yes #启用 RSA 认证</li>
<li>PubkeyAuthentication yes #启用公钥私钥配对认证方式</li>
<li>AuthorizedKeysFile .ssh/authorized_keys #公钥文件路径（和上面生成的文件同）</li>
<li>PermitRootLogin yes #root能使用ssh登录</li>
</ul>
<p>此时在宿主机上或者别的主机上可使用ssh连接容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh 192.168.1.23 -p 10022</span><br></pre></td></tr></table></figure></p>
<p>创建自动启动SSH服务的可执行文件run.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /run.sh</span><br><span class="line">#内容如下</span><br><span class="line">#!/bin/bash</span><br><span class="line">/usr/sbin/sshd -D</span><br></pre></td></tr></table></figure></p>
<p>添加可执行权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x run.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="3-保存并使用镜像"><a href="#3-保存并使用镜像" class="headerlink" title="3.保存并使用镜像"></a>3.保存并使用镜像</h3><p>退出容器保存镜像<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit;</span><br><span class="line">docker commit saf3fsd9 sshd:ubuntu</span><br></pre></td></tr></table></figure></p>
<p>启动新镜像启动容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 10022:22 -d sshd:ubuntu /run.sh</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/30/Docker-学习五-Mysql多实例安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     1.2k 字
	</span>
	<span title="阅读时长">
     5 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/30/Docker-学习五-Mysql多实例安装/" itemprop="url">Docker-学习五(Mysql多实例安装)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-30T20:50:14+08:00">
                2020-01-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker镜像/" itemprop="url" rel="index">
                    <span itemprop="name">Docker镜像</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/30/Docker-学习五-Mysql多实例安装/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/30/Docker-学习五-Mysql多实例安装/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、数据卷准备"><a href="#一、数据卷准备" class="headerlink" title="一、数据卷准备"></a>一、数据卷准备</h2><h3 id="1-创建数据卷"><a href="#1-创建数据卷" class="headerlink" title="1.创建数据卷"></a>1.创建数据卷</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker volume create mysql_dbdata</span><br><span class="line">docker volume ls # 查看</span><br><span class="line">docker volume inspect mysql_dbdata</span><br></pre></td></tr></table></figure>
<p>删除数据卷<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> docker rm -v &lt;container_id&gt; # 删除容器及关联</span><br><span class="line"><span class="meta">$</span> docker volume rm &lt;volume_name&gt; # 删除数据卷</span><br></pre></td></tr></table></figure></p>
<h3 id="2-创建数据卷容器"><a href="#2-创建数据卷容器" class="headerlink" title="2.创建数据卷容器"></a>2.创建数据卷容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v mysql_dbdata:/var/lib/mysql/ --name mysql_dbdata ubuntu</span><br></pre></td></tr></table></figure>
<p>默认-v 挂载的是匿名数据卷，可先创建数据卷指定名称，再挂载到宿主机本地目录。  <strong>“:”前为数据卷名称，后面为宿主机地址。</strong>（这点与数据卷挂载时不一致，<strong>数据卷挂载”:”前面是宿主机本地地址，后面是容器内地址</strong>。）<br>默认执行权限是RW，若想设置只读需添加:ro<br>例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v mysql_dbdata:/var/lib/mysql/:ro --name mysql_dbdata ubuntu</span><br></pre></td></tr></table></figure></p>
<h3 id="3-创建容器来挂载mysql-dbdata的数据。"><a href="#3-创建容器来挂载mysql-dbdata的数据。" class="headerlink" title="3.创建容器来挂载mysql_dbdata的数据。"></a>3.创建容器来挂载mysql_dbdata的数据。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --volumes-from mysql_dbdata --name db1 ubuntu</span><br><span class="line">docker run -it --volumes-from mysql_dbdata --name db2 ubuntu</span><br></pre></td></tr></table></figure>
<p>db1和db2 都挂载同一个数据卷到相同的/var/lib/mysql/ 目录。三个容器任何一方在该目录下的写入，其他容器都可以看到。</p>
<h2 id="二、容器启动"><a href="#二、容器启动" class="headerlink" title="二、容器启动"></a>二、容器启动</h2><h3 id="1-启动mysql容器并挂载数据卷容器"><a href="#1-启动mysql容器并挂载数据卷容器" class="headerlink" title="1.启动mysql容器并挂载数据卷容器"></a>1.启动mysql容器并挂载数据卷容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 23333:3306 --name db_mysql_1 -v $(PWD)/my.cnf:/etc/mysql/my.cnf  --volumes-from db1 -e MYSQL_USER="lfc" -e MYSQL_ROOT_PASSWORD=123456 mysql/mysql-server</span><br></pre></td></tr></table></figure>
<h3 id="2-宿主机查看容器日志"><a href="#2-宿主机查看容器日志" class="headerlink" title="2.宿主机查看容器日志"></a>2.宿主机查看容器日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#实时查看docker容器日志</span><br><span class="line">$ sudo docker logs -f -t --tail 行数 容器名</span><br><span class="line">#例：实时查看docker容器名为s12的最后10行日志</span><br><span class="line">$ sudo docker logs -f -t --tail 10 s12</span><br></pre></td></tr></table></figure>
<h2 id="三、数据迁移备份"><a href="#三、数据迁移备份" class="headerlink" title="三、数据迁移备份"></a>三、数据迁移备份</h2><h3 id="1-备份数据"><a href="#1-备份数据" class="headerlink" title="1.备份数据"></a>1.备份数据</h3><p>（–volumes-from mysql_dbdata）新建容器挂载该容器卷<br>（-v $(pwd):/backup）并且将宿主机当前目录挂载到新容器backup下。<br>（tar cvf /backup/backup.tar /var/lib/mysql）将容器数据卷内数据打包至backup下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name backup_copy --volumes-from mysql_dbdata -v $(pwd):/backup ubuntu tar cvf /backup/backup.tar /var/lib/mysql</span><br></pre></td></tr></table></figure></p>
<h3 id="2-数据恢复"><a href="#2-数据恢复" class="headerlink" title="2.数据恢复"></a>2.数据恢复</h3><p>新建数据卷容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /var/lib/mysql --name mysql_dbdata2 ubuntu /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>另创建一个容器挂载mysql_dbdata2 的容器并使用untar将备份文件解压到挂载的容器卷中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name copydata --volumes-from mysql_dbdata2 -v $(pwd):/backup busybox tar xvf /backup/backup.tar</span><br></pre></td></tr></table></figure></p>
<h3 id="四、加载新实例"><a href="#四、加载新实例" class="headerlink" title="四、加载新实例"></a>四、加载新实例</h3><h3 id="1-新建实例加载mysql-dbdata2数据卷容器"><a href="#1-新建实例加载mysql-dbdata2数据卷容器" class="headerlink" title="1.新建实例加载mysql_dbdata2数据卷容器"></a>1.新建实例加载mysql_dbdata2数据卷容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 24444:3306 --name db_mysql_1 -v $(PWD)/my.cnf:/etc/mysql/my.cnf  --volumes-from mysql_dbdata2 -e MYSQL_USER="lfc" -e MYSQL_ROOT_PASSWORD=123456 mysql/mysql-server</span><br></pre></td></tr></table></figure>
<h2 id="五、Mysql使用"><a href="#五、Mysql使用" class="headerlink" title="五、Mysql使用"></a>五、Mysql使用</h2><h3 id="1-基本操作"><a href="#1-基本操作" class="headerlink" title="1.基本操作"></a>1.基本操作</h3><table><br>   <tr><br>      <td>操作</td><br>      <td>SQL </td><br>   </tr><br>   <tr><br>      <td>查询所有数据库    </td><br>      <td>show databases;</td><br>   </tr><br>   <tr><br>      <td>查看活跃连接    </td><br>      <td>show processlist;</td><br>   </tr><br>    <tr><br>      <td>创建数据库</td><br>      <td>create database blog default character set utf8;</td><br>   </tr><br>    <tr><br>      <td>查看数据库的默认字符集</td><br>      <td>show create database blog;</td><br>   </tr><br>   <tr><br>      <td>删除数据库</td><br>      <td>drop database blog;</td><br>   </tr><br>   <tr><br>      <td>修改数据库</td><br>      <td>alter database blog default character set gbk;</td><br>   </tr><br>   <tr><br>      <td>选择数据库</td><br>      <td>use blog;</td><br>   </tr><br>   <tr><br>      <td>看所有表</td><br>      <td>show tables;</td><br>   </tr><br>   <tr><br>      <td>创建表</td><br>      <td>create table student(sid int,sname varchar(20));</td><br>   </tr><br>   <tr><br>      <td>查看表结构</td><br>      <td>desc student;</td><br>   </tr><br>    <tr><br>      <td>删除表</td><br>      <td>drop table student;</td><br>   </tr><br>    <tr><br>      <td>添加字段</td><br>      <td>alter table student add sgender varchar(2);<br></td><br>   </tr><br>    <tr><br>      <td>删除字段</td><br>      <td>alter table student drop sgender;</td><br>   </tr><br>    <tr><br>      <td>修改字段类型</td><br>      <td>alter table student modify sgender varchar(100);</td><br>   </tr><br>    <tr><br>      <td>修改字段名称</td><br>      <td>alter table student change sgender gender varchar(2);</td><br>   </tr><br>    <tr><br>      <td>修改表名称</td><br>      <td>alter table student rename to teacher;</td><br>   </tr><br></table>


<h3 id="2-问题汇总"><a href="#2-问题汇总" class="headerlink" title="2.问题汇总"></a>2.问题汇总</h3><h4 id="1-ERROR-1130"><a href="#1-ERROR-1130" class="headerlink" title="1.ERROR 1130"></a>1.ERROR 1130</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1130: Host &apos;192.168.1.3&apos; is not allowed to connect to this</span><br></pre></td></tr></table></figure>
<p>mysql不允许远程登录，需使用命令行对其进行设置，具体方法有两种，授权法和改表法。</p>
<h5 id="1-使用root权限登录"><a href="#1-使用root权限登录" class="headerlink" title="1.使用root权限登录"></a>1.使用root权限登录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>
<h5 id="2-改表法"><a href="#2-改表法" class="headerlink" title="2.改表法"></a>2.改表法</h5><p>使用localhost的主机登录，登入后更改mysql数据库中user表里的host项，”localhost”更改成”%”。% 号为所有，也可改成某固定IP。<br>命令<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> mysql;</span><br><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> host = <span class="string">'%'</span> <span class="keyword">where</span> <span class="keyword">user</span> = <span class="string">'root'</span>;</span><br><span class="line"><span class="keyword">select</span> host, <span class="keyword">user</span> <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure></p>
<h5 id="3-授权法"><a href="#3-授权法" class="headerlink" title="3.授权法"></a>3.授权法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">'lfc'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'123456'</span> <span class="keyword">PASSWORD</span> <span class="keyword">EXPIRE</span> <span class="keyword">NEVER</span>; </span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">'lfc'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">'123456'</span>;</span><br></pre></td></tr></table></figure>
<p>mysql8.0之后进行了修改，授权和创建用户是分开设置的。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'lfc'</span>@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">on</span> *.* <span class="keyword">TO</span> <span class="string">'lfc'</span>@<span class="string">'%'</span> ; <span class="comment"># 前面的*是指定数据库，后面的*指定的是表。</span></span><br></pre></td></tr></table></figure></p>
<p>创建账户:create user ‘用户名‘@’访问主机’ identified by ‘密码’;<br>赋予权限:grant 权限列表 on 数据库 to ‘用户名‘@’访问主机’ ;(修改权限时在后面加with grant option)</p>
<h4 id="2-Error-Code-1044"><a href="#2-Error-Code-1044" class="headerlink" title="2.Error Code: 1044."></a>2.Error Code: 1044.</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error Code: 1044. Access denied for user &apos;root&apos;@&apos;%&apos; to database</span><br></pre></td></tr></table></figure>
<p>授权的权限没有打开： Grant_priv is set to N for root@%. 修复下<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> Grant_priv=<span class="string">'Y'</span>, Super_priv=<span class="string">'Y'</span> <span class="keyword">WHERE</span> <span class="keyword">User</span>=<span class="string">'lfc'</span>;</span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>; <span class="comment">#刷新</span></span><br></pre></td></tr></table></figure></p>
<p>MySQL 常见数据类型<br>在 MySQL 中常见的数据类型如下：</p>
<blockquote>
<p>1) 整数类型 包括 TINYINT、SMALLINT、MEDIUMINT、INT、BIGINT，浮点数类型 FLOAT 和<br>DOUBLE，定点数类型 DECIMAL。 2) 日期/时间类型 包括 YEAR、TIME、DATE、DATETIME 和<br>TIMESTAMP。 3) 字符串类型 包括 CHAR、VARCHAR、BINARY、VARBINARY、BLOB、TEXT、ENUM 和<br>SET 等。 4) 二进制类型 包括 BIT、BINARY、VARBINARY、TINYBLOB、BLOB、MEDIUMBLOB 和<br>LONGBLOB。</p>
</blockquote>
<h5 id="时区问题"><a href="#时区问题" class="headerlink" title="时区问题"></a>时区问题</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select now(); #查看mysql系统时间。和当前时间做对比</span><br><span class="line">set global time_zone = &apos;+8:00&apos;; #设置时区更改为东八区</span><br><span class="line">flush privileges;  #刷新权限</span><br></pre></td></tr></table></figure>
<p>然后退出后重新登录就可以了.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/28/Docker-学习四-数据管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     1.1k 字
	</span>
	<span title="阅读时长">
     4 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/28/Docker-学习四-数据管理/" itemprop="url">Docker-学习四(数据管理)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-28T22:10:58+08:00">
                2020-01-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker镜像/" itemprop="url" rel="index">
                    <span itemprop="name">Docker镜像</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/28/Docker-学习四-数据管理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/28/Docker-学习四-数据管理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="内容提要"><a href="#内容提要" class="headerlink" title="内容提要"></a>内容提要</h2><p>利用数据卷对数据进行持久化，备份，恢复，及多个容器数据共享，实现数据的迁移等。<br><strong>数据管理的两种方式：</strong></p>
<ul>
<li>数据卷（Data Volumes）：容器内数据直接映射到本地主机环境；</li>
<li>数据卷容器（Data Volume Containers）：使用特定容器维护数据卷。</li>
</ul>
<h2 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h2><p>数据卷是一个可供容器使用的特殊目录，它将主机操作系统目录直接映射进容器，类似于 Linux中的mount操作。(就是将一个设备（<em>U盘/SD卡等</em>）挂接到一个已存在的目录上。访问这个目录就是访问该存储设备)。</p>
<ul>
<li>可以在容器之间共享和重用；</li>
<li>对数据卷内数据的修改会马上生效，无论是容器内操作的还是容器操作的；</li>
<li>数据卷的操作不会影响镜像，解耦应用和数据；</li>
<li>卷会一直存在直到没有容器使用才可卸载。</li>
</ul>
<h3 id="1-容器内创建数据卷"><a href="#1-容器内创建数据卷" class="headerlink" title="1.容器内创建数据卷"></a>1.容器内创建数据卷</h3><p>启动容器时使用-v标记在容器内创建数据卷，多次使用可以创建多个数据卷。<br><strong>使用training/webapp 镜像创建一个 web容器，并创建一个数据卷挂载到容器的/webapp 目录：</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name web -v /webapp  training/webapp python app.py</span><br></pre></td></tr></table></figure></p>
<h3 id="2-挂载主机目录作为数据卷（推荐）"><a href="#2-挂载主机目录作为数据卷（推荐）" class="headerlink" title="2.挂载主机目录作为数据卷（推荐）"></a>2.挂载主机目录作为数据卷（推荐）</h3><p>使用-v参数也可以挂载本地已有的目录到容器中作为数据卷。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name web -v /src/webapp:/opt/webapp training/webapp python app.py</span><br></pre></td></tr></table></figure></p>
<p>加载主机的/ src/webapp 目录到容器的/ opt/webapp 目录，本地目录的路径必须是绝对路径，如果目录不存在Docker会自动创建。<br>Docker 挂载数据卷的默认权限是读写（rw），用户也可以通过 ro 指定为<br>只读：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name web -v /src/webapp:/opt/webapp:ro  training/webapp python app.py</span><br></pre></td></tr></table></figure></p>
<h3 id="3-挂载一个本地主机文件作为数据卷（不推荐）"><a href="#3-挂载一个本地主机文件作为数据卷（不推荐）" class="headerlink" title="3.挂载一个本地主机文件作为数据卷（不推荐）"></a>3.挂载一个本地主机文件作为数据卷（不推荐）</h3><p>-v标记也可以从主机挂载单个文件到容器作为数据卷<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it -v ~/.bash_history:/.bash_history ubuntu /bin/bash</span><br></pre></td></tr></table></figure></p>
<h2 id="数据卷容器"><a href="#数据卷容器" class="headerlink" title="数据卷容器"></a>数据卷容器</h2><p>数据卷容器也是一个容器，它的目的是用来提供数据卷供其他容器挂载。</p>
<p>1.创建数据卷容器dbdata，并创建一个数据卷挂载到/dbadata<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v /dbdata --name dbdata ubuntu</span><br></pre></td></tr></table></figure></p>
<p>2.在其他容器中使用–volumes-from 来挂载 dbdata容器中的数据卷，例如创建db1和db2两个容器，并从dbdata 容器挂载数据卷<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --volumes-from dbdata --name db1 ubuntu</span><br><span class="line">docker run -it --volumes-from dbdata --name db2 ubuntu</span><br></pre></td></tr></table></figure></p>
<p>容器 db1和db2 都挂载同一个数据卷到相同的/ dbdata 目录。三个容器任何一方在该目录下的写入，其他容器都可以看到。<br><strong>可以多次使用–volumes-from参数来从多个容器挂载多个数据卷。还可以从其他已经挂载了容器卷的容器来挂载数据卷。</strong><br><strong>注：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用--volumes-from 参数所挂载数据卷的容器自身并不需要保持在运行状</span><br><span class="line">态。</span><br><span class="line">如果删除了挂载的容器，数据卷不会自动删除。必须删除最后一个挂载它的容器时显式使用docker rm-v 来指定同时删除关联的容器。</span><br></pre></td></tr></table></figure></p>
<h3 id="利用数据卷容器来迁移数据"><a href="#利用数据卷容器来迁移数据" class="headerlink" title="利用数据卷容器来迁移数据"></a>利用数据卷容器来迁移数据</h3><h4 id="1-备份"><a href="#1-备份" class="headerlink" title="1.备份"></a>1.备份</h4><p>使用下面命令备份dbdata数据卷容器内的数据卷<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --volumes-from dbdata -v $(pwd):/backup --name worker ubuntu tar  cvf /backup/backup.tar /dbdata</span><br></pre></td></tr></table></figure></p>
<p>首先利用 ubuntu 镜像创建了一个容器worker。使用–volumes-from dbdata 参数来让worker容器挂载dbdata容器的数据卷（即dbdata数据卷）；使用-v$(pwd):/backup参数来挂载本地的当前目录到worker容器的/backup 目录。<br>worker 容器启动后，使用了 tar cvf/backup/backup.tar/dbdata命令来将/dbdata下内容备份为容器内的/backup/backup.tar，即宿主主机当前目录下的backup.tar。</p>
<h4 id="2-数据恢复"><a href="#2-数据恢复" class="headerlink" title="2.数据恢复"></a>2.数据恢复</h4><p>如果要将数据恢复到一个容器，可以按照下面的步骤操作。首先创建一个带有数据卷的容器dbdata2<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /dbdata --name dbdata2 ubuntu /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>然后创建另一个新的容器，挂载dbdata2的容器，并解压备份文件到所挂载的容器卷中<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --volumes-from dbdata2 -v $(pwd):/backup busybox tar xvf /backup/backup.tar</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/27/Docker-学习三-Docker仓库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     663 字
	</span>
	<span title="阅读时长">
     2 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/27/Docker-学习三-Docker仓库/" itemprop="url">Docker-学习三(Docker仓库)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-27T20:10:35+08:00">
                2020-01-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker镜像/" itemprop="url" rel="index">
                    <span itemprop="name">Docker镜像</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/27/Docker-学习三-Docker仓库/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/27/Docker-学习三-Docker仓库/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  663
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>docker仓库（Repository）是集中存放镜像的地方，与git概念类似，分为公共仓库和私有仓库。一般与注册服务器（Registry）容易混淆。注册服务器是存放仓库的服务器，其中可有多个仓库。</p>
<h1 id="内容提要"><a href="#内容提要" class="headerlink" title="内容提要"></a>内容提要</h1><p>使用Docker Hub官方仓库，登陆下载，及私有仓库的搭建等操作。</p>
<h2 id="Docker-Hub-公共仓库"><a href="#Docker-Hub-公共仓库" class="headerlink" title="Docker Hub 公共仓库"></a>Docker Hub 公共仓库</h2><p>Docker官方维护了一个公共镜像仓库 <a href="https://hub.docker.com" target="_blank" rel="noopener">https://hub.docker.com</a> ，大部分镜像可以从官方下载。</p>
<h3 id="1-登陆"><a href="#1-登陆" class="headerlink" title="1.登陆"></a>1.登陆</h3><p>在官网进行注册账号，通过命令执行docker login 来输入用户名密码进行登陆，本地用户目录的.dockercfg中将保存用户的认证信息。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></table></figure></p>
<h3 id="2-基本操作"><a href="#2-基本操作" class="headerlink" title="2.基本操作"></a>2.基本操作</h3><p>不需要登陆也可以使用 docker search 查询官方镜像，也可以使用docker pull命令将其下载到本地。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker search mysql -s 10</span><br><span class="line">docker pull centos</span><br></pre></td></tr></table></figure>
<p>可以使用docker push 命令来将本地镜像推送到 Docker<br>Hub<br>直接推送镜像时会报错：<strong>denied: requested access to the resource is denied</strong><br>因为没有提交权限，此时应该将要推送的镜像添加tag，将其与docker Hub仓库路径保持一致。<br><img src="https://i.loli.net/2019/11/28/Hl3Rz52YUaJqBtA.png" alt="DockerHub.png"><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag test:0.1 lisidapao/test:v1.0</span><br><span class="line">docker push lisidapao/test</span><br></pre></td></tr></table></figure></p>
<h2 id="搭建本地私有仓库"><a href="#搭建本地私有仓库" class="headerlink" title="搭建本地私有仓库"></a>搭建本地私有仓库</h2><h3 id="1-使用registry-镜像创建私有仓库"><a href="#1-使用registry-镜像创建私有仓库" class="headerlink" title="1.使用registry 镜像创建私有仓库"></a>1.使用registry 镜像创建私有仓库</h3><p>通过官方提供的 registry 镜像来简单搭建一套本地私<br>有仓库环境<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 registry</span><br></pre></td></tr></table></figure></p>
<p>通过- v参数来将镜像文件存放在本地的指定路径<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 -v /opt/data/registry:/tmp/registry registry</span><br></pre></td></tr></table></figure></p>
<h3 id="2-管理私有仓库"><a href="#2-管理私有仓库" class="headerlink" title="2. 管理私有仓库"></a>2. 管理私有仓库</h3><p>获取仓库服务的ip地址，再开一个虚拟机模拟本地将本地镜像tag标记为：<strong>仓库IP:5000/test</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag ubuntu:14.04 10.0.2.2:5000/test</span><br></pre></td></tr></table></figure></p>
<p>使用docker push 上传标记的镜像：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push 10.0.2.2:5000/test</span><br></pre></td></tr></table></figure></p>
<p>用curl 查看仓库10.0.2.2： 5000 中的镜像<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.0.2.2:5000/v1/search</span><br></pre></td></tr></table></figure></p>
<p>结果中可以看到{“description”：””，”name”：”library/test”}，表明镜像已经成功上传了。现在可以到任意一台能访问到 10.0.2.2地址的机器去下载这个镜像了。</p>
<p>版本较新的Docker版本对安全性要求比较高，要求仓库支持SSL/TLS证书。内部使用的私有仓库，可以关闭对此的检查。<br>添加如下参数，标识信任该仓库，不进行证书检查，重启Docker 服务配置生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS="--insecure-registry 10.0.2.2:5000"</span><br></pre></td></tr></table></figure></p>
<h2 id="国内仓库配置"><a href="#国内仓库配置" class="headerlink" title="国内仓库配置"></a>国内仓库配置</h2><p>阿里云，时速云，网易云等相关：<a href="https://www.cnblogs.com/wushuaishuai/p/9984228.html" target="_blank" rel="noopener">https://www.cnblogs.com/wushuaishuai/p/9984228.html</a></p>
<p>参考资料：Docker技术入门与实战</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/12/Jenkins-Svn-Ant持续集成/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     2.6k 字
	</span>
	<span title="阅读时长">
     13 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/12/Jenkins-Svn-Ant持续集成/" itemprop="url">Jenkins + Svn + Ant持续集成</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-12T19:40:24+08:00">
                2020-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/12/Jenkins-Svn-Ant持续集成/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/12/Jenkins-Svn-Ant持续集成/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、Jenkins基础配置"><a href="#一、Jenkins基础配置" class="headerlink" title="一、Jenkins基础配置"></a>一、Jenkins基础配置</h2><h3 id="1-配置中文"><a href="#1-配置中文" class="headerlink" title="1.配置中文"></a>1.配置中文</h3><p>主界面–&gt;系统管理–&gt;插件管理–&gt;可选插件<br>安装插件locale plugin<br>系统管理–&gt;系统设置–&gt;Locale<br>填入：zh_CN<br>保存应用</p>
<h3 id="2-插件管理"><a href="#2-插件管理" class="headerlink" title="2.插件管理"></a>2.插件管理</h3><p>插件管理在 系统管理 -&gt; 管理插件 里面。<br>我们需要先完成的插件的安装才能配置和管理我们Job,有以下几种插件是我们需要的：</p>
<ul>
<li>Svn plugin(Svn 源码管理插件)</li>
<li>antPlugin(ant 打包插件)</li>
<li>Publish Over SSH(远程访问的SSH插件)<br><img src="https://i.loli.net/2020/01/10/wGJr7RdiSyoce6h.png" alt="插件.png"><h3 id="3-全局工具配置"><a href="#3-全局工具配置" class="headerlink" title="3.全局工具配置"></a>3.全局工具配置</h3>全局工具配置在 系统管理 -&gt; Global Tool Configuration<br><img src="https://i.loli.net/2020/01/10/5v6zB1qbUQPilCc.png" alt="全局工具配置.png"></li>
<li>JDK配置</li>
<li>Git配置</li>
<li>Maven配置</li>
<li><p>Ant配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Name ：ant_1.9.6</span><br><span class="line">ANT_HOME： /home/data/apache-ant-1.9.6</span><br></pre></td></tr></table></figure>
</li>
<li><p>Gradle配置</p>
<h3 id="4-系统配置"><a href="#4-系统配置" class="headerlink" title="4.系统配置"></a>4.系统配置</h3><p><strong>Jenkins Location</strong><br>邮件配置图<br><img src="https://i.loli.net/2020/01/10/sVMklCj3euwg5f7.png" alt="邮件配置_20200109173337.png"><br><strong>SSH配置</strong><br><img src="https://i.loli.net/2020/01/10/qngVMPmL2uykp1Q.png" alt="ssh_20200109173549.png"><br>配置完成后点击TestConfiguration进行测试，是否连通。<br>如果是服务器集群的话，就再增加一个 SSH Server。</p>
</li>
</ul>
<h2 id="二、新建任务"><a href="#二、新建任务" class="headerlink" title="二、新建任务"></a>二、新建任务</h2><p><img src="https://i.loli.net/2020/01/10/ZwMkHCBlbGJ4RLK.png" alt="新建任务.png"></p>
<h3 id="1-添加任务描述"><a href="#1-添加任务描述" class="headerlink" title="1.添加任务描述"></a>1.添加任务描述</h3><p><img src="https://i.loli.net/2020/01/10/uEe68y7xKjHOmo9.png" alt="job构建.png"></p>
<h3 id="2-源码管理"><a href="#2-源码管理" class="headerlink" title="2.源码管理"></a>2.源码管理</h3><h4 id="选择Subversion绑定svn"><a href="#选择Subversion绑定svn" class="headerlink" title="选择Subversion绑定svn"></a>选择Subversion绑定svn</h4><p><img src="https://i.loli.net/2020/01/10/DjWTJpLPMg4F7N5.png" alt="job_svn.png"></p>
<h4 id="Check-out-Strategy各个选项详细"><a href="#Check-out-Strategy各个选项详细" class="headerlink" title="Check-out Strategy各个选项详细"></a>Check-out Strategy各个选项详细</h4><p><table><br>   <tr><br>      <td>Check-out Strategy</td><br>      <td>第一次build </td><br>      <td>第n次build(除第一次)</td><br>   </tr><br>   <tr><br>      <td>Use ‘svn update’ as much as possible    </td><br>      <td rowspan="4">将workspace下的所有文件清空，然后从svn上check out一份完整的项目到workspace下</td><br>      <td>update前不会revert</td><br>   </tr><br>   <tr><br>      <td>Always check out a fresh copy    </td><br>      <td>删除workspace下的所有文件，然后重新check out一份完整的项目到workspace下。</td><br>   </tr><br>    <tr><br>      <td>Emulate clean checkout by first deleting unversioned/ignored files, then ‘svn update’        </td><br>      <td>update前先删除unversioned/ignored文件</td><br>   </tr><br>    <tr><br>      <td>Use ‘svn update’ as much as possible, with ‘svn revert’ before updat    </td><br>      <td>update前先revert</td><br>   </tr><br></table><br>参考博客：<a href="https://blog.csdn.net/russ44/article/details/52261781" target="_blank" rel="noopener">russ44</a></p>
<h3 id="3-构建触发器"><a href="#3-构建触发器" class="headerlink" title="3.构建触发器"></a>3.构建触发器</h3><p>可选择定时构建，轮询构建等多种方式。<br><img src="https://i.loli.net/2020/01/10/6PVQEMlrZJUkwoD.png" alt="构建触发器.png"></p>
<h3 id="4-构建环境"><a href="#4-构建环境" class="headerlink" title="4.构建环境"></a>4.构建环境</h3><h4 id="4-1配置Ant"><a href="#4-1配置Ant" class="headerlink" title="4.1配置Ant"></a>4.1配置Ant</h4><p>不指定时默认使用build.xml，我这里新写了一个add_build.xml配置后执行。<br><img src="https://i.loli.net/2020/01/10/NbRv5eSrpmaMjhk.png" alt="ant配置.png"><br>add_build.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">name</span>=<span class="string">"policy_vhl_110"</span> <span class="attr">basedir</span>=<span class="string">"."</span> <span class="attr">default</span>=<span class="string">"package"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">environment</span>=<span class="string">"env"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"ant.home"</span> <span class="attr">value</span>=<span class="string">"$&#123;env.ANT_HOME&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"java.home"</span> <span class="attr">value</span>=<span class="string">"$&#123;env.JAVA_HOME&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/path"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.lib"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/templib"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.dir_1"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/main/java"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.dir_2"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/main/resources"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"src.dir_3"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/src/interface"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"web.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/WebRoot"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"build.classes"</span> <span class="attr">value</span>=<span class="string">"$&#123;web.dir&#125;/WEB-INF/classes"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dist.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/policy_vhl_jar"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"conf.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;web.dir&#125;/WEB-INF/classes/conf"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"temp_build.dir"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/build"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"conf.dir_1"</span> <span class="attr">value</span>=<span class="string">"$&#123;web.dir&#125;/WEB-INF/"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 依赖路径，用于编译 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">path</span> <span class="attr">id</span>=<span class="string">"classpath"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--&lt;fileset dir="$&#123;basedir&#125;/build"&gt;</span></span><br><span class="line"><span class="comment">			&lt;include name="**/*.jar" /&gt;</span></span><br><span class="line"><span class="comment">		&lt;/fileset&gt; --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;web.dir&#125;/WEB-INF/lib"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">"**/*.jar"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 排除java源文件的模式集 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">id</span>=<span class="string">"no.java"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">exclude</span> <span class="attr">name</span>=<span class="string">"**/*.java"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">patternset</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 排除conf下配置文件 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">id</span>=<span class="string">"properties"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">exclude</span> <span class="attr">name</span>=<span class="string">"**/applicationDeployment.properties"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">exclude</span> <span class="attr">name</span>=<span class="string">"**/pcisv6DataSource.properties"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">exclude</span> <span class="attr">name</span>=<span class="string">"**/*.java"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">patternset</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">echo</span>&gt;</span>******删除pcis目录下包<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.lib&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">dir</span>=<span class="string">"$&#123;build.classes&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">dir</span>=<span class="string">"$&#123;basedir&#125;/conf"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">echo</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span>清理完毕<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 初始化,建立目录,将多个src目录复制到同一src目录，编译--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"init"</span> <span class="attr">description</span>=<span class="string">"初始化,建立目录,复制文件"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">echo</span>&gt;</span>**** init dir copy ****<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mkdir</span> <span class="attr">dir</span>=<span class="string">"$&#123;build.classes&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mkdir</span> <span class="attr">dir</span>=<span class="string">"$&#123;dist.dir&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">mkdir</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">copy</span> <span class="attr">todir</span>=<span class="string">"$&#123;src.dir&#125;"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_1&#125;"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_2&#125;"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_3&#125;"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">copy</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">copy</span> <span class="attr">todir</span>=<span class="string">"$&#123;build.classes&#125;"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_1&#125;"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">refid</span>=<span class="string">"no.java"</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">refid</span>=<span class="string">"properties"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_2&#125;"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">refid</span>=<span class="string">"properties"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;src.dir_3&#125;"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">patternset</span> <span class="attr">refid</span>=<span class="string">"properties"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">copy</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 编译 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"compile"</span> <span class="attr">depends</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">echo</span>&gt;</span>**** compile  to classes dir ****<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">javac</span> <span class="attr">srcdir</span>=<span class="string">"$&#123;src.dir&#125;"</span> <span class="attr">destdir</span>=<span class="string">"$&#123;build.classes&#125;"</span> <span class="attr">target</span>=<span class="string">"1.6"</span> <span class="attr">source</span>=<span class="string">"1.6"</span> <span class="attr">debug</span>=<span class="string">"true"</span> <span class="attr">debuglevel</span>=<span class="string">"lines,vars,source"</span> <span class="attr">fork</span>=<span class="string">"true"</span> <span class="attr">executable</span>=<span class="string">"/home/data/jdk1.6.0_45/bin/javac"</span> <span class="attr">memoryMaximumSize</span>=<span class="string">"1024m"</span> <span class="attr">nowarn</span>=<span class="string">"on"</span> <span class="attr">includeantruntime</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">compilerarg</span> <span class="attr">line</span>=<span class="string">"-encoding UTF-8"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">classpath</span> <span class="attr">refid</span>=<span class="string">"classpath"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">javac</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">path</span> <span class="attr">id</span>=<span class="string">"lib_classpath"</span>&gt;</span></span><br><span class="line">	        <span class="tag">&lt;<span class="name">fileset</span> <span class="attr">dir</span>=<span class="string">"$&#123;basedir&#125;/"</span>&gt;</span></span><br><span class="line">	            <span class="tag">&lt;<span class="name">include</span> <span class="attr">name</span>=<span class="string">"svnPacket.jar"</span>/&gt;</span></span><br><span class="line">	        <span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"package"</span> <span class="attr">depends</span>=<span class="string">"compile"</span>&gt;</span>  </span><br><span class="line">		 <span class="tag">&lt;<span class="name">echo</span>&gt;</span>开始.......<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">       	<span class="comment">&lt;!-- &lt;java classname="com.glory.svn.SVNKitUtil" classpathref="lib_classpath"&gt;</span></span><br><span class="line"><span class="comment">        &lt;/java&gt;--&gt;</span></span><br><span class="line">		 <span class="tag">&lt;<span class="name">echo</span>&gt;</span>结束.......<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">target</span>&gt;</span>	</span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="4-2执行shell"><a href="#4-2执行shell" class="headerlink" title="4.2执行shell"></a>4.2执行shell</h4><p><img src="https://i.loli.net/2020/01/10/euO3CgoGwy6lxvM.png" alt="构建环境shell.png"><br>因为项目目前的打包方式是增量包，所以在这里使用java写了一个脚本，作用是将想发布的内容以版本号为标的，将两个版本号范围内提交的内容提取到一个文件内（svn_version.txt），再使用打包工具将文件内的列表进行打包。<br>其中主要使用的是svnkit的jar包获取svn对应版本号内提交的内容，将路径进行转换成class路径输出到目标文件内。<br>具体代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> String line = System.getProperty(<span class="string">"line.separator"</span>, <span class="string">"/n"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SVNRepository repository ;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream is = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"svnconfig.properties"</span>));</span><br><span class="line">            BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is, <span class="string">"UTF-8"</span>));</span><br><span class="line">            properties.load(bufferedReader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DAVRepositoryFactory.setup();</span><br><span class="line">        SVNRepositoryFactoryImpl.setup();</span><br><span class="line">        FSRepositoryFactory.setup();</span><br><span class="line">        String uName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            uName = (String)properties.get(<span class="string">"SVN_URL"</span>);</span><br><span class="line">            repository = SVNRepositoryFactory.create(SVNURL.parseURIEncoded(uName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SVNException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uName = (String)properties.get(<span class="string">"SVN_USERNAME"</span>);</span><br><span class="line">        String passwd = (String)properties.get(<span class="string">"SVN_PASSWORD"</span>);</span><br><span class="line">        ISVNAuthenticationManager authManager = SVNWCUtil.createDefaultAuthenticationManager(uName, passwd.toCharArray());</span><br><span class="line">        repository.setAuthenticationManager(authManager);</span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println("Repository Root:" + repository.getRepositoryRoot(true));</span></span><br><span class="line"><span class="comment">//            System.out.println("Repository UUID:" + repository.getRepositoryUUID(true));</span></span><br><span class="line"><span class="comment">//        &#125; catch (SVNException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">filterCommitHistoryTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startRevision = <span class="number">100L</span>;</span><br><span class="line">        String versionStr = <span class="string">"100"</span>;</span><br><span class="line">        InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File vFile = <span class="keyword">new</span> File(<span class="string">"svn_version.txt"</span>);</span><br><span class="line">            inputStream = <span class="keyword">new</span> FileInputStream(vFile);</span><br><span class="line">            <span class="keyword">byte</span>[] byets = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>)vFile.length()];</span><br><span class="line">            inputStream.read(byets);</span><br><span class="line">            versionStr = <span class="keyword">new</span> String(byets,<span class="string">"utf-8"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> != inputStream) inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != versionStr &amp;&amp; !<span class="string">""</span>.equals(versionStr))&#123;</span><br><span class="line">            String[] versions = versionStr.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> endRevision = -<span class="number">1L</span>;</span><br><span class="line">            <span class="keyword">final</span> List&lt;String&gt; history = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            <span class="keyword">final</span> List&lt;Long&gt; versionList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            <span class="keyword">final</span> Set&lt;String&gt; delPathSet = <span class="keyword">new</span> HashSet();</span><br><span class="line">            <span class="keyword">for</span>(String version : versions)&#123;</span><br><span class="line">                startRevision = Long.parseLong(version);</span><br><span class="line">                repository.log(<span class="keyword">new</span> String[]&#123;<span class="string">""</span>&#125;, startRevision, endRevision, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">new</span> ISVNLogEntryHandler() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLogEntry</span><span class="params">(SVNLogEntry svnlogentry)</span> <span class="keyword">throws</span> SVNException </span>&#123;</span><br><span class="line">                        versionList.add(svnlogentry.getRevision());</span><br><span class="line">                        Map&lt;String, SVNLogEntryPath&gt; mapLog = svnlogentry.getChangedPaths();</span><br><span class="line">                        Set&lt;String&gt; keySet = mapLog.keySet();</span><br><span class="line">                        Iterator var5 = keySet.iterator();</span><br><span class="line">                        <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">                            String logkey = (String)var5.next();</span><br><span class="line">                            <span class="keyword">char</span> cType = ((SVNLogEntryPath)mapLog.get(logkey)).getType();</span><br><span class="line">                            <span class="keyword">if</span> (<span class="string">'D'</span> == cType) &#123;</span><br><span class="line">                                delPathSet.add(logkey);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        history.addAll((Collection)svnlogentry.getChangedPaths().keySet());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            Set&lt;String&gt; fileNameSet = <span class="keyword">new</span> HashSet();</span><br><span class="line">            StringBuilder sBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            Iterator hisIter = history.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(hisIter.hasNext()) &#123;</span><br><span class="line">                String path = (String)hisIter.next();</span><br><span class="line">                <span class="keyword">if</span> (!delPathSet.contains(path)) &#123;</span><br><span class="line">                    String className;</span><br><span class="line">                    <span class="keyword">if</span> (path.contains(<span class="string">"WebRoot"</span>)) &#123;</span><br><span class="line">                        className = path.substring(path.indexOf(<span class="string">"WebRoot"</span>));</span><br><span class="line">                        fileNameSet.add(className);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (path.contains(<span class="string">"src"</span>)) &#123;</span><br><span class="line">                        className = path.substring(path.indexOf(<span class="string">"src"</span>));</span><br><span class="line">                        className = className.replace(<span class="string">"src/main/java"</span>, <span class="string">"WebRoot/WEB-INF/classes"</span>);</span><br><span class="line">                        className = className.replace(<span class="string">"src/interface/com"</span>, <span class="string">"WebRoot/WEB-INF/classes/com"</span>);<span class="comment">//只针对车承保</span></span><br><span class="line">                        className = className.replace(<span class="string">"src/com"</span>, <span class="string">"WebRoot/WEB-INF/classes/com"</span>);</span><br><span class="line">                        className = className.replace(<span class="string">"src/main/resources"</span>, <span class="string">"WebRoot/WEB-INF/classes"</span>);</span><br><span class="line">                        className = className.replace(<span class="string">"src"</span>, <span class="string">"WebRoot/WEB-INF/classes"</span>);</span><br><span class="line">                        className = className.replace(<span class="string">".java"</span>, <span class="string">".class"</span>);</span><br><span class="line">                        fileNameSet.add(className);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            Iterator fileIter = fileNameSet.iterator();</span><br><span class="line">            <span class="keyword">while</span>(fileIter.hasNext()) &#123;</span><br><span class="line">                String namePath = (String)fileIter.next();</span><br><span class="line">                ++i;</span><br><span class="line">                sBuilder.append(namePath);</span><br><span class="line">                <span class="keyword">if</span> (i != fileNameSet.size()) &#123;</span><br><span class="line">                    sBuilder.append(line);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            OutputStream outputStream = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                File file = <span class="keyword">new</span> File(<span class="string">"file_list.txt"</span>);</span><br><span class="line">                <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        file.createNewFile();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                outputStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">                outputStream.write(sBuilder.toString().getBytes());</span><br><span class="line">                outputStream.flush();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">null</span> != outputStream) outputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"打包工程start"</span>);</span><br><span class="line">        setupLibrary();</span><br><span class="line">        filterCommitHistoryTest();</span><br><span class="line">        System.out.println(<span class="string">"打包工程end"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo =====gen file list begin===== </span><br><span class="line">cd /var/lib/jenkins/workspace/policy_vhl_110/ </span><br><span class="line">java -jar svnPacket.jar</span><br><span class="line">echo =====gen file list end===== </span><br><span class="line">echo =====make jar======</span><br><span class="line">jar cvf policy_vhl_jar/policy_vhl.jar @file_list.txt</span><br><span class="line">echo ====make jar over=====</span><br></pre></td></tr></table></figure></p>
<p>简述下流程</p>
<ol>
<li>首先代码提交开发版本库</li>
<li>由开发版本库将内容合并至DEV版本库</li>
<li>提交svn_version.txt文件，里面记录着想发布到DEV环境的SVN version编号。例如：svn列表由上到下为1、2、3、4代码无交叉，svn_version记录着2，3 ，则虽然1、2、3、4代码已经发布了DEV环境的代码基线，并且其代码已经构建，但是只会将2，3中提交的代码进行打包。</li>
<li>根据file_list.txt记录的具体class路径进行打包，获得指定版本编号范围内的代码。</li>
<li>将jar发布至远程服务，解压重启。</li>
</ol>
<h3 id="5-构建后操作"><a href="#5-构建后操作" class="headerlink" title="5.构建后操作"></a>5.构建后操作</h3><p><img src="https://i.loli.net/2020/01/10/ZaXtE1pOjm9cg2b.png" alt="构建后操作SSH图片.png"><br>指定环境变量，将jar发送到远程服务器目标路径下，解压jar包后调用jenkins.sh脚本进行重启。（容器为weblogic）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">echo =====jar begin=====</span><br><span class="line">export JAVA_HOME=/usr/java/jrockit-jdk1.6.0_29-R28.1.5-4.0.1</span><br><span class="line">export PATH=$JAVA_HOME/bin:/usr/local/bin:$PATH:$MAVEN_HOME/bin</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar</span><br><span class="line">cd /usr/bin </span><br><span class="line">ln -s -f /usr/java/jrockit-jdk1.6.0_29-R28.1.5-4.0.1/bin/jar   jar</span><br><span class="line"></span><br><span class="line">cd /home/source/7002/policy_vhl</span><br><span class="line">jar -xvf policy_vhl.jar</span><br><span class="line">echo =====jar end=====</span><br><span class="line">cd /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/</span><br><span class="line">./jenkins.sh &amp;</span><br></pre></td></tr></table></figure></p>
<p>脚本主要是进行重启，最后将jar包按照时间戳进行重命名。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span>jenkins 重启脚本</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>删除lok文件</span><br><span class="line">find /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/ -name "*.lok" -print -exec rm -rf &#123;&#125; \;</span><br><span class="line"><span class="meta">#</span>清除服务器缓存</span><br><span class="line">cd /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/servers/AdminServer/tmp/_WL_user</span><br><span class="line">rm -rf pcisv7</span><br><span class="line"><span class="meta">#</span>查找并强制杀死进程</span><br><span class="line">ps -ef|egrep 7002|gawk '&#123;print $2&#125;'|while read pid</span><br><span class="line">do</span><br><span class="line">kill -9 $pid</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span>以当前时间命名后台日志，并显示</span><br><span class="line">str=$"/n"</span><br><span class="line">MYDATE=`date +%Y%m%d%H%M%S` </span><br><span class="line">echo "$MYDATE"</span><br><span class="line"><span class="meta">#</span>清除历史日志，防止占内存过多</span><br><span class="line">cd /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/logs</span><br><span class="line">rm -rf *.log</span><br><span class="line">cd /home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/bin</span><br><span class="line">nohup ./startWebLogic.sh&gt;/home/oracle/Oracle/Middleware/user_projects/domains/hhuat7002/logs/$MYDATE.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="meta">#</span> 重命名jar包</span><br><span class="line">mv /home/source/7002/policy_vhl/policy_vhl.jar  policy_vhl.$MYDATE.jar</span><br></pre></td></tr></table></figure></p>
<h3 id="6-立即构建"><a href="#6-立即构建" class="headerlink" title="6.立即构建"></a>6.立即构建</h3><p><img src="https://i.loli.net/2020/01/10/QzjkSHuMGT3ah8L.png" alt="立即构建_20200110103123.png"></p>
<h2 id="三、问题处理"><a href="#三、问题处理" class="headerlink" title="三、问题处理"></a>三、问题处理</h2><h3 id="ant编译时乱码问题："><a href="#ant编译时乱码问题：" class="headerlink" title="ant编译时乱码问题："></a>ant编译时乱码问题：</h3><p>编译时遇到 “非法字符： \65279”的报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[javac] /var/lib/jenkins/workspace/policy_vhl_110/src/path/interface/com/isoftstone/pcis/policy/foreignInterface/service/impl/ElectricityPinServiceImpl.java:1: 非法字符： \65279</span><br></pre></td></tr></table></figure></p>
<p>解决:<a href="https://blog.csdn.net/netwalk/article/details/52005546" target="_blank" rel="noopener">https://blog.csdn.net/netwalk/article/details/52005546</a></p>
<h3 id="软件包-javax-servlet-不存在"><a href="#软件包-javax-servlet-不存在" class="headerlink" title="软件包 javax.servlet 不存在"></a>软件包 javax.servlet 不存在</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">软件包 javax.servlet 不存在</span><br><span class="line">[javac] import javax.servlet.ServletException;</span><br></pre></td></tr></table></figure>
<p>解决办法：<br>从tomcat lib目录下拷贝一个servlet-api.jar的包到“JDK\jre\lib\ext”目录下<br>凡是出现找不到包的情况，都可以将找到的包放到JDK\jre\lib\ext下，然后再编译就能够通过。</p>
<h2 id="四、扩展资料"><a href="#四、扩展资料" class="headerlink" title="四、扩展资料"></a>四、扩展资料</h2><p>代码及相关资料地址：<a href="https://github.com/cmevolve/xieexiaodaima/tree/master/DevOps/Jenkins%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener">https://github.com/cmevolve/xieexiaodaima/tree/master/DevOps/Jenkins%E9%85%8D%E7%BD%AE</a></p>
<h3 id="1-Ant-构建相关连接"><a href="#1-Ant-构建相关连接" class="headerlink" title="1.Ant 构建相关连接"></a>1.Ant 构建相关连接</h3><p><a href="https://blog.csdn.net/Al_assad/article/details/76285841" target="_blank" rel="noopener">https://blog.csdn.net/Al_assad/article/details/76285841</a><br><a href="https://blog.csdn.net/mevicky/article/details/72828554" target="_blank" rel="noopener">https://blog.csdn.net/mevicky/article/details/72828554</a><br><a href="https://blog.csdn.net/xxdddail/article/details/21166161" target="_blank" rel="noopener">https://blog.csdn.net/xxdddail/article/details/21166161</a><br><a href="https://blog.csdn.net/yang3wei/article/details/7393399" target="_blank" rel="noopener">https://blog.csdn.net/yang3wei/article/details/7393399</a><br><a href="https://www.cnblogs.com/fnlingnzb-learner/p/6279189.html" target="_blank" rel="noopener">https://www.cnblogs.com/fnlingnzb-learner/p/6279189.html</a><br><a href="https://www.yiibai.com/ant/apache-ant-javac-task.html" target="_blank" rel="noopener">https://www.yiibai.com/ant/apache-ant-javac-task.html</a></p>
<h3 id="2-Svnkit-组件使用："><a href="#2-Svnkit-组件使用：" class="headerlink" title="2.Svnkit 组件使用："></a>2.Svnkit 组件使用：</h3><p><a href="https://www.cnblogs.com/douJiangYouTiao888/p/6138660.html" target="_blank" rel="noopener">https://www.cnblogs.com/douJiangYouTiao888/p/6138660.html</a></p>
<h3 id="3-Jenkins-Ant"><a href="#3-Jenkins-Ant" class="headerlink" title="3. Jenkins+Ant"></a>3. Jenkins+Ant</h3><p><a href="https://blog.csdn.net/xiaxiaozhang/article/details/74155300" target="_blank" rel="noopener">https://blog.csdn.net/xiaxiaozhang/article/details/74155300</a><br>jekins svn任务配置：<a href="https://blog.csdn.net/russ44/article/details/52261781" target="_blank" rel="noopener">https://blog.csdn.net/russ44/article/details/52261781</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/11/Jenkins-安装配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     866 字
	</span>
	<span title="阅读时长">
     3 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/11/Jenkins-安装配置/" itemprop="url">Jenkins 安装配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-11T15:10:16+08:00">
                2020-01-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/11/Jenkins-安装配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/11/Jenkins-安装配置/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  866
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Jenkins介绍"><a href="#Jenkins介绍" class="headerlink" title="Jenkins介绍"></a>Jenkins介绍</h2><blockquote>
<p>Jenkins是一个独立的开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件的持续集成变成可能。前身是Hudson是一个可扩展的持续集成引擎。可用于自动化各种任务，如构建，测试和部署软件。Jenkins可以通过本机系统包Docker安装，甚至可以通过安装Java Runtime Environment的任何机器独立运行。</p>
</blockquote>
<h2 id="一、安装准备"><a href="#一、安装准备" class="headerlink" title="一、安装准备"></a>一、安装准备</h2><p>在这里构建的是Jenkins+ANT+SVN的一套发布流程</p>
<h3 id="安装JDK环境变量"><a href="#安装JDK环境变量" class="headerlink" title="安装JDK环境变量"></a>安装JDK环境变量</h3><p>JDK安装配置<br>略，参考：<a href="https://www.cnblogs.com/liuhongfeng/p/4177568.html" target="_blank" rel="noopener">https://www.cnblogs.com/liuhongfeng/p/4177568.html</a></p>
<h3 id="安装ANT并配置环境变量"><a href="#安装ANT并配置环境变量" class="headerlink" title="安装ANT并配置环境变量"></a>安装ANT并配置环境变量</h3><p> ANT安装配置<br>windows<br>下载地址：<a href="http://ant.apache.org" target="_blank" rel="noopener">http://ant.apache.org</a></p>
<p><strong>配置环境变量</strong><br>windows中设置ant环境变量：<br>| 属性        | 配置   |<br>| ——–   | —–:  |<br>| ANT_HOME     | D:/ apache-ant-1.10.0 |<br>| path        |   %ANT_HOME%/bin  |<br>| classpath       |   %ANT_HOME%/lib   | </p>
<p>linux中设置ant环境变量：</p>
<ul>
<li>将下载的tar.gz复制到/usr 下</li>
<li>tar -vxzf apahce-ant-1.9.2-bin.tar.gz  解压</li>
<li>chown -R yjdabc apahce-ant-1.9.2  改变权限<br>chown -R :users apahce-ant-1.9.2<br>chmod -R +x apahce-ant-1.9.2</li>
<li><p>vim /etc/profile    修改系统配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#set Ant enviroment</span><br><span class="line">export ANT_HOME=/usr/apache-ant-1.9.2</span><br><span class="line">export PATH=$PATH:$ANT_HOME/bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>source /etc/proifle   立刻将配置生效</p>
<h2 id="二、-Jenkins-安装"><a href="#二、-Jenkins-安装" class="headerlink" title="二、 Jenkins 安装"></a>二、 Jenkins 安装</h2><p>linux下安装有3种方式</p>
</li>
<li><p>Docker安装（推荐）</p>
</li>
<li>使用tomcat启动，将安装目录 /usr/lib/jenkins/下的war包放于Tomcat的webapps目录下 </li>
<li>安装Jenkins</li>
</ul>
<p>第三种安装方式：</p>
<h3 id="1-离线安装-推荐"><a href="#1-离线安装-推荐" class="headerlink" title="1.离线安装-推荐"></a>1.离线安装-推荐</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## http://pkg.jenkins-ci.org/redhat-stable/</span><br><span class="line">wget http://pkg.jenkins-ci.org/redhat/jenkins-2.39-1.1.noarch.rpm ## 下载(也可以Windows下载再转过来)</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key ## 导入公钥，发现离线安装，不需要导入公钥就能安装</span><br><span class="line">rpm -ih jenkins-2.7.2-1.1.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>自动安装完成之后：</p>
<ul>
<li>/usr/lib/jenkins/jenkins.war WAR包</li>
<li>/etc/sysconfig/jenkins 配置文件</li>
<li>/var/lib/jenkins/ 默认的JENKINS_HOME目录</li>
<li>/var/log/jenkins/jenkins.log Jenkins日志文件</li>
</ul>
<h3 id="2-在线安装"><a href="#2-在线安装" class="headerlink" title="2.在线安装"></a>2.在线安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 添加Jenkins源</span><br><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">yum repolist # Update your package manager list to get the latest packages</span><br><span class="line"># 安装</span><br><span class="line">yum install java-1.8.0-openjdk jenkins</span><br><span class="line">service jenkins start # 启动</span><br></pre></td></tr></table></figure>
<h2 id="三、Jenkins设置"><a href="#三、Jenkins设置" class="headerlink" title="三、Jenkins设置"></a>三、Jenkins设置</h2><p>为了不因为权限出现各种问题，这里直接使用root<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## sudo vim /etc/sysconfig/jenkins</span><br><span class="line">JENKINS_USER=&quot;root&quot; ## 原值 &quot;jenkins&quot; 必须修改，否则权限不足</span><br><span class="line">JENKINS_PORT=&quot;8080&quot; ## 原值 &quot;8080&quot; 可以不修改</span><br></pre></td></tr></table></figure></p>
<p>修改目录权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R root:root /var/lib/jenkins</span><br><span class="line">chown -R root:root /var/cache/jenkins</span><br><span class="line">chown -R root:root /var/log/jenkins</span><br></pre></td></tr></table></figure></p>
<h2 id="四、Jenkins-启动"><a href="#四、Jenkins-启动" class="headerlink" title="四、Jenkins 启动"></a>四、Jenkins 启动</h2><p>启动Jenkins<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable jenkins # 开机自启动Jenkins</span><br><span class="line">sudo systemctl start jenkins # 启动Jenkins</span><br></pre></td></tr></table></figure></p>
<p>查看服务细节<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status jenkins.service</span><br></pre></td></tr></table></figure></p>
<p>验证Jenkins Server访问链接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet IP 8080</span><br></pre></td></tr></table></figure></p>
<p>如果访问有问题，需要把防火墙关了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld.service #重启不自动开启</span><br></pre></td></tr></table></figure></p>
<p>通过如下两个命令查看防火墙是否关闭<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files|grep firewalld.service</span><br><span class="line">iptables -t nat -S</span><br></pre></td></tr></table></figure></p>
<h2 id="五、Jenkins-master优化"><a href="#五、Jenkins-master优化" class="headerlink" title="五、Jenkins master优化"></a>五、Jenkins master优化</h2><p>增加同时打开文件句柄数<br>增加同时打开文件句柄数，linux默认一个进程能同时打开的文件句柄是1024个，在jenkins master肯定是不够的，需要调整成65535<br>CentOS系统，修改/etc/security/limits.conf，在文件最后增加一行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root             -       nofile          65535</span><br></pre></td></tr></table></figure></p>
<p>重启后生效，可以通过命令ulimit -a查看<br>登录地址：<a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a><br>初始密码获取：sudo cat /var/lib/jenkins/secrets/initialAdminPassword</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/06/面向对象设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     2.6k 字
	</span>
	<span title="阅读时长">
     9 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/06/面向对象设计/" itemprop="url">面向对象设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-06T20:56:50+08:00">
                2020-01-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/06/面向对象设计/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/06/面向对象设计/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>拿到一个需求时应该怎么做？</p>
<ul>
<li>明确需求</li>
<li>基础分析</li>
<li>了解最佳实践</li>
<li>测试用例</li>
<li>预计工期</li>
<li>约定接口定义</li>
<li>编写用户手册和文档，示例代码</li>
</ul>
<h2 id="如何进行面对象对象设计"><a href="#如何进行面对象对象设计" class="headerlink" title="如何进行面对象对象设计"></a>如何进行面对象对象设计</h2><ul>
<li>职责划分进而区分有哪些类<ul>
<li>将功能点罗列出来，职责相近属性类似归为同一类</li>
<li>找到功能相近，操作同样属性的可能归到一个类</li>
<li>复杂需求按照模块拆分，然后再找类</li>
</ul>
</li>
<li>定义类的属性和方法<ul>
<li>需求中的名词作为候选属性，动词作为候选方法</li>
<li>并不是所有的名词都需要作为类的属性，不属于这个类的可以通过传参来构造</li>
</ul>
</li>
<li>定义类和类的关系（以下为UML中定义的类关系）<ul>
<li>泛化<ul>
<li>简单理解为继承关系</li>
</ul>
</li>
<li>实现<ul>
<li>一般指接口和实现类之间的关系 </li>
</ul>
</li>
<li>聚合<ul>
<li>包含关系 ，A类对象包含B类对象，B类对象生命周期不依赖A类对象生命周期，如课程和学生的关系</li>
</ul>
</li>
<li>组合<ul>
<li>包含关系。A类对象包含B类对象，B 类对象生命周期依赖A类对象生命周期，B类对象不可单独存在，比如鸟和翅膀的关系。</li>
</ul>
</li>
<li>关联<ul>
<li>非常弱的关系，包含聚合和组合两种关系。如果B类对象是A类对象的成员变量，那B类和A类就是关联关系。</li>
</ul>
</li>
<li>依赖<ul>
<li>比关联关系更弱的关系，包含关联关系。只要B类对象和A类对象有任何使用关系都称他们有依赖关系。 </li>
</ul>
</li>
</ul>
</li>
<li>类组装起来并提供入口<ul>
<li>独立系统为main函数</li>
<li>web应用就是一组给外部调用的API接口</li>
</ul>
</li>
</ul>
<h2 id="分析示例"><a href="#分析示例" class="headerlink" title="分析示例"></a>分析示例</h2><p>下面用一个接口鉴权进行示例分析。</p>
<h3 id="一、需求分析"><a href="#一、需求分析" class="headerlink" title="一、需求分析"></a>一、需求分析</h3><h4 id="1-基础分析"><a href="#1-基础分析" class="headerlink" title="1.基础分析"></a>1.基础分析</h4><p>对于鉴权最简单的解决方案就是通过用户名密码来做认证，给每一个调用服务的调用方派发一个应用名和一个对应的密码/秘钥。调用方每次请求时携带自己的AppID和秘钥。服务端接收接口请求后解析出AppID和密码跟存储在服务端的账号密码比对，如果一致说明认证成功，允许接口调用请求；否则拒绝接口调用请求。</p>
<h4 id="2-分析优化"><a href="#2-分析优化" class="headerlink" title="2. 分析优化"></a>2. 分析优化</h4><p>由于使用上面的方式需要明文传输密码，密码很容易被截获，是不安全的。那么对密码加密是否就安全了呢？实际上这样也是不安全的，因为加密后的AppID和密码照样可以被黑客截获，黑客可以携带这个加密之后的密码以及对应的AppID伪装成已经认证的系统来访问服务端接口。这就是典型的[重放攻击][1]。<br>上面讲到了在设计功能时需了解下相关功能的最佳实践，而关于接口鉴权主要有JWT （适用安全不太敏感的应用）和OAuth2（授权的开放网络标准协议），刚刚这个问题，可以借助OAuth的验证思路来解决。调用方在进行接口请求的时候，将请求接口的URl、AppID、密码拼接到一块然后进行加密，生成一个token。调用方进行接口请求时将这个token及AppID等不敏感的参数信息,随URL一块传递给服务端。服务端接收请求后，根据AppID从数据库取出对应的密码，通过同样的Token生成算法，生成另一个token。用这个新生成的token跟调用方传递过来的toekn对比。如果一致则允许接口调用请求；否则，拒绝接口调用。</p>
<h4 id="3-再分析"><a href="#3-再分析" class="headerlink" title="3.再分析"></a>3.再分析</h4><p>这样设计还是存在重放攻击的风险，还是不够安全。每个URL拼接AppID、密码生成的token都是固定的。未认证系统截获URL、token和AppID之后，还是可以通过重放攻击的方式，伪装成认证系统调用这个URL对应的接口。<br>此时可以引入一个随机变量，让每一次接口请求生产的token都不一样。这里可以使用时间戳来作为随机变量。原来token是对URL、AppID密码三者进行加密生成的，现在将密码、AppID、时间戳随URL一并传递给服务端。<br>服务端接收数据后，可以根据当前时间和传递过来的时间戳，是否在一定时间窗口内（比如1分钟），如果超过1分钟，则判定token过期，拒绝接口请求。</p>
<h4 id="4-分析再优化"><a href="#4-分析再优化" class="headerlink" title="4.分析再优化"></a>4.分析再优化</h4><p>这里可能会有疑问，加了时间校验还是不够安全，未认证系统还是可以在一分钟的token失效窗口内通过截获请求、重放攻击调用服务端接口。<br>虽然这个方案还有漏洞但是实现起来比较简单，并且也不会过度影响接口本身的性能，攻与防之间本来就没有绝对的安全。我们能做的就是尽量提高攻击的成本，所以这个方案算算比较折中合理的了。<br>但是此处还有一个问题是，因为加密方式有可能使用的是通用的加密方式比如md5、SHA（不可逆加密），Base64(可逆加密)等，如果使用了可逆的加密算法黑客在截获了请求后还是可以通过尝试使用通用的加密方式来获取用户名和密码。并且上面的认证流程并不需要客户端传递真正的密码，只需要和服务端认证时token一致就可以了，所以此时我们可以使用用户的密码作为[盐][2]对URL、AppID、时间戳进行加密。服务端接收请求后取出服务端存储的密码按照同样的方式使用密码作为秘钥进行加密对token进行验证。<br>另外用户每次进行请求都要访问数据库获取用户密码，该操作过于费时，因此最好将其配置到内存数据中，如配置文件中，启动时加载到内存中或者Redis,Zookeeper等。</p>
<h4 id="5-最终需求确定"><a href="#5-最终需求确定" class="headerlink" title="5.最终需求确定"></a>5.最终需求确定</h4><ul>
<li>调用方进行接口请求时将URL、AppID、时间戳拼接到一起，通过根据密码通过加密算法生成toekn，并且将token、AppID、时间戳、拼接在URL中，一并发送到服务端。</li>
<li>服务端接收请求后，从请求中拆解出token、AppID、时间戳。</li>
<li>服务端先校验传递过来的时间戳跟当前时间是否在token的失效窗口内。如果已经超过失效时间，就算鉴权失败，拒绝接口调用请求。</li>
<li>如果token验证没有过期失效，服务端再从春初中取出AppID对应的密码，通过同样的toekn生成算法，生成另外一个token，与调用发传递过来的toekn进行匹配；如果一致则鉴权成功，允许接口调用，否则拒绝接口调用。</li>
</ul>
<h3 id="二、类的划分"><a href="#二、类的划分" class="headerlink" title="二、类的划分"></a>二、类的划分</h3><p> 根据需求将需求拆解成功能点进行罗列：</p>
<ol>
<li>把URL、AppID、时间戳拼接为一个字符串；</li>
<li>对字符串进行加密生成token；</li>
<li>将toekn、AppID、时间戳拼到URL中，形成新的URL；</li>
<li>解析URL得到toekn、AppID、时间戳等信息；</li>
<li>存储中取出AppID和对应的密码；</li>
<li>验证toekn是否过期；</li>
<li>验证toekn是否匹配；</li>
</ol>
<p>其中1、2、6、7都是跟toekn有关；5是操作AppID和密码；3、4在处理URL，所以此处可粗略的拆分为3个核心类：Token、Url、CredentialStorage。Token实现1、2、6、7操作；Url负责3、4操作、CredentialStorage负责5这个操作。</p>
<h3 id="三、属性方法"><a href="#三、属性方法" class="headerlink" title="三、属性方法"></a>三、属性方法</h3><p>Token类相关功能点有四个：</p>
<ol>
<li>把URL、AppID、时间戳拼接为一个字符串；</li>
<li>对字符串通过加密算法加密生成 token；</li>
<li>根据时间戳判断 token 是否过期失效；</li>
<li>验证两个 token 是否匹配。</li>
</ol>
<p>根据功能点涉及名词作为候选实行，动词作为候选方法，进行筛选。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AuthToken类</span><br><span class="line">属性</span><br><span class="line"> private final static long TIME_OUT_VALUE = 1 * 60 * 1000; //1min</span><br><span class="line">private long createTime;</span><br><span class="line">private long expiredTimeInterval = TIME_OUT_VALUE;</span><br><span class="line">private String token;</span><br><span class="line">构造函数</span><br><span class="line">public AuthToken(String token, long createTime) ;</span><br><span class="line">public AuthToken(String token, long createTime，long expiredTimeInterval) ;</span><br><span class="line">函数</span><br><span class="line">public boolean isExpired()；//时间校验</span><br><span class="line">public String getToken()；//获取token</span><br><span class="line">public static AuthToken generate(String originalUrl, long createTime, String userID,String pwd )；//生成token</span><br><span class="line">public boolean match(AuthToken authToken)；//token比对</span><br></pre></td></tr></table></figure></p>
<p>从业务模型上说，不应该属于这个类的属性和方法，不应该放到这个类里。比如URL、AppID、时间戳这几个名词，此处将它们作为方法参数。<br>在此之外还需要挖掘没有出现在功能点描述中的属性，如createTime，expireTimeInterval，用作tokenn超时判断。</p>
<h4 id="Url类相关功能点"><a href="#Url类相关功能点" class="headerlink" title="Url类相关功能点"></a>Url类相关功能点</h4><ol>
<li>将token、AppID、时间戳拼接到URL形成新的URL；</li>
<li>解析URL得到toekn、AppID、时间戳等信息；</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">属性</span><br><span class="line">private String originalUrl;</span><br><span class="line">private String appId;</span><br><span class="line">private long timestamp;</span><br><span class="line">private String token;</span><br><span class="line">构造函数</span><br><span class="line"> public ApiRequest(String originalUrl, String appId, long timestamp, String token) ；</span><br><span class="line">函数</span><br><span class="line">public static ApiRequest buildFromUrl(String url)；</span><br><span class="line">public String getUrl()；</span><br><span class="line">public String getToken()；</span><br><span class="line">public long getTimestamp()；</span><br><span class="line">public String getUrl()；</span><br></pre></td></tr></table></figure>
<h4 id="CredentialStorage-类相关功能点"><a href="#CredentialStorage-类相关功能点" class="headerlink" title="CredentialStorage 类相关功能点"></a>CredentialStorage 类相关功能点</h4><ol>
<li>从存储中获取AppID和对应的密码</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CredentialStorage接口</span><br><span class="line">public String getPasswordByAppId(String appId)；</span><br></pre></td></tr></table></figure>
<h3 id="四、交互关系"><a href="#四、交互关系" class="headerlink" title="四、交互关系"></a>四、交互关系</h3><p>将类组装起来提供执行入口，利用UML中的依赖组合关系进行设计。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApiAuthenticator</span> </span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">auth</span><span class="params">(String url)</span></span>; </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">auth</span><span class="params">(ApiRequest apiRequest)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultApiAuthenticatorImpl</span> <span class="keyword">implements</span> <span class="title">ApiAuthenticator</span> </span>&#123; </span><br><span class="line"><span class="keyword">private</span> CredentialStorage credentialStorage; </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultApiAuthenticator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.credentialStorage = <span class="keyword">new</span> MysqlCredentialStorage(); </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultApiAuthenticator</span><span class="params">(CredentialStorage credentialStorage)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">this</span>.credentialStorage = credentialStorage;</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">auth</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">    ApiRequest apiRequest = ApiRequest.buildFromUrl(url); auth(apiRequest);</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">auth</span><span class="params">(ApiRequest apiRequest)</span> </span>&#123;</span><br><span class="line">    String appId = apiRequest.getAppId(); String token = apiRequest.getToken(); </span><br><span class="line">    <span class="keyword">long</span> timestamp = apiRequest.getTimestamp(); </span><br><span class="line">    String originalUrl = apiRequest.getOriginalUrl(); AuthToken     clientAuthToken = <span class="keyword">new</span> AuthToken(token, timestamp); </span><br><span class="line">    <span class="keyword">if</span> (clientAuthToken.isExpired()) &#123; </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Token is expired."</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    String password = credentialStorage.getPasswordByAppId(appId);</span><br><span class="line">    AuthToken serverAuthToken = AuthToken.generate(originalUrl, appId, pwd);</span><br><span class="line">    <span class="keyword">if</span> (!serverAuthToken.match(clientAuthToken)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Token verfication failed."</span>); </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="五、入口"><a href="#五、入口" class="headerlink" title="五、入口"></a>五、入口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String req = <span class="string">"doLogin?"</span></span><br><span class="line">            + <span class="string">"AppID=tom"</span></span><br><span class="line">            + <span class="string">"&amp;Token=xxty6vVxQDuW6r2by9xR29kZRk4="</span></span><br><span class="line">            + <span class="string">"&amp;Timestamp=1578306433558"</span>;</span><br><span class="line"></span><br><span class="line">    ApiAuthenticator authencator = <span class="keyword">new</span> DefaultApiAuthenticatorImpl();</span><br><span class="line">    authencator.auth(req);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码地址：<a href="https://github.com/cmevolve/carryOn/tree/master/AuthforToken" target="_blank" rel="noopener">https://github.com/cmevolve/carryOn/tree/master/AuthforToken</a><br>  [1]: <a href="https://baike.baidu.com/item/%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB" target="_blank" rel="noopener">https://baike.baidu.com/item/%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB</a><br>  [2]: <a href="https://zh.wikipedia.org/wiki/%E7%9B%90_%28%E5%AF%86%E7%A0%81%E5%AD%A6%29" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E7%9B%90_%28%E5%AF%86%E7%A0%81%E5%AD%A6%29</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2020/01/04/因使用错误的时间转换导致跨年的时间BUG/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     207 字
	</span>
	<span title="阅读时长">
     1 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/04/因使用错误的时间转换导致跨年的时间BUG/" itemprop="url">因使用错误的时间转换导致跨年的时间BUG</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-04T21:01:42+08:00">
                2020-01-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/04/因使用错误的时间转换导致跨年的时间BUG/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/04/因使用错误的时间转换导致跨年的时间BUG/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  207
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>跨年了闲着无事逛社区的时候发现有好多人在修复BUG，关于YYYY-MM-dd的使用而出现的问题，因此实验一番进行记录防止入坑。</p>
<h2 id="BUG代码"><a href="#BUG代码" class="headerlink" title="BUG代码"></a>BUG代码</h2><p>运行环境JDK1.8<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SimpleDateFormat sf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"YYYY-MM-dd"</span>);</span><br><span class="line">SimpleDateFormat sf1 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">Calendar calendar1 = Calendar.getInstance();</span><br><span class="line">calendar1.add(Calendar.DATE, -<span class="number">4</span>);</span><br><span class="line">System.out.println(sf.format(calendar1.getTime()));</span><br><span class="line">System.out.println(sf1.format(calendar1.getTime()));</span><br><span class="line">--执行结果</span><br><span class="line"><span class="number">2020</span>-<span class="number">12</span>-<span class="number">29</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">12</span>-<span class="number">29</span></span><br></pre></td></tr></table></figure></p>
<h2 id="BUG原因"><a href="#BUG原因" class="headerlink" title="BUG原因"></a>BUG原因</h2><p>YYYY 是 Week-based-year<br>Week-based-year意思是当天所在的周属于的年份，一周从周日开始，周六结束，只要本周跨年，那么这周就算入下一年，例如2019.12.29 是周日，而周三就是跨年了，所以此时29，30，31日使用YYYY获取的时间都是下一年的时间2020年，而使用yyyy就会显示正常的时间2019。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2019/12/12/负载均衡策略问题导致服务宕机（记一次生产问题）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     3.4k 字
	</span>
	<span title="阅读时长">
     13 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/12/负载均衡策略问题导致服务宕机（记一次生产问题）/" itemprop="url">负载均衡策略问题导致服务宕机（记一次生产问题）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-12T23:41:37+08:00">
                2019-12-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/避坑指南/" itemprop="url" rel="index">
                    <span itemprop="name">避坑指南</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/避坑指南/算法与数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">算法与数据结构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/避坑指南/算法与数据结构/计算机网络/" itemprop="url" rel="index">
                    <span itemprop="name">计算机网络</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/12/负载均衡策略问题导致服务宕机（记一次生产问题）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/12/12/负载均衡策略问题导致服务宕机（记一次生产问题）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一-问题"><a href="#一-问题" class="headerlink" title="一.问题"></a>一.问题</h2><p>2019年12月4日上午11点左右收到线上报警，核心服务CPU使用率达到了3000%，看了下进程的线程信息都是active。因为使用的容器是weblogic，所以在console平台查看线程相关信息。<br>信息整理如下：</p>
<ul>
<li>活动线程43个，队列的长度已经到了23个</li>
<li>数据库连接为不可用连接数为5，活动连接数为5，可用连接数为15</li>
<li>线程池 线程空闲指标大部分都是false（暂时不可用）</li>
<li>查看线程池 不可用连接执行操作为请求CAS或者或者请求portal</li>
<li>查看转储线程堆栈,部分异常信息如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"[ACTIVE] ExecuteThread: '2' for queue: 'weblogic.kernel.Default (self-tuning)'"</span> id=<span class="number">34</span> idx=<span class="number">0xec</span> tid=<span class="number">23897</span> prio=<span class="number">5</span> alive, native_blocked, daemon</span><br><span class="line">at java/util/HashMap.put(HashMap.java:<span class="number">468</span>)[optimized]</span><br><span class="line">at org/jasig/cas/client/session/HashMapBackedSessionMappingStorage.addSessionById(HashMapBackedSessionMappingStorage.java:<span class="number">36</span>)[optimized]</span><br><span class="line">at org/jasig/cas/client/session/SingleSignOutFilter.doFilter(SingleSignOutFilter.java:<span class="number">95</span>)[optimized]</span><br><span class="line">at weblogic/servlet/internal/FilterChainImpl.doFilter(FilterChainImpl.java:<span class="number">56</span>)[optimized]</span><br><span class="line">at com/isoftstone/iaeap/web/filter/SetCharacterEncodingFilter.doFilter(SetCharacterEncodingFilter.java:<span class="number">105</span>)[optimized]</span><br><span class="line">at weblogic/servlet/internal/FilterChainImpl.doFilter(FilterChainImpl.java:<span class="number">56</span>)[inlined]</span><br><span class="line">at weblogic/servlet/internal/WebAppServletContext$ServletInvocationAction.wrapRun(WebAppServletContext.java:<span class="number">3730</span>)[inlined]</span><br><span class="line">at weblogic/servlet/internal/WebAppServletContext$ServletInvocationAction.run(WebAppServletContext.java:<span class="number">3696</span>)[optimized]</span><br><span class="line">at weblogic/security/acl/internal/AuthenticatedSubject.doAs(AuthenticatedSubject.java:<span class="number">321</span>)[optimized]</span><br><span class="line">at weblogic/security/service/SecurityManager.runAs(SecurityManager.java:<span class="number">120</span>)[inlined]</span><br><span class="line">at weblogic/servlet/internal/WebAppServletContext.securedExecute(WebAppServletContext.java:<span class="number">2273</span>)[inlined]</span><br><span class="line">at weblogic/servlet/internal/WebAppServletContext.execute(WebAppServletContext.java:<span class="number">2179</span>)[optimized]</span><br><span class="line">at weblogic/servlet/internal/ServletRequestImpl.run(ServletRequestImpl.java:<span class="number">1490</span>)[optimized]</span><br><span class="line">at weblogic/work/ExecuteThread.execute(ExecuteThread.java:<span class="number">256</span>)[optimized]</span><br><span class="line">at weblogic/work/ExecuteThread.run(ExecuteThread.java:<span class="number">221</span>)</span><br><span class="line">at jrockit/vm/RNI.c2java(JJJJJ)V(Native Method)</span><br><span class="line">-- end of trace</span><br><span class="line"><span class="string">"GC Daemon"</span> id=<span class="number">35</span> idx=<span class="number">0xf0</span> tid=<span class="number">23903</span> prio=<span class="number">2</span> alive, waiting, native_blocked, daemon</span><br><span class="line">-- Waiting <span class="keyword">for</span> notification on: sun/misc/GC$LatencyLock@<span class="number">0x51155130</span>[fat lock]</span><br><span class="line">at jrockit/vm/Threads.waitForNotifySignal(JLjava/lang/Object;)Z(Native Method)</span><br><span class="line">at java/lang/Object.wait(J)V(Native Method)</span><br><span class="line">at sun/misc/GC$Daemon.run(GC.java:<span class="number">100</span>)</span><br><span class="line">^-- Lock released <span class="keyword">while</span> waiting: sun/misc/GC$LatencyLock@<span class="number">0x51155130</span>[fat lock]</span><br><span class="line">at jrockit/vm/RNI.c2java(JJJJJ)V(Native Method)</span><br><span class="line">-- end of trace</span><br></pre></td></tr></table></figure>
<p>此时发现熟悉的身影，因为项目引用的是cas-client3.1.3版本的jar包，其中存储session的数据结构是HashMap，且操作时未进行加锁，之前别的核心的小伙伴已经因为多线程环境下触发HashMap扩容死循环问题的BUG宕机过一次，此时看到这里立马确认CPU飙升罪魁祸首是这个jar包。</p>
<p><strong>经过确认，核心一共9台服务器，其中4台为前端应用服务，CPU飙升的服务器正是这4台。</strong></p>
<h2 id="2-曲折"><a href="#2-曲折" class="headerlink" title="2.曲折"></a>2.曲折</h2><p>  当有了一把锤子看什么都是钉子，因为此时心中已经认定是jar导致问题，所以看着服务器的各种异像都觉得符合逻辑。只是心中有些纳闷为何jar包问题这么久了都没有触发HashMap扩容死循环的bug，怎么单单就这次服务重启不过几十分钟CPU就又直线飙升。<br>  在服务器刚重启完的时候此时收到一个信息，有出单员页面部分资源打不开了。开了network跟了下发现部分资源返回404，页面间不涉及到数据加载的页面跳转无异，但是点击查询时页面就会卡死，而此时该进程的CPU也会上升。这个时候就有点诡异，之前的猜测跟目前情形好像并无关联。<br>到了中午使用的人数少了一些抱着病急乱投医，总得做点什么的心态，将jar包更新到3.5升级了上去，经过了几个小时CPU仍然状态稳定，心中长舒了一口气。<br>好景不长，没过多久又有出单员反馈页面卡死问题，此时看了一下线程吓了一跳，多个线程触发GC，后台日志多处报错提示OOM。赶紧看了下源码，发现原来jar包中有一个守护线程来定时触发删除过期的session，而新的jar包去除了此方法，而留了一个clean的方法清理session。猜测到可能是因为没有显式调用该方法导致的内存泄漏，并且并没有解决前端资源丢失加载不出页面，还是紧急将jar包替换了回来，重新查找原因。</p>
<h2 id="3-整理线索"><a href="#3-整理线索" class="headerlink" title="3.整理线索"></a>3.整理线索</h2><h3 id="3-1"><a href="#3-1" class="headerlink" title="3.1"></a>3.1</h3><p>重新梳理了下系统的日志，发现了除了正常的业务流程异常外还有一个异常信息比较可疑。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="number">2019</span>-<span class="number">12</span>-<span class="number">5</span> 下午<span class="number">02</span>时<span class="number">35</span>分<span class="number">41</span>秒 CST&gt; &lt;Error&gt; &lt;HTTP&gt; &lt;BEA-<span class="number">101020</span>&gt; &lt;[ServletContext@<span class="number">199457131</span>[app:pcisv7 <span class="keyword">module</span>:WebRoot path:/pcisv7 spec-version:<span class="number">2.5</span>]] Servlet failed with Exception</span><br><span class="line">java.lang.NullPointerException</span><br><span class="line">	at jsp_servlet._core.__header._jspService(__header.java:<span class="number">295</span>)</span><br><span class="line">	at weblogic.servlet.jsp.JspBase.service(JspBase.java:<span class="number">34</span>)</span><br><span class="line">	at weblogic.servlet.internal.StubSecurityHelper$ServletServiceAction.run(StubSecurityHelper.java:<span class="number">227</span>)</span><br><span class="line">	at weblogic.servlet.internal.StubSecurityHelper.invokeServlet(StubSecurityHelper.java:<span class="number">125</span>)</span><br><span class="line">	at weblogic.servlet.internal.ServletStubImpl.execute(ServletStubImpl.java:<span class="number">301</span>)</span><br><span class="line">	Truncated. see log file <span class="keyword">for</span> complete stacktrace</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>找到了weblogic缓存目录下的文件和测试环境文件比对了下也并没有区别，此文件也没有涉及过开发改动。查看了下源码，找到了一处可能发生空指针的地方：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line"> IUserDetails userDetails = CurrentUser.getUser();</span><br><span class="line"> String operCnm = userDetails.getOpCnm();</span><br><span class="line"> String companyCnm = userDetails.getCompanyCnm();</span><br><span class="line"> <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"> GrtRightService grtRightService =(GrtRightService)SpringUtils.getSpringBean(<span class="string">"grtRightService"</span>);</span><br><span class="line"> List&lt;GrtMenuVO&gt; lstMenuVo=<span class="keyword">null</span>;</span><br><span class="line"> <span class="keyword">try</span>&#123;</span><br><span class="line">   lstMenuVo = grtRightService.getPermissionRootMenus();</span><br><span class="line">   <span class="keyword">if</span>(lstMenuVo ==<span class="keyword">null</span> || lstMenuVo.size()==<span class="number">0</span>)&#123;</span><br><span class="line">	   out.println(<span class="string">"&lt;script type='text/javascript'&gt;parent.window.location ='./common/error/errorinfo.html';&lt;/script&gt;"</span>);</span><br><span class="line">	   <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">   e.printStackTrace();</span><br><span class="line"> &#125;</span><br><span class="line">  String skin = (String)request.getSession().getAttribute(<span class="string">"ISOFTSTONESKIN"</span>);</span><br><span class="line">  String rootPath = request.getContextPath();</span><br><span class="line">  String companyId = userDetails.getCompanyId();</span><br><span class="line">  String[] companyIds =userDetails.getCompanyIds();</span><br><span class="line">  String[] companyCnms =userDetails.getCompanyCnms();</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></p>
<p>17行的skin 中是从session中取值，如果session没有set此处使用会产生空指针，从而导致页面部分资源加载不出来。向上查了一下代码，在session中存放ISOFTSTONESKIN的地方是登陆首页时存放，跳转到目标页面后获取的。查看了下源码ISOFTSTONESKIN的值也是设置的默认值，当时考虑了下并没有考虑到什么场景会导致session中的ISOFTSTONESKIN失效，就在代码中对该变量重新赋值了下。<strong>（其实在这个场景时就已经初步能看出来一些问题，既session丢失问题）</strong></p>
<h3 id="3-2"><a href="#3-2" class="headerlink" title="3.2"></a>3.2</h3><p>因为考虑到是因为CAS登陆导致的使用cas-client jar包产生的CPU使用率问题，考虑了下，决定先将核心模块从cas登陆中拿出，启用spring security验证登陆。<br>applicationContext.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"applicationContext-spring-security.xml"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;import resource="applicationContext-spring-security-cas-ns.xml"/&gt; 启用单点登录时使用些配置文件--&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>重新启动后，CPU使用率正常，header等几个从session取值的页面因为设置了默认值，也暂时没有出现空指针问题。但是出现了使用不到几分钟，就会跳转到登陆页面，提示重新登陆。<strong>(操作的页面没有嵌入别的系统页面，不存在跨系统登陆问题)</strong><br>看了眼核心session失效时间<br>web.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>300<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>顺便看了下CAS的 Ticket超时时间<br>ticketExpirationPolicies.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"grantingTicketExpirationPolicy"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.ticket.support.TimeoutExpirationPolicy"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span>  <span class="attr">value</span>=<span class="string">"7200000"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>CAS的session超时时间<br>web.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>300<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>核心系统客户端的session失效时间设置的半小时，cas的session失效时间是半小时，ticket的票据失效时间是两小时。移除了CAS的认证后半小时内操作是不会登出的，但是实际场景操作过程中就出现跳转到登陆页面的情况。<strong>（session方面的问题愈发明显，但是急于将问题解决，与真相一次次擦肩而过）</strong></p>
<h3 id="3-3"><a href="#3-3" class="headerlink" title="3.3"></a>3.3</h3><p>此时怀疑是网络负载方面的问题，因为系统切换了IPV6考虑到会产生的影响，决定将核心系统加入CAS验证，并且前端节点只开一个处理请求，进行观察。（因负责网络的同事当时不在，只是初步怀疑是IPV6的影响，后续经过确认只改造了公司官网，其余系统并未改造。）<br>开单节点运行了一上午发现CPU稳定，页面加载也再没有出现加载异常，开双节点时就会出现加载异常的情况。由此找到问题原因是负载均衡将客户端X请求转发到某台实例A的时候，由于未知原因将网络请求转发至另一服务器B。导致本应该存在于session的值直接访问另一台服务器时该值并不存在，因为客户端浏览器未关闭的原因，ticket会存在于header头中,转发请求至新的服务时，校验并没有登陆便会去CAS认证一次,但是并不会要求用户重新登陆。<br>负载是由citrix进行硬件方面的负载，它与Nginx软件负载功能类似，只是功能更加强劲，其中大部分的负载策略是一致的。查看了下负载策略使用的是least_conn最小连接数，会话保持时间为两分钟。该策略使用了很长时间都没有问题，考虑到使用iphash会导致服务分部不均，所以未做改动，仅将连接的会话时间修改为了30分钟，同session过期时间保持同步。<strong>（会话时间既将用户请求负载至某一IP，若在会话时间内如果有操作，则会话保持，若没有操作则会话断开，重新请求时将重新对其进行转发）</strong></p>
<h2 id="4-问题总结"><a href="#4-问题总结" class="headerlink" title="4.问题总结"></a>4.问题总结</h2><p>至此问题已经找到了，对于其中相关问题进行分析梳理。</p>
<ol>
<li>因为执行某些操作或者在页面中静止导致两分钟内没有与后台进行交互，再次操作时因为citrix使用最小连接数的策略会将新的请求负载至另一台服务器。</li>
<li>该服务器取出sessionID校验是否通过了登陆验证，浏览器Cookie中并没有缓存该台服务器的sessionID，验证失败，此时重定向请求至CAS服务，因CAS服务只有单台并且该浏览器已经通过了认证，此时访问通过Cookie直接认证通过，跳转到了目标页面。（此时还存在一个场景就是CAS的session也过期了，跳转到单点登录地址，带着ticket参数去验证用户，如果单点登录验证到ticket没过期，就不会去登录页面，但是会刷新当前页，因为从单点登录地址重定向到了当前页面地址。所以使用时的感觉就是长时间不操作时，点击页面元素会出现刷新页面的情况。）</li>
<li>因为在登陆页面中缓存在session中的一些默认值，重新登陆后直接跳转到了目标页面所以并没有缓存，jsp此时加载时就产生了资源丢失，后台报错空指针的情况。</li>
<li>而因为负载频繁的将请求转发，也导致出现了类似大规模登陆的场景（多次去CAS认证，认证通过将session缓存）因为CAS-Client.jar缓存使用的数据结构是HashMap，并且移除和添加缓存操作都没有加锁，导致HashMap出现扩容死循环问题。</li>
</ol>
<h2 id="5-浏览器访问过程"><a href="#5-浏览器访问过程" class="headerlink" title="5.浏览器访问过程"></a>5.浏览器访问过程</h2><p>详细流程：<a href="https://4ark.me/post/b6c7c0a2.html" target="_blank" rel="noopener">https://4ark.me/post/b6c7c0a2.html</a><br>流程图：<br><img src="https://ftp.bmp.ovh/imgs/2019/12/d1ecc658b38ca606.jpg" alt="浏览器访问流程"><br>cas：<a href="https://www.cnblogs.com/notDog/p/5276643.html" target="_blank" rel="noopener">https://www.cnblogs.com/notDog/p/5276643.html</a><br><a href="http://www.voidcn.com/article/p-waqcmlak-bqr.html" target="_blank" rel="noopener">http://www.voidcn.com/article/p-waqcmlak-bqr.html</a></p>
<h2 id="6-内容扩展"><a href="#6-内容扩展" class="headerlink" title="6.内容扩展"></a>6.内容扩展</h2><h3 id="IPV6与IPV4区别：https-blog-51cto-com-7658423-1339259"><a href="#IPV6与IPV4区别：https-blog-51cto-com-7658423-1339259" class="headerlink" title="IPV6与IPV4区别：https://blog.51cto.com/7658423/1339259"></a>IPV6与IPV4区别：<a href="https://blog.51cto.com/7658423/1339259" target="_blank" rel="noopener">https://blog.51cto.com/7658423/1339259</a></h3><h3 id="负载策略"><a href="#负载策略" class="headerlink" title="负载策略"></a>负载策略</h3><ul>
<li>轮询策略（轮询加权/round-robin）：加权轮询带有优先级，按照设置的权值分配请求比例。</li>
<li>ip hash ：针对IP地址hash决定下一请求转发至哪一服务（负载不均问题，使用一致性hash）</li>
<li>最少连接（least_conn) ：下一个请求将被分派到活动连接数量最少的服务器</li>
<li>url hash</li>
<li>随机Random</li>
<li>最短响应时间LRT ：通过ping等方式探测，请求分配给响应时间最短的服务。</li>
</ul>
<h3 id="虚拟IP"><a href="#虚拟IP" class="headerlink" title="虚拟IP"></a>虚拟IP</h3><p>使用一个未分配给真实主机的IP，与真实主机IP，热备主机IP加起来一共三个IP。在以太网中IP地址只是逻辑地址，真正传输的是MAC地址，而每台设备中都有一个ARP缓存，缓存中用来存储同一网络内IP地址和MAC地址对应关系，在向其他主机发送数据时会先从缓存中查询目标IP所对应的MAC地址，拿到MAC地址后向主机发送数据。<br>例如缓存内容：<br>主机A：192.168.0.3 at ec:f4:bb:49:s4:44<br>主机B：192.168.0.4 at ec:f4:bb:49:s5:64<br>虚拟Ip：192.168.0.5 at ec:f4:bb:49:s4:44<br>其中A，B为真实主机，对外提供服务的是A，B为热备，如果A宕机了那么通过心跳检测到A已经发生故障，此时主机B会将自己的ARP缓存发送出去，让路由器修改路由表，告知虚拟地址由A指向B。<br>更新后的缓存内容：<br>主机A：192.168.0.3 at ec:f4:bb:49:s4:44<br>主机B：192.168.0.4 at ec:f4:bb:49:s5:64<br>虚拟Ip：192.168.0.5 at ec:f4:bb:49:s5:64<br>此时再次访问虚拟IP时，机器B会变成主服务器，A降级为热备服务器。这就完成了主从切换，这个过程称之为<strong>IP漂移</strong>。<br>参考：<a href="http://xiaobaoqiu.github.io/blog/2015/04/02/xu-ni-iphe-ippiao-yi/" target="_blank" rel="noopener">http://xiaobaoqiu.github.io/blog/2015/04/02/xu-ni-iphe-ippiao-yi/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://iamlfc.top/2019/11/27/Docker-学习二-容器基本操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斯大炮">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/nini.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="邪恶小代码">
    </span>
	<span title="字数统计">
     1.7k 字
	</span>
	<span title="阅读时长">
     7 分钟
	</span>
    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/27/Docker-学习二-容器基本操作/" itemprop="url">Docker-学习二(容器基本操作)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-27T23:41:37+08:00">
                2019-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker容器/" itemprop="url" rel="index">
                    <span itemprop="name">Docker容器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/27/Docker-学习二-容器基本操作/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/27/Docker-学习二-容器基本操作/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="内容提要"><a href="#内容提要" class="headerlink" title="内容提要"></a>内容提要</h1><p>docker容器相关操作，包括容器启停，查看，删除，创建，导入导出，内存配置等。</p>
<h2 id="1-创建并启动容器"><a href="#1-创建并启动容器" class="headerlink" title="1.创建并启动容器"></a>1.创建并启动容器</h2><h3 id="1-新建容器"><a href="#1-新建容器" class="headerlink" title="1.新建容器"></a>1.新建容器</h3><p>可以使用<strong>docker create</strong>命令新建一个容器，例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker create -it ubuntu:latest</span><br></pre></td></tr></table></figure></p>
<h3 id="2-启动容器"><a href="#2-启动容器" class="headerlink" title="2.启动容器"></a>2.启动容器</h3><p>使用<strong>docker create</strong><br>命令新建的容器处于停止状态需要配合使用<strong>docker start</strong> 命令启动。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start ssf</span><br></pre></td></tr></table></figure></p>
<h3 id="3-新建并启动容器"><a href="#3-新建并启动容器" class="headerlink" title="3.新建并启动容器"></a>3.新建并启动容器</h3><p>可以使用docker run 命令来直接新建并启动容器。（如果本地镜像有则启动，没有则获取最新镜像）<br>这里用ubuntu镜像echo一个hello word<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run ubuntu /bin/echo 'Hello world'</span><br></pre></td></tr></table></figure></p>
<p>下面的命令启动一个bash终端，允许用户进行交互 并在后台运行：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d ubuntu:14.04 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>—P参数是随机指定一个32768～61000的主机端口与容器绑定，而－p则是指定一个端口与容器绑定<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80 nginx:v1.0</span><br></pre></td></tr></table></figure></p>
<h4 id="命令详解"><a href="#命令详解" class="headerlink" title="命令详解"></a>命令详解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">-a, --attach=[]             Attach to STDIN, STDOUT or STDERR</span><br><span class="line">--add-host=[]               Add a custom host-to-IP mapping (host:ip)</span><br><span class="line">--blkio-weight=0            Block IO (relative weight), between 10 and 1000</span><br><span class="line">-c, --cpu-shares=0          CPU shares (relative weight)</span><br><span class="line">--cap-add=[]                Add Linux capabilities</span><br><span class="line">--cap-drop=[]               Drop Linux capabilities</span><br><span class="line">--cgroup-parent=            Optional parent cgroup for the container</span><br><span class="line">--cidfile=                  Write the container ID to the file</span><br><span class="line">--cpu-period=0              Limit CPU CFS (Completely Fair Scheduler) period</span><br><span class="line">--cpu-quota=0               Limit the CPU CFS quota</span><br><span class="line">--cpuset-cpus=              CPUs in which to allow execution (0-3, 0,1)</span><br><span class="line">--cpuset-mems=              MEMs in which to allow execution (0-3, 0,1)</span><br><span class="line">-d, --detach=false          Run container in background and print container ID</span><br><span class="line">--device=[]                 Add a host device to the container</span><br><span class="line">--dns=[]                    Set custom DNS servers</span><br><span class="line">--dns-search=[]             Set custom DNS search domains</span><br><span class="line">-e, --env=[]                Set environment variables</span><br><span class="line">--entrypoint=               Overwrite the default ENTRYPOINT of the image</span><br><span class="line">--env-file=[]               Read in a file of environment variables</span><br><span class="line">--expose=[]                 Expose a port or a range of ports</span><br><span class="line">-h, --hostname=             Container host name</span><br><span class="line">--help=false                Print usage</span><br><span class="line">-i, --interactive=false     Keep STDIN open even if not attached</span><br><span class="line">--init=                     Run container following specified init system container method (systemd)</span><br><span class="line">--ipc=                      IPC namespace to use</span><br><span class="line">-l, --label=[]              Set meta data on a container</span><br><span class="line">--label-file=[]             Read in a line delimited file of labels</span><br><span class="line">--link=[]                   Add link to another container</span><br><span class="line">--log-driver=               Logging driver for container</span><br><span class="line">--log-opt=[]                Log driver options</span><br><span class="line">--lxc-conf=[]               Add custom lxc options</span><br><span class="line">-m, --memory=               Memory limit</span><br><span class="line">--mac-address=              Container MAC address (e.g. 92:d0:c6:0a:29:33)</span><br><span class="line">--memory-swap=              Total memory (memory + swap), &apos;-1&apos; to disable swap</span><br><span class="line">--name=                     Assign a name to the container</span><br><span class="line">--net=bridge                Set the Network mode for the container</span><br><span class="line">--oom-kill-disable=false    Disable OOM Killer</span><br><span class="line">-P, --publish-all=false     Publish all exposed ports to random ports</span><br><span class="line">-p, --publish=[]            Publish a container&apos;s port(s) to the host</span><br><span class="line">--pid=                      PID namespace to use</span><br><span class="line">--privileged=false          Give extended privileges to this container</span><br><span class="line">--read-only=false           Mount the container&apos;s root filesystem as read only</span><br><span class="line">--restart=no                Restart policy to apply when a container exits</span><br><span class="line">--rm=false                  Automatically remove the container when it exits</span><br><span class="line">--security-opt=[]           Security Options</span><br><span class="line">--sig-proxy=true            Proxy received signals to the process</span><br><span class="line">-t, --tty=false             Allocate a pseudo-TTY</span><br><span class="line">-u, --user=                 Username or UID (format: &lt;name|uid&gt;[:&lt;group|gid&gt;])</span><br><span class="line">--ulimit=[]                 Ulimit options</span><br><span class="line">--uts=                      UTS namespace to use</span><br><span class="line">-v, --volume=[]             Bind mount a volume</span><br><span class="line">--volumes-from=[]           Mount volumes from the specified container(s)</span><br><span class="line">-w, --workdir=              Working directory inside the container</span><br></pre></td></tr></table></figure>
<h2 id="2-终止容器"><a href="#2-终止容器" class="headerlink" title="2.终止容器"></a>2.终止容器</h2><h3 id="1-容器终止"><a href="#1-容器终止" class="headerlink" title="1.容器终止"></a>1.容器终止</h3><p>可以使用docker stop来终止运行中的容器，格式为：<br><strong>docker stop[-t|–time[=10]][CONTAINER…]</strong><br>首先会向容器发送SIGTERM信号，等待一段超时时间（默认为 10秒）后，再发送 SIGKILL 信号来终止容器。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop ce5</span><br></pre></td></tr></table></figure></p>
<p>使用 docker kill 命令直接强行终止容器。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker kill ce5</span><br></pre></td></tr></table></figure></p>
<h3 id="2-容器重启"><a href="#2-容器重启" class="headerlink" title="2.容器重启"></a>2.容器重启</h3><p>终止状态的容器可以使用docker start 启动<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start ce5</span><br></pre></td></tr></table></figure></p>
<p>在运行状态的容器可以使用docker restart重启<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart ce5</span><br></pre></td></tr></table></figure></p>
<h2 id="3-进入容器"><a href="#3-进入容器" class="headerlink" title="3.进入容器"></a>3.进入容器</h2><p>进入容器有三种方法，其中主要<strong>推荐使用第一种exec方法</strong>，其他方法了解作用即可。</p>
<h3 id="1-exec命令-重点"><a href="#1-exec命令-重点" class="headerlink" title="1.exec命令(重点)"></a>1.exec命令(<strong>重点</strong>)</h3><p>Docker从1.3.0版本起提供了一个更加方便的exec命令，可以在容器内直接执行任意命令。该命令的基本格式为：<br><strong>docker exec [-d|–detach] [–detach-keys[=[]]] [-i|–interactive] [–privileged]<br>[-t|–tty] [-u|–user[=USER]] CONTAINER COMMAND</strong> [ARG…] 。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 243c32535da7 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>通过指定- it 参数来保持标准输入打开，并且分配一个伪终端。</p>
<h4 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">·-i，--interactive=true| false：打开标准输入接受用户输入命令，默认为false；</span><br><span class="line">·--privileged=true| false：是否给执行命令以高权限，默认为false；</span><br><span class="line">·-t，--tty=true| false：分配伪终端，默认为false；</span><br><span class="line">·- u，--user=&quot;&quot;：执行命令的用户名或ID。</span><br></pre></td></tr></table></figure>
<h3 id="2-attach命令"><a href="#2-attach命令" class="headerlink" title="2.attach命令"></a>2.attach命令</h3><p>命令格式：<strong>docker attach [–detach-keys[=[]]] [–no-stdin] [–sig-proxy[=true]] CONTAINER</strong><br>支持三个主要选项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">·--detach-keys[=[]]：指定退出attach 模式的快捷键序列，默认是 CTRL-p CTRL-q；</span><br><span class="line">·--no-stdin=true| false：是否关闭标准输入，默认是保持打开；</span><br><span class="line">·--sig-proxy=true| false：是否代理收到的系统信号给应用进程，默认为true</span><br></pre></td></tr></table></figure></p>
<p>使用示例：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach myredis</span><br></pre></td></tr></table></figure></p>
<p>当多个窗口同时用attach命令连到同一个容器的时候，所有窗口都会同步显示。当某个窗口因命令阻塞时，其他窗口也无法执行操作了。</p>
<h3 id="3-nsenter工具"><a href="#3-nsenter工具" class="headerlink" title="3.nsenter工具"></a>3.nsenter工具</h3><p>在util-linux 软件包版本2.23+中包含nsenter工具。如果系统中的 util-linux包没有该命令需下载。（略…）</p>
<h3 id="4-容器操作"><a href="#4-容器操作" class="headerlink" title="4. 容器操作"></a>4. 容器操作</h3><p>在容器中操作时，使用ps 报错，是因为ps没有安装在基础wheezy图像。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install procps</span><br></pre></td></tr></table></figure></p>
<p><strong>同样在容器中安装vim等工具时，需要先使用apt-get update 同步一下容器内和服务器的更新源，才可安装。</strong></p>
<h2 id="4-删除容器"><a href="#4-删除容器" class="headerlink" title="4.删除容器"></a>4.删除容器</h2><p>使用docker rm 命令删除处于终止或者退出状态的容器。命令格式为：<strong>docker rm[-f|–force][-l|–link][-v|–volumes]CONTAINER[CONTAINER…]</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm ce554267d7a4</span><br></pre></td></tr></table></figure></p>
<p>默认情况下rm命令只能删除停止或者退出状态的容器，但是可以添加-f参数，将容器kill后强行删除。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm -f ce554267d7a4</span><br></pre></td></tr></table></figure></p>
<p>###相关参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">·- f，--force=false：是否强行终止并删除一个运行中的容器；</span><br><span class="line">·- l，--link=false：删除容器的连接，但保留容器；</span><br><span class="line">·- v，--volumes=false：删除容器挂载的数据卷。</span><br></pre></td></tr></table></figure></p>
<h2 id="5-导入导出容器"><a href="#5-导入导出容器" class="headerlink" title="5.导入导出容器"></a>5.导入导出容器</h2><h3 id="1-导出容器"><a href="#1-导出容器" class="headerlink" title="1.导出容器"></a>1.导出容器</h3><p>命令的格式为 <strong>docker export[-o|– output[=””]]CONTAINER</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker export -o test_for_run.tar ce5</span><br><span class="line"> 或</span><br><span class="line">docker export e81 &gt;test_for_stop.tar</span><br></pre></td></tr></table></figure></p>
<h3 id="2-导入容器"><a href="#2-导入容器" class="headerlink" title="2.导入容器"></a>2.导入容器</h3><p>和导入镜像一样可以使用docker import将tar导入变成镜像，命令格式为：<br><strong>docker import [-c|–change[=[]]] [-m|–message[=MESSAGE]] file|URL|-[REPOSITORY [:TAG]]</strong><br><strong>导入时可以定义标签信息</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker import test_for_run.tar - test/ubuntu:v1.0</span><br></pre></td></tr></table></figure></p>
<p>在使用docker load 导入由docker export保存容器生成的tar时会报异常信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open /var/lib/docker/tmp/docker-import-283259618/repositories: no such file or directory</span><br></pre></td></tr></table></figure></p>
<p><strong>导入容器tar需使用docker import命令</strong></p>
<h2 id="6-容器资源配置"><a href="#6-容器资源配置" class="headerlink" title="6.容器资源配置"></a>6.容器资源配置</h2><p>使用docker stats命令来看当前服务器的内存,针对各个场景对相应容器分配合理内存资源。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stats</span><br></pre></td></tr></table></figure></p>
<p>使用docker的update命令来对内存大小进行管理分配<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update -m 350m  --memory-swap -1  mysqlserver</span><br></pre></td></tr></table></figure></p>
<p><strong>–memory-swap -1</strong> 参数是指不让容器和宿主机进行内存交换<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--automated=true| false：仅显示自动创建的镜像，默认为否；</span><br><span class="line">·--no-trunc=true| false：输出信息不截断显示，默认为否；</span><br><span class="line">·- s，--stars=X：指定仅显示评价为指定星级以上的镜像，默认为0，即输出所有镜像。</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/11/25/csIVayoYXUhRrDp.png" alt="dockerstats.png"></p>
<p>参考资料：Docker技术入门与实战</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/nini.png" alt="李斯大炮">
            
              <p class="site-author-name" itemprop="name">李斯大炮</p>
              <p class="site-description motion-element" itemprop="description">我从不相信什么懒洋洋的自由，我向往的自由是通过勤奋和努力实现更广阔的人生，那样的自由才是珍贵的、有价值的。我相信一万小时定律，我从来不相信天上掉馅饼的灵感和坐等的成就。做一个自由又自律的人，靠势必实现的决心认真地活着。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/cmevolve/" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:lisidapao@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/lisidapao?t=1" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-globe"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.baidu.com" title="基情资词" target="_blank">基情资词</a>
                  </li>
                
              </ul>
            </div>
          
			<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=28138493&auto=1&height=66"></iframe>
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李斯大炮</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    

  




	





  





  











  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
